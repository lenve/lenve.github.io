<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>gRPC 系列完结～PDF 可以下载啦！ - 江南一点雨</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="江南一点雨"><meta name="msapplication-TileImage" content="https://www.javaboy.org/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="江南一点雨"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="[TOC] 1 gRPC 入门这篇文章本来要在年前和小伙伴们见面，但是因为我之前的 Mac 系统版本是 10.13.6，这个版本比较老，时至今天在运行一些新鲜玩意的时候有时候会有一些 BUG（例如运行最新版的 Nacos 等），运行 gRPC 的插件也有 BUG，代码总是生成有问题，但是因为系统升级是一个大事，所以一直等到过年放假，在家才慢慢折腾将 Mac 升级到目前的 13.1 版本，之前这些问"><meta property="og:type" content="blog"><meta property="og:title" content="gRPC 系列完结～PDF 可以下载啦！"><meta property="og:url" content="http://www.javaboy.org/2023/0407/grpc_pdf.html"><meta property="og:site_name" content="江南一点雨"><meta property="og:description" content="[TOC] 1 gRPC 入门这篇文章本来要在年前和小伙伴们见面，但是因为我之前的 Mac 系统版本是 10.13.6，这个版本比较老，时至今天在运行一些新鲜玩意的时候有时候会有一些 BUG（例如运行最新版的 Nacos 等），运行 gRPC 的插件也有 BUG，代码总是生成有问题，但是因为系统升级是一个大事，所以一直等到过年放假，在家才慢慢折腾将 Mac 升级到目前的 13.1 版本，之前这些问"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://p3.ssl.qhimg.com/t01a1f4adda646f3a99.png"><meta property="og:image" content="http://img.itboyhub.com/2022/08/20230204214656.png"><meta property="og:image" content="http://img.itboyhub.com/2022/08/20230204220245.png"><meta property="og:image" content="http://img.itboyhub.com/2022/08/20230206203256.png"><meta property="og:image" content="http://img.itboyhub.com/2022/08/grpc-message-compile-struct-2.png"><meta property="og:image" content="http://img.itboyhub.com/2022/08/20230206203542.png"><meta property="og:image" content="http://img.itboyhub.com/2022/08/20230206203927.png"><meta property="og:image" content="http://img.itboyhub.com/2022/08/20230206204200.png"><meta property="og:image" content="http://img.itboyhub.com/2022/08/grpc-server-interceptor.drawio.png"><meta property="og:image" content="http://img.itboyhub.com/2021/springboot2/37-1.png"><meta property="og:image" content="http://img.itboyhub.com/2021/springboot2/37-2.png"><meta property="og:image" content="http://img.itboyhub.com/2021/springboot2/37-3.png"><meta property="og:image" content="https://i.328888.xyz/2023/04/04/ijoAso.jpeg"><meta property="og:image" content="http://img.itboyhub.com/2022/08/20230314195612.png"><meta property="og:image" content="http://img.itboyhub.com/2022/08/axx-xx-x10-1.png"><meta property="article:published_time" content="2023-04-07T10:58:59.000Z"><meta property="article:modified_time" content="2023-07-21T11:16:32.156Z"><meta property="article:author" content="江南一点雨"><meta property="article:tag" content="gRPC"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://p3.ssl.qhimg.com/t01a1f4adda646f3a99.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.javaboy.org/2023/0407/grpc_pdf.html"},"headline":"gRPC 系列完结～PDF 可以下载啦！","image":["https://p3.ssl.qhimg.com/t01a1f4adda646f3a99.png","http://img.itboyhub.com/2022/08/20230204214656.png","http://img.itboyhub.com/2022/08/20230204220245.png","http://img.itboyhub.com/2022/08/20230206203256.png","http://img.itboyhub.com/2022/08/grpc-message-compile-struct-2.png","http://img.itboyhub.com/2022/08/20230206203542.png","http://img.itboyhub.com/2022/08/20230206203927.png","http://img.itboyhub.com/2022/08/20230206204200.png","http://img.itboyhub.com/2022/08/grpc-server-interceptor.drawio.png","http://img.itboyhub.com/2021/springboot2/37-1.png","http://img.itboyhub.com/2021/springboot2/37-2.png","http://img.itboyhub.com/2021/springboot2/37-3.png","http://img.itboyhub.com/2022/08/20230314195612.png","http://img.itboyhub.com/2022/08/axx-xx-x10-1.png"],"datePublished":"2023-04-07T10:58:59.000Z","dateModified":"2023-07-21T11:16:32.156Z","author":{"@type":"Person","name":"江南一点雨"},"publisher":{"@type":"Organization","name":"江南一点雨","logo":{"@type":"ImageObject","url":"http://img.itboyhub.com/2024/mp/20241218191201.png"}},"description":"[TOC] 1 gRPC 入门这篇文章本来要在年前和小伙伴们见面，但是因为我之前的 Mac 系统版本是 10.13.6，这个版本比较老，时至今天在运行一些新鲜玩意的时候有时候会有一些 BUG（例如运行最新版的 Nacos 等），运行 gRPC 的插件也有 BUG，代码总是生成有问题，但是因为系统升级是一个大事，所以一直等到过年放假，在家才慢慢折腾将 Mac 升级到目前的 13.1 版本，之前这些问"}</script><link rel="canonical" href="http://www.javaboy.org/2023/0407/grpc_pdf.html"><link rel="icon" href="https://www.javaboy.org/favicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="江南一点雨" type="application/atom+xml">
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="http://img.itboyhub.com/2024/mp/20241218191201.png" alt="江南一点雨" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">江南一点雨</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/fronted-backend">前后端分离</a><a class="navbar-item" href="http://docs.javaboy.org/ssm/">SSM</a><a class="navbar-item" href="http://springboot.javaboy.org">Spring Boot</a><a class="navbar-item" href="http://www.javaboy.org/springsecurity">Spring Security</a><a class="navbar-item" href="/redis">Redis</a><a class="navbar-item" href="/mongodb">MongoDB</a><a class="navbar-item" href="/mysql">MySQL</a><a class="navbar-item" href="/docker">Docker</a><a class="navbar-item" href="/git">Git</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-04-07T10:58:59.000Z" title="4/7/2023, 6:58:59 PM">2023-04-07</time>发表</span><span class="level-item"><time dateTime="2023-07-21T11:16:32.156Z" title="7/21/2023, 7:16:32 PM">2023-07-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/gRPC/">gRPC</a></span><span class="level-item">3 小时读完 (大约22655个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">gRPC 系列完结～PDF 可以下载啦！</h1><div class="content"><p>[TOC]</p>
<h1 id="1-gRPC-入门"><a href="#1-gRPC-入门" class="headerlink" title="1 gRPC 入门"></a>1 gRPC 入门</h1><p>这篇文章本来要在年前和小伙伴们见面，但是因为我之前的 Mac 系统版本是 10.13.6，这个版本比较老，时至今天在运行一些新鲜玩意的时候有时候会有一些 BUG（例如运行最新版的 Nacos 等），运行 gRPC 的插件也有 BUG，代码总是生成有问题，但是因为系统升级是一个大事，所以一直等到过年放假，在家才慢慢折腾将 Mac 升级到目前的 13.1 版本，之前这些问题现在都没有了，gRPC 的案例现在也可以顺利跑起来了。</p>
<span id="more"></span>

<p>所以今天就来和小伙伴们简单聊一聊 gRPC。</p>
<h2 id="1-1-缘起"><a href="#1-1-缘起" class="headerlink" title="1.1 缘起"></a>1.1 缘起</h2><p>我为什么想写一篇 gRPC 的文章呢？其实本来我是想和小伙伴们梳理一下在微服务中都有哪些跨进城调用的方式，在梳理的过程中想到了 gRPC，发现还没写文章和小伙伴们聊过 gRPC，因此打算先来几篇文章和小伙伴们详细介绍一下 gRPC，然后再梳理微服务中的跨进程方案。</p>
<h2 id="1-2-什么是-gRPC"><a href="#1-2-什么是-gRPC" class="headerlink" title="1.2 什么是 gRPC"></a>1.2 什么是 gRPC</h2><p>了解 gRPC 之前先来看看什么是 RPC。</p>
<p>RPC 全称是 Remote Procedure Call，中文一般译作远程过程调用。RPC 是一种进程间的通信模式，程序分布在不同的地址空间里。简单来说，就是两个进程之间互相调用的一种方式。</p>
<p>gRPC 则是一个由 Google 发起的开源的 RPC 框架，它是一个高性能远程过程调用 (RPC) 框架，可以在任何环境中运行。gRPC 通过对负载均衡、跟踪、健康检查和身份验证的可插拔支持，有效地连接数据中心内和数据中心之间的服务。</p>
<p>在 gRPC 中，客户端应用程序可以直接调用部署在不同机器上的服务端应用程序中的方法，就好像它是本地对象一样，使用 gRPC 可以更容易地创建分布式应用程序和服务。与许多 RPC 系统一样，gRPC 基于定义服务的思想，指定基于参数和返回类型远程调用的方法。在服务端侧，服务端实现接口，运行 gRPC 服务，处理客户端调用。在客户端侧，客户端拥有存根（Stub，在某些语言中称为客户端），它提供与服务端相同的方法。</p>
<p><img src="https://p3.ssl.qhimg.com/t01a1f4adda646f3a99.png"></p>
<p>gRPC 客户端和服务端可以在各种环境中运行和相互通信 – 从 Google 内部的服务器到你自己的桌面 – 并且可以使用 gRPC 支持的任何语言编写。因此，你可以轻松地用 Java 创建 gRPC 服务端，使用 Go、Python 或 Ruby 创建客户端。此外，最新的 Google API 将包含 gRPC 版本的接口，使你轻松地将 Google 功能构建到你的应用程序中。</p>
<p>gRPC 支持的语言版本：</p>
<p><img src="http://img.itboyhub.com/2022/08/20230204214656.png"></p>
<p>说了这么多，还是得整两个小案例小伙伴们可能才会清晰，所以我们也不废话了，上案例。</p>
<h2 id="1-3-实践"><a href="#1-3-实践" class="headerlink" title="1.3 实践"></a>1.3 实践</h2><p>先来看下我们的项目结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">├── grpc-api</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   ├── src</span><br><span class="line">├── grpc-client</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   ├── src</span><br><span class="line">├── grpc-server</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   ├── src</span><br><span class="line">└── pom.xml</span><br></pre></td></tr></table></figure>

<p>大家看下，这里首先有一个 grpc-api，这个模块用来放我们的公共代码；grpc-server 是我们的服务端，grpc-client 则是我们的客户端，这些都是普通的 maven 项目。</p>
<h3 id="1-3-1-grpc-api"><a href="#1-3-1-grpc-api" class="headerlink" title="1.3.1 grpc-api"></a>1.3.1 grpc-api</h3><p>在 grpc-api 中，我们首先引入项目依赖，如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-netty-shaded<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.52.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-protobuf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.52.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-stub<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.52.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span> <span class="comment">&lt;!-- necessary for Java 9+ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>annotations-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.53<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>除了这些常规的依赖之外，还需要一个插件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">extensions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">extension</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>kr.motd.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>os-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xolstice.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">protocArtifact</span>&gt;</span>com.google.protobuf:protoc:3.21.7:exe:$&#123;os.detected.classifier&#125;<span class="tag">&lt;/<span class="name">protocArtifact</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pluginId</span>&gt;</span>grpc-java<span class="tag">&lt;/<span class="name">pluginId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pluginArtifact</span>&gt;</span>io.grpc:protoc-gen-grpc-java:1.51.0:exe:$&#123;os.detected.classifier&#125;<span class="tag">&lt;/<span class="name">pluginArtifact</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile-custom<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我来说一下这个插件的作用。</p>
<p>默认情况下，gRPC 使用 Protocol Buffers，这是 Google 提供的一个成熟的开源的跨平台的序列化数据结构的协议，我们编写对应的 proto 文件，通过上面这个插件可以将我们编写的 proto 文件自动转为对应的 Java 类。</p>
<blockquote>
<p>多说一句，使用 Protocol Buffers 并不是必须的，也可以使用 JSON 等，但是目前来说这个场景更常用的还是 Portal Buffers。</p>
</blockquote>
<p>接下来我们在 main 目录下新建 proto 文件夹，如下：</p>
<p><img src="http://img.itboyhub.com/2022/08/20230204220245.png"></p>
<p>注意，这个文件夹位置是默认的。如果我们的 proto 文件不是放在 src&#x2F;main&#x2F;proto 位置，那么在配置插件的时候需要指定 proto 文件的位置，咱们本篇文章主要是入门，我这里就使用默认的位置。</p>
<p>在 proto 文件夹中，我们新建一个 product.proto 文件，内容如下：</p>
<figure class="highlight proto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> java_multiple_files = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">option</span> java_package = <span class="string">&quot;org.javaboy.grpc.demo&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">&quot;ProductProto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> product;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">ProductInfo</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> addProduct (Product) <span class="keyword">returns</span> (ProductId)</span>;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> getProduct(ProductId) <span class="keyword">returns</span>(Product)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Product</span> &#123;</span><br><span class="line">  <span class="type">string</span> id = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> name=<span class="number">2</span>;</span><br><span class="line">  <span class="type">string</span> description=<span class="number">3</span>;</span><br><span class="line">  <span class="type">float</span> price=<span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">ProductId</span> &#123;</span><br><span class="line">  <span class="type">string</span> value = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段配置算是一个比较核心的配置了，这里主要说明了负责进程传输的类、方法等到底是个啥样子：</p>
<ol>
<li><code>syntax = &quot;proto3&quot;;</code>：这个是 protocol buffers 的版本。</li>
<li><code>option java_multiple_files = true;</code>：这个字段是可选的，如果设置为 true，表示每一个 message 文件都会有一个单独的 class 文件；否则，message 全部定义在 outerclass 文件里。</li>
<li><code>option java_package = &quot;org.javaboy.grpc.demo&quot;;</code>：这个字段是可选的，用于标识生成的 java 文件的 package。如果没有指定，则使用 proto 里定义的 package，如果package 也没有指定，那就会生成在根目录下。</li>
<li><code>option java_outer_classname = &quot;ProductProto&quot;;</code>：这个字段是可选的，用于指定 proto 文件生成的 java 类的 outerclass 类名。什么是 outerclass？简单来说就是用一个 class 文件来定义所有的 message 对应的 Java 类，这个 class 就是 outerclass；如果没有指定，默认是 proto 文件的驼峰式；</li>
<li><code>package product;</code>：这个属性用来定义 message 的包名。包名的含义与平台语言无关，这个 package 仅仅被用在 proto 文件中用于区分同名的 message 类型。可以理解为 message 全名的前缀，和 message 名称合起来唯一标识一个 message 类型。当我们在 proto 文件中导入其他 proto 文件的 message，需要加上 package 前缀才行。所以包名是用来唯一标识 message 的。</li>
<li><code>service</code>：我们定义的跨平台方法都写在 service 中，上面的案例中我们定义了两个方法：addProduct 表示添加一件商品，参数是一个 Product 对象，返回值则是刚刚添加成功的商品的 ID；getProduct 则表示根据 ID 查询一个商品，参数是一个商品 ID，返回值则是查询到的商品对象。这里的定义相当于一个接口，将来我们要在 Java 代码中实现这个接口。</li>
<li><code>message</code>：这里有点像我们在 Java 中定义类，上文中我们定义了两个类，分别是 Product 和 ProductId 两个类。这两个类在 service 中被使用。</li>
</ol>
<p>message 中定义的有点像我们 Java 中定义的类，但是不能直接使用 Java 中的数据类型，毕竟这是 Protocol buffers，这个是和语言无关的，将来可以据此生成不同语言的代码，这里我们可以使用的类型和我们 Java 类型之间的对应关系如下：</p>
<p><img src="http://img.itboyhub.com/2022/08/20230206203256.png"></p>
<p>另外我们在 message 中定义的属性的时候，都会给一个数字，例如 id&#x3D;1，name&#x3D;2 等，这个数字将来会在二进制消息中标识我们的字段，并且一旦我们的消息类型被使用就不应更改，这个有点像序列化的感觉。</p>
<p>实际上，这个 message 编译后的字节内容大概像下面这样：</p>
<p><img src="http://img.itboyhub.com/2022/08/grpc-message-compile-struct-2.png"></p>
<p>这里的标签中的内容包含两部分，字段索引和字段类型，字段索引其实就是我们上面定义的数字。</p>
<p>定义完成之后，接下来我们就需要使用插件来生成对应的 Java 代码了，插件我们在前面已经引入了，现在只需要执行了，如下图：</p>
<p><img src="http://img.itboyhub.com/2022/08/20230206203542.png"></p>
<p>注意，compile 和 compile-custom 两个指令都需要执行。其中 compile 用来编译消息对象，compile-custom 则依赖消息对象,生成接口服务。</p>
<p>首先我们点击 compile 看看生成的代码，如下：</p>
<p><img src="http://img.itboyhub.com/2022/08/20230206203927.png"></p>
<p>再看 compile-custom 生成的代码，如下：</p>
<p><img src="http://img.itboyhub.com/2022/08/20230206204200.png"></p>
<p>好了，这样我们的准备工作就算完成了。</p>
<blockquote>
<p>有的小伙伴生成的代码文件夹颜色不对劲，此时有两种解决办法：1.选中目标文件夹，右键单击，选择 Mark Directory as-&gt; Generated Sources root；2.选中工程，右键单击，选择 Maven-&gt;Reload project。推荐使用第二种方案。</p>
</blockquote>
<h3 id="1-3-2-grpc-server"><a href="#1-3-2-grpc-server" class="headerlink" title="1.3.2 grpc-server"></a>1.3.2 grpc-server</h3><p>接下来我们创建 grpc-server 项目，并使该项目依赖 grpc-api，然后在 grpc-server 中，提供 ProductInfo 的具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductInfoImpl</span> <span class="keyword">extends</span> <span class="title class_">ProductInfoGrpc</span>.ProductInfoImplBase &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addProduct</span><span class="params">(Product request, StreamObserver&lt;ProductId&gt; responseObserver)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;request.toString() = &quot;</span> + request.toString());</span><br><span class="line">        responseObserver.onNext(ProductId.newBuilder().setValue(request.getId()).build());</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getProduct</span><span class="params">(ProductId request, StreamObserver&lt;Product&gt; responseObserver)</span> &#123;</span><br><span class="line">        responseObserver.onNext(Product.newBuilder().setId(request.getValue()).setName(<span class="string">&quot;三国演义&quot;</span>).build());</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ProductInfoGrpc.ProductInfoImplBase</code> 是根据我们在 proto 文件中定义的 service 自动生成的，我们的 ProductInfoImpl 继承自该类，并且提供了我们给出的方法的具体实现。</p>
<p>以 addProduct 方法为例，参数 request 就是将来客户端调用的时候传来的 Product 对象，返回结果则通过 responseObserver 来完成。我们的方法逻辑很简单，我就把参数传来的 Product 对象打印出来，然后构建一个 ProductId 对象并返回，最后调用 <code>responseObserver.onCompleted();</code> 表示数据返回完毕。</p>
<p>剩下的 getProduct 方法逻辑就很好懂了，我这里就不再赘述了。</p>
<p>最后，我们再把这个 grpc-server 项目启动起来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductInfoServer</span> &#123;</span><br><span class="line">    Server server;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="type">ProductInfoServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProductInfoServer</span>();</span><br><span class="line">        server.start();</span><br><span class="line">        server.blockUntilShutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">50051</span>;</span><br><span class="line">        server = ServerBuilder.forPort(port)</span><br><span class="line">                .addService(<span class="keyword">new</span> <span class="title class_">ProductInfoImpl</span>())</span><br><span class="line">                .build()</span><br><span class="line">                .start();</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            ProductInfoServer.<span class="built_in">this</span>.stop();</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (server != <span class="literal">null</span>) &#123;</span><br><span class="line">            server.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">blockUntilShutdown</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (server != <span class="literal">null</span>) &#123;</span><br><span class="line">            server.awaitTermination();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于我们这里是一个 JavaSE 项目，为了避免项目启动之后就停止，我们这里调用了 <code>server.awaitTermination();</code> 方法，就是让服务启动成功之后不要停止。</p>
<h3 id="1-3-3-grpc-client"><a href="#1-3-3-grpc-client" class="headerlink" title="1.3.3 grpc-client"></a>1.3.3 grpc-client</h3><p>最后再来看看客户端的调用。首先 grpc-client 项目也是需要依赖 grpc-api 的，然后直接进行方法调用，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .build();</span><br><span class="line">        ProductInfoGrpc.<span class="type">ProductInfoBlockingStub</span> <span class="variable">stub</span> <span class="operator">=</span> ProductInfoGrpc.newBlockingStub(channel);</span><br><span class="line">        <span class="type">Product</span> <span class="variable">p</span> <span class="operator">=</span> Product.newBuilder().setId(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">                .setPrice(<span class="number">399.0f</span>)</span><br><span class="line">                .setName(<span class="string">&quot;TienChin项目&quot;</span>)</span><br><span class="line">                .setDescription(<span class="string">&quot;SpringBoot+Vue3实战视频&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">ProductId</span> <span class="variable">productId</span> <span class="operator">=</span> stub.addProduct(p);</span><br><span class="line">        System.out.println(<span class="string">&quot;productId.getValue() = &quot;</span> + productId.getValue());</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> stub.getProduct(ProductId.newBuilder().setValue(<span class="string">&quot;99999&quot;</span>).build());</span><br><span class="line">        System.out.println(<span class="string">&quot;product.toString() = &quot;</span> + product.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小伙伴们看到，这里首先需要和服务端建立连接，给出服务端的地址和端口号即可，usePlaintext() 方法表示不使用 TLS 对连接进行加密（默认情况下会使用 TLS 对连接进行加密），生产环境建议使用加密连接。</p>
<p>剩下的代码就比较好懂了，创建 Product 对象，调用 addProduct 方法进行添加；创建 ProductId 对象，调用 getProduct。Product 对象和 ProductId 对象都是根据我们在 proto 中定义的 message 自动生成的。</p>
<h2 id="1-4-总结"><a href="#1-4-总结" class="headerlink" title="1.4 总结"></a>1.4 总结</h2><p>好啦，一个简单的例子，小伙伴们先对 gRPC 入个门，后面松哥会再整几篇文章跟大家介绍这里边的一些细节。</p>
<h1 id="2-gRPC-的四种通信模式"><a href="#2-gRPC-的四种通信模式" class="headerlink" title="2 gRPC 的四种通信模式"></a>2 gRPC 的四种通信模式</h1><blockquote>
<p>温馨提示：本文需要结合<a href="https://mp.weixin.qq.com/s/OyfU0tLm4f9t3nZxce-Ksw">上一篇 gRPC 文章</a>一起食用，否则可能看不懂。</p>
</blockquote>
<p>前面一篇文章松哥和大家聊了 gRPC 的基本用法，今天我们再来稍微深入一点点，来看下 gRPC 中四种不同的通信模式。</p>
<p>gRPC 中四种不同的通信模式分别是：</p>
<ol>
<li>一元 RPC</li>
<li>服务端流 RPC</li>
<li>客户端流 RPC</li>
<li>双向流 RPC</li>
</ol>
<p>接下来松哥就通过四个完整的案例，来分别和向伙伴们演示这四种不同的通信模式。</p>
<h2 id="2-1-准备工作"><a href="#2-1-准备工作" class="headerlink" title="2.1 准备工作"></a>2.1 准备工作</h2><p>关于 gRPC 的基础知识我们就不啰嗦了，咱们直接来看我今天的 proto 文件，如下：</p>
<p>这次我新建了一个名为 book.proto 的文件，这里主要定义了一些图书相关的方法，如下：</p>
<figure class="highlight proto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> java_multiple_files = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">option</span> java_package = <span class="string">&quot;org.javaboy.grpc.demo&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">&quot;BookServiceProto&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/wrappers.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> book;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">BookService</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> addBook(Book) <span class="keyword">returns</span> (google.protobuf.StringValue)</span>;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> getBook(google.protobuf.StringValue) <span class="keyword">returns</span> (Book)</span>;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> searchBooks(google.protobuf.StringValue) <span class="keyword">returns</span> (stream Book)</span>;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> updateBooks(stream Book) <span class="keyword">returns</span> (google.protobuf.StringValue)</span>;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> processBooks(stream google.protobuf.StringValue) <span class="keyword">returns</span> (stream BookSet)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Book</span> &#123;</span><br><span class="line">  <span class="type">string</span> id = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">repeated</span> <span class="type">string</span> tags = <span class="number">2</span>;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">3</span>;</span><br><span class="line">  <span class="type">float</span> price = <span class="number">4</span>;</span><br><span class="line">  <span class="type">string</span> author = <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">BookSet</span> &#123;</span><br><span class="line">  <span class="type">string</span> id = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">repeated</span> Book bookList = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个文件中，有一些内容我们在<a href="https://mp.weixin.qq.com/s/OyfU0tLm4f9t3nZxce-Ksw">上篇文章</a>中都讲过了，讲过的我就不再重复了，我说一些<a href="https://mp.weixin.qq.com/s/OyfU0tLm4f9t3nZxce-Ksw">上篇文章</a>没有涉及到的东西：</p>
<ol>
<li>由于我们在这个文件中，引用了 Google 提供的 StringValue（<code>google.protobuf.StringValue</code>），所以这个文件上面我们首先用 import 导入相关的文件，导入之后，才可以使用。</li>
<li>在方法参数和返回值中出现的 stream，就表示这个方法的参数或者返回值是流的形式（其实就是数据可以多次传输）。</li>
<li>message 中出现了一个<a href="https://mp.weixin.qq.com/s/OyfU0tLm4f9t3nZxce-Ksw">上篇文章</a>没有的关键字 repeated，这个表示这个字段可以重复，可以简单理解为这就是我们 Java 中的数组。</li>
</ol>
<p>好了，和<a href="https://mp.weixin.qq.com/s/OyfU0tLm4f9t3nZxce-Ksw">上篇文章</a>相比，本文主要就是这几个地方不一样。</p>
<p>proto 文件写好之后，按照<a href="https://mp.weixin.qq.com/s/OyfU0tLm4f9t3nZxce-Ksw">上篇文章</a>介绍的方法进行编译，生成对应的代码，这里就不再重复了。</p>
<h2 id="2-2-一元-RPC"><a href="#2-2-一元-RPC" class="headerlink" title="2.2 一元 RPC"></a>2.2 一元 RPC</h2><p>一元 RPC 是一种比较简单的 RPC 模式，其实说白了我们<a href="https://mp.weixin.qq.com/s/OyfU0tLm4f9t3nZxce-Ksw">上篇文章</a>和大家介绍的就是一种一元 RPC，也就是客户端发起一个请求，服务端给出一个响应，然后请求结束。</p>
<p>上面我们定义的五个方法中，addBook 和 getBook 都算是一种一元 RPC。</p>
<h3 id="2-2-1-addBook"><a href="#2-2-1-addBook" class="headerlink" title="2.2.1 addBook"></a>2.2.1 addBook</h3><p>先来看 addBook 方法，这个方法的逻辑很简单，我们提前在服务端准备一个 Map 用来保存 Book，addBook 调用的时候，就把 book 对象存入到 Map 中，并且将 book 的 ID 返回，大家就这样一件事，来看看服务端的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">BookServiceGrpc</span>.BookServiceImplBase &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Book&gt; bookMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BookServiceImpl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Book</span> <span class="variable">b1</span> <span class="operator">=</span> Book.newBuilder().setId(<span class="string">&quot;1&quot;</span>).setName(<span class="string">&quot;三国演义&quot;</span>).setAuthor(<span class="string">&quot;罗贯中&quot;</span>).setPrice(<span class="number">30</span>).addTags(<span class="string">&quot;明清小说&quot;</span>).addTags(<span class="string">&quot;通俗小说&quot;</span>).build();</span><br><span class="line">        <span class="type">Book</span> <span class="variable">b2</span> <span class="operator">=</span> Book.newBuilder().setId(<span class="string">&quot;2&quot;</span>).setName(<span class="string">&quot;西游记&quot;</span>).setAuthor(<span class="string">&quot;吴承恩&quot;</span>).setPrice(<span class="number">40</span>).addTags(<span class="string">&quot;志怪小说&quot;</span>).addTags(<span class="string">&quot;通俗小说&quot;</span>).build();</span><br><span class="line">        <span class="type">Book</span> <span class="variable">b3</span> <span class="operator">=</span> Book.newBuilder().setId(<span class="string">&quot;3&quot;</span>).setName(<span class="string">&quot;水浒传&quot;</span>).setAuthor(<span class="string">&quot;施耐庵&quot;</span>).setPrice(<span class="number">50</span>).addTags(<span class="string">&quot;明清小说&quot;</span>).addTags(<span class="string">&quot;通俗小说&quot;</span>).build();</span><br><span class="line">        bookMap.put(<span class="string">&quot;1&quot;</span>, b1);</span><br><span class="line">        bookMap.put(<span class="string">&quot;2&quot;</span>, b2);</span><br><span class="line">        bookMap.put(<span class="string">&quot;3&quot;</span>, b3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBook</span><span class="params">(Book request, StreamObserver&lt;StringValue&gt; responseObserver)</span> &#123;</span><br><span class="line">        bookMap.put(request.getId(), request);</span><br><span class="line">        responseObserver.onNext(StringValue.newBuilder().setValue(request.getId()).build());</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看过<a href="https://mp.weixin.qq.com/s/OyfU0tLm4f9t3nZxce-Ksw">上篇文章</a>的小伙伴，我觉得这段代码应该很好理解。</p>
<p>客户端调用方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .build();</span><br><span class="line">        BookServiceGrpc.<span class="type">BookServiceStub</span> <span class="variable">stub</span> <span class="operator">=</span> BookServiceGrpc.newStub(channel);</span><br><span class="line">        addBook(stub);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addBook</span><span class="params">(BookServiceGrpc.BookServiceStub stub)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        stub.addBook(Book.newBuilder().setPrice(<span class="number">99</span>).setId(<span class="string">&quot;100&quot;</span>).setName(<span class="string">&quot;java&quot;</span>).setAuthor(<span class="string">&quot;javaboy&quot;</span>).build(), <span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;StringValue&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(StringValue stringValue)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;stringValue.getValue() = &quot;</span> + stringValue.getValue());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">                System.out.println(<span class="string">&quot;添加完毕&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我使用了 CountDownLatch 来实现线程等待，等服务端给出响应之后，客户端再结束。这里在回调的 onNext 方法中，我们就可以拿到服务端的返回值。</p>
<h3 id="2-2-2-getBook"><a href="#2-2-2-getBook" class="headerlink" title="2.2.2 getBook"></a>2.2.2 getBook</h3><p>getBook 跟上面的 addBook 类似，先来看服务端代码，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">BookServiceGrpc</span>.BookServiceImplBase &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Book&gt; bookMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BookServiceImpl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Book</span> <span class="variable">b1</span> <span class="operator">=</span> Book.newBuilder().setId(<span class="string">&quot;1&quot;</span>).setName(<span class="string">&quot;三国演义&quot;</span>).setAuthor(<span class="string">&quot;罗贯中&quot;</span>).setPrice(<span class="number">30</span>).addTags(<span class="string">&quot;明清小说&quot;</span>).addTags(<span class="string">&quot;通俗小说&quot;</span>).build();</span><br><span class="line">        <span class="type">Book</span> <span class="variable">b2</span> <span class="operator">=</span> Book.newBuilder().setId(<span class="string">&quot;2&quot;</span>).setName(<span class="string">&quot;西游记&quot;</span>).setAuthor(<span class="string">&quot;吴承恩&quot;</span>).setPrice(<span class="number">40</span>).addTags(<span class="string">&quot;志怪小说&quot;</span>).addTags(<span class="string">&quot;通俗小说&quot;</span>).build();</span><br><span class="line">        <span class="type">Book</span> <span class="variable">b3</span> <span class="operator">=</span> Book.newBuilder().setId(<span class="string">&quot;3&quot;</span>).setName(<span class="string">&quot;水浒传&quot;</span>).setAuthor(<span class="string">&quot;施耐庵&quot;</span>).setPrice(<span class="number">50</span>).addTags(<span class="string">&quot;明清小说&quot;</span>).addTags(<span class="string">&quot;通俗小说&quot;</span>).build();</span><br><span class="line">        bookMap.put(<span class="string">&quot;1&quot;</span>, b1);</span><br><span class="line">        bookMap.put(<span class="string">&quot;2&quot;</span>, b2);</span><br><span class="line">        bookMap.put(<span class="string">&quot;3&quot;</span>, b3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getBook</span><span class="params">(StringValue request, StreamObserver&lt;Book&gt; responseObserver)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> request.getValue();</span><br><span class="line">        <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> bookMap.get(id);</span><br><span class="line">        <span class="keyword">if</span> (book != <span class="literal">null</span>) &#123;</span><br><span class="line">            responseObserver.onNext(book);</span><br><span class="line">            responseObserver.onCompleted();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            responseObserver.onCompleted();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个 getBook 就是根据客户端传来的 id，从 Map 中查询到一个 Book 并返回。</p>
<p>客户端调用代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .build();</span><br><span class="line">        BookServiceGrpc.<span class="type">BookServiceStub</span> <span class="variable">stub</span> <span class="operator">=</span> BookServiceGrpc.newStub(channel);</span><br><span class="line">        getBook(stub);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getBook</span><span class="params">(BookServiceGrpc.BookServiceStub stub)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        stub.getBook(StringValue.newBuilder().setValue(<span class="string">&quot;2&quot;</span>).build(), <span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;Book&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(Book book)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;book = &quot;</span> + book);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">                System.out.println(<span class="string">&quot;查询完毕&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小伙伴们大概也能看出来，addBook 和 getBook 基本上操作套路是一模一样的。</p>
<h2 id="2-3-服务端流-RPC"><a href="#2-3-服务端流-RPC" class="headerlink" title="2.3 服务端流 RPC"></a>2.3 服务端流 RPC</h2><p>前面的一元 RPC，客户端发起一个请求，服务端给出一个响应，请求就结束了。服务端流则是客户端发起一个请求，服务端给一个响应序列，这个响应序列组成一个流。</p>
<p>上面我们给出的 searchBook 就是这样一个例子，searchBook 是传递图书的 tags 参数，然后在服务端查询哪些书的 tags 满足条件，将满足条件的书全部都返回去。</p>
<p>我们来看下服务端的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">BookServiceGrpc</span>.BookServiceImplBase &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Book&gt; bookMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BookServiceImpl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Book</span> <span class="variable">b1</span> <span class="operator">=</span> Book.newBuilder().setId(<span class="string">&quot;1&quot;</span>).setName(<span class="string">&quot;三国演义&quot;</span>).setAuthor(<span class="string">&quot;罗贯中&quot;</span>).setPrice(<span class="number">30</span>).addTags(<span class="string">&quot;明清小说&quot;</span>).addTags(<span class="string">&quot;通俗小说&quot;</span>).build();</span><br><span class="line">        <span class="type">Book</span> <span class="variable">b2</span> <span class="operator">=</span> Book.newBuilder().setId(<span class="string">&quot;2&quot;</span>).setName(<span class="string">&quot;西游记&quot;</span>).setAuthor(<span class="string">&quot;吴承恩&quot;</span>).setPrice(<span class="number">40</span>).addTags(<span class="string">&quot;志怪小说&quot;</span>).addTags(<span class="string">&quot;通俗小说&quot;</span>).build();</span><br><span class="line">        <span class="type">Book</span> <span class="variable">b3</span> <span class="operator">=</span> Book.newBuilder().setId(<span class="string">&quot;3&quot;</span>).setName(<span class="string">&quot;水浒传&quot;</span>).setAuthor(<span class="string">&quot;施耐庵&quot;</span>).setPrice(<span class="number">50</span>).addTags(<span class="string">&quot;明清小说&quot;</span>).addTags(<span class="string">&quot;通俗小说&quot;</span>).build();</span><br><span class="line">        bookMap.put(<span class="string">&quot;1&quot;</span>, b1);</span><br><span class="line">        bookMap.put(<span class="string">&quot;2&quot;</span>, b2);</span><br><span class="line">        bookMap.put(<span class="string">&quot;3&quot;</span>, b3);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">searchBooks</span><span class="params">(StringValue request, StreamObserver&lt;Book&gt; responseObserver)</span> &#123;</span><br><span class="line">        Set&lt;String&gt; keySet = bookMap.keySet();</span><br><span class="line">        <span class="type">String</span> <span class="variable">tags</span> <span class="operator">=</span> request.getValue();</span><br><span class="line">        <span class="keyword">for</span> (String key : keySet) &#123;</span><br><span class="line">            <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> bookMap.get(key);</span><br><span class="line">            <span class="type">int</span> <span class="variable">tagsCount</span> <span class="operator">=</span> book.getTagsCount();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; tagsCount; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">t</span> <span class="operator">=</span> book.getTags(i);</span><br><span class="line">                <span class="keyword">if</span> (t.equals(tags)) &#123;</span><br><span class="line">                    responseObserver.onNext(book);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小伙伴们看下，这段 Java 代码应该很好理解：</p>
<ol>
<li>首先从 request 中提取客户端传来的 tags 参数。</li>
<li>遍历 bookMap，查看每一本书的 tags 是否等于客户端传来的 tags，如果相等，说明添加匹配，则通过 <code>responseObserver.onNext(book);</code> 将这本书写回到客户端。</li>
<li>等所有操作都完成后，执行 <code>responseObserver.onCompleted();</code>，表示服务端的响应序列结束了，这样客户端也就知道请求结束了。</li>
</ol>
<p>我们来看看客户端的代码，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .build();</span><br><span class="line">        BookServiceGrpc.<span class="type">BookServiceStub</span> <span class="variable">stub</span> <span class="operator">=</span> BookServiceGrpc.newStub(channel);</span><br><span class="line">        searchBook(stub);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">searchBook</span><span class="params">(BookServiceGrpc.BookServiceStub stub)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        stub.searchBooks(StringValue.newBuilder().setValue(<span class="string">&quot;明清小说&quot;</span>).build(), <span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;Book&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(Book book)</span> &#123;</span><br><span class="line">                System.out.println(book);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">                System.out.println(<span class="string">&quot;查询完毕！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端的代码好理解，搜索的关键字是 <code>明清小说</code>，每当服务端返回一次数据的时候，客户端回调的 onNext 方法就会被触发一次，当服务端之行了 <code>responseObserver.onCompleted();</code> 之后，客户端的 onCompleted 方法也会被触发。</p>
<p>这个就是服务端流，客户端发起一个请求，服务端通过 onNext 可以多次写回数据。</p>
<h2 id="2-4-客户端流-RPC"><a href="#2-4-客户端流-RPC" class="headerlink" title="2.4 客户端流 RPC"></a>2.4 客户端流 RPC</h2><p>客户端流则是客户端发起多个请求，服务端只给出一个响应。</p>
<p>上面的 updateBooks 就是一个客户端流的案例，客户端想要修改图书，可以发起多个请求修改多本书，服务端则收集多次修改的结果，将之汇总然后一次性返回给客户端。</p>
<p>我们先来看看服务端的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">BookServiceGrpc</span>.BookServiceImplBase &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Book&gt; bookMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BookServiceImpl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Book</span> <span class="variable">b1</span> <span class="operator">=</span> Book.newBuilder().setId(<span class="string">&quot;1&quot;</span>).setName(<span class="string">&quot;三国演义&quot;</span>).setAuthor(<span class="string">&quot;罗贯中&quot;</span>).setPrice(<span class="number">30</span>).addTags(<span class="string">&quot;明清小说&quot;</span>).addTags(<span class="string">&quot;通俗小说&quot;</span>).build();</span><br><span class="line">        <span class="type">Book</span> <span class="variable">b2</span> <span class="operator">=</span> Book.newBuilder().setId(<span class="string">&quot;2&quot;</span>).setName(<span class="string">&quot;西游记&quot;</span>).setAuthor(<span class="string">&quot;吴承恩&quot;</span>).setPrice(<span class="number">40</span>).addTags(<span class="string">&quot;志怪小说&quot;</span>).addTags(<span class="string">&quot;通俗小说&quot;</span>).build();</span><br><span class="line">        <span class="type">Book</span> <span class="variable">b3</span> <span class="operator">=</span> Book.newBuilder().setId(<span class="string">&quot;3&quot;</span>).setName(<span class="string">&quot;水浒传&quot;</span>).setAuthor(<span class="string">&quot;施耐庵&quot;</span>).setPrice(<span class="number">50</span>).addTags(<span class="string">&quot;明清小说&quot;</span>).addTags(<span class="string">&quot;通俗小说&quot;</span>).build();</span><br><span class="line">        bookMap.put(<span class="string">&quot;1&quot;</span>, b1);</span><br><span class="line">        bookMap.put(<span class="string">&quot;2&quot;</span>, b2);</span><br><span class="line">        bookMap.put(<span class="string">&quot;3&quot;</span>, b3);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StreamObserver&lt;Book&gt; <span class="title function_">updateBooks</span><span class="params">(StreamObserver&lt;StringValue&gt; responseObserver)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;更新的图书 ID 为：&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;Book&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(Book book)</span> &#123;</span><br><span class="line">                bookMap.put(book.getId(), book);</span><br><span class="line">                sb.append(book.getId())</span><br><span class="line">                        .append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                responseObserver.onNext(StringValue.newBuilder().setValue(sb.toString()).build());</span><br><span class="line">                responseObserver.onCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端每发送一本书来，就会触发服务端的 onNext 方法，然后我们在这方法中进行图书的更新操作，并记录更新结果。最后，我们在 onCompleted 方法中，将更新结果汇总返回给客户端，基本上就是这样一个流程。</p>
<p>我们再来看看客户端的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .build();</span><br><span class="line">        BookServiceGrpc.<span class="type">BookServiceStub</span> <span class="variable">stub</span> <span class="operator">=</span> BookServiceGrpc.newStub(channel);</span><br><span class="line">        updateBook(stub);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">updateBook</span><span class="params">(BookServiceGrpc.BookServiceStub stub)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        StreamObserver&lt;Book&gt; request = stub.updateBooks(<span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;StringValue&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(StringValue stringValue)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;stringValue.getValue() = &quot;</span> + stringValue.getValue());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;更新完毕&quot;</span>);</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        request.onNext(Book.newBuilder().setId(<span class="string">&quot;1&quot;</span>).setName(<span class="string">&quot;a&quot;</span>).setAuthor(<span class="string">&quot;b&quot;</span>).build());</span><br><span class="line">        request.onNext(Book.newBuilder().setId(<span class="string">&quot;2&quot;</span>).setName(<span class="string">&quot;c&quot;</span>).setAuthor(<span class="string">&quot;d&quot;</span>).build());</span><br><span class="line">        request.onCompleted();</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在客户端这块，updateBooks 方法会返回一个 StreamObserver<Book> 对象，调用该对象的 onNext 方法就是给服务端传递数据了，可以传递多个数据，调用该对象的 onCompleted 方法就是告诉服务端数据传递结束了，此时也会触发服务端的 onCompleted 方法，服务端的 onCompleted 方法执行之后，进而触发了客户端的 onCompleted 方法。</p>
<h2 id="2-5-双向流-RPC"><a href="#2-5-双向流-RPC" class="headerlink" title="2.5 双向流 RPC"></a>2.5 双向流 RPC</h2><p>双向流其实就是 3、4 小节的合体。即客户端多次发送数据，服务端也多次响应数据。</p>
<p>我们先来看下服务端的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">BookServiceGrpc</span>.BookServiceImplBase &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Book&gt; bookMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> List&lt;Book&gt; books = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BookServiceImpl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Book</span> <span class="variable">b1</span> <span class="operator">=</span> Book.newBuilder().setId(<span class="string">&quot;1&quot;</span>).setName(<span class="string">&quot;三国演义&quot;</span>).setAuthor(<span class="string">&quot;罗贯中&quot;</span>).setPrice(<span class="number">30</span>).addTags(<span class="string">&quot;明清小说&quot;</span>).addTags(<span class="string">&quot;通俗小说&quot;</span>).build();</span><br><span class="line">        <span class="type">Book</span> <span class="variable">b2</span> <span class="operator">=</span> Book.newBuilder().setId(<span class="string">&quot;2&quot;</span>).setName(<span class="string">&quot;西游记&quot;</span>).setAuthor(<span class="string">&quot;吴承恩&quot;</span>).setPrice(<span class="number">40</span>).addTags(<span class="string">&quot;志怪小说&quot;</span>).addTags(<span class="string">&quot;通俗小说&quot;</span>).build();</span><br><span class="line">        <span class="type">Book</span> <span class="variable">b3</span> <span class="operator">=</span> Book.newBuilder().setId(<span class="string">&quot;3&quot;</span>).setName(<span class="string">&quot;水浒传&quot;</span>).setAuthor(<span class="string">&quot;施耐庵&quot;</span>).setPrice(<span class="number">50</span>).addTags(<span class="string">&quot;明清小说&quot;</span>).addTags(<span class="string">&quot;通俗小说&quot;</span>).build();</span><br><span class="line">        bookMap.put(<span class="string">&quot;1&quot;</span>, b1);</span><br><span class="line">        bookMap.put(<span class="string">&quot;2&quot;</span>, b2);</span><br><span class="line">        bookMap.put(<span class="string">&quot;3&quot;</span>, b3);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StreamObserver&lt;StringValue&gt; <span class="title function_">processBooks</span><span class="params">(StreamObserver&lt;BookSet&gt; responseObserver)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;StringValue&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(StringValue stringValue)</span> &#123;</span><br><span class="line">                <span class="type">Book</span> <span class="variable">b</span> <span class="operator">=</span> Book.newBuilder().setId(stringValue.getValue()).build();</span><br><span class="line">                books.add(b);</span><br><span class="line">                <span class="keyword">if</span> (books.size() == <span class="number">3</span>) &#123;</span><br><span class="line">                    <span class="type">BookSet</span> <span class="variable">bookSet</span> <span class="operator">=</span> BookSet.newBuilder().addAllBookList(books).build();</span><br><span class="line">                    responseObserver.onNext(bookSet);</span><br><span class="line">                    books.clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">BookSet</span> <span class="variable">bookSet</span> <span class="operator">=</span> BookSet.newBuilder().addAllBookList(books).build();</span><br><span class="line">                responseObserver.onNext(bookSet);</span><br><span class="line">                books.clear();</span><br><span class="line">                responseObserver.onCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码没有实际意义，单纯为了给小伙伴们演示双向流，我的操作逻辑是客户端传递多个 ID 到服务端，然后服务端根据这些 ID 构建对应的 Book 对象，然后三个三个一组，再返回给客户端。客户端每次发送一个请求，都会触发服务端的 onNext 方法，我们在这个方法中对请求分组返回。最后如果还有剩余的请求，我们在 onCompleted() 方法中返回。</p>
<p>再来看看客户端的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .build();</span><br><span class="line">        BookServiceGrpc.<span class="type">BookServiceStub</span> <span class="variable">stub</span> <span class="operator">=</span> BookServiceGrpc.newStub(channel);</span><br><span class="line">        processBook(stub);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">processBook</span><span class="params">(BookServiceGrpc.BookServiceStub stub)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        StreamObserver&lt;StringValue&gt; request = stub.processBooks(<span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;BookSet&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(BookSet bookSet)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;bookSet = &quot;</span> + bookSet);</span><br><span class="line">                System.out.println(<span class="string">&quot;=============&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;处理完毕！&quot;</span>);</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        request.onNext(StringValue.newBuilder().setValue(<span class="string">&quot;a&quot;</span>).build());</span><br><span class="line">        request.onNext(StringValue.newBuilder().setValue(<span class="string">&quot;b&quot;</span>).build());</span><br><span class="line">        request.onNext(StringValue.newBuilder().setValue(<span class="string">&quot;c&quot;</span>).build());</span><br><span class="line">        request.onNext(StringValue.newBuilder().setValue(<span class="string">&quot;d&quot;</span>).build());</span><br><span class="line">        request.onCompleted();</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个客户端的代码跟第四小节一模一样，不再赘述了。</p>
<p>好啦，这就是松哥和小伙伴们介绍的 gRPC 的四种不同的通信模式，文章中只给出了一些关键代码，如果小伙伴们没看明白，建议结合<a href="https://mp.weixin.qq.com/s/OyfU0tLm4f9t3nZxce-Ksw">上篇文章</a>一起阅读就懂啦～</p>
<h1 id="3-gRPC-中的拦截器"><a href="#3-gRPC-中的拦截器" class="headerlink" title="3 gRPC 中的拦截器"></a>3 gRPC 中的拦截器</h1><p>今天我们继续 gRPC 系列。</p>
<p>前面松哥跟大家聊了 gRPC 的简单案例，也说了四种不同的通信模式，感兴趣的小伙伴可以戳这里：</p>
<ol>
<li><a href="https://mp.weixin.qq.com/s/OyfU0tLm4f9t3nZxce-Ksw">一个简单的案例入门 gRPC</a></li>
<li><a href="https://mp.weixin.qq.com/s/c-_D2RpLksIlYJDfaWOSkA">聊一聊 gRPC 的四种通信模式</a></li>
</ol>
<p>今天我们来继续聊一聊 gRPC 中的拦截器。</p>
<p>有请求的发送、处理，当然就会有拦截器的需求，例如在服务端通过拦截器统一进行请求认证等操作，这些就需要拦截器来完成，今天松哥先和小伙伴们来聊一聊 gRPC 中拦截器的基本用法，后面我再整一篇文章和小伙伴们做一个基于拦截器实现的 JWT 认证的 gRPC。</p>
<p>gRPC 中的拦截器整体上来说可以分为两大类：</p>
<ol>
<li>服务端拦截器</li>
<li>客户端拦截器</li>
</ol>
<p>我们分别来看。</p>
<h2 id="3-1-服务端拦截器"><a href="#3-1-服务端拦截器" class="headerlink" title="3.1 服务端拦截器"></a>3.1 服务端拦截器</h2><p>服务端拦截器的作用有点像我们 Java 中的 Filter，服务端拦截器又可以继续细分为<strong>一元拦截器</strong>和<strong>流拦截器</strong>。</p>
<p>一元拦截器对应我们上篇文章中所讲的一元 RPC，也就是一次请求，一次响应这种情况。</p>
<p>流拦截器则对应我们上篇文章中所讲的服务端流 RPC、客户端流 RPC 以及双向流 RPC。</p>
<p>不过，在 Java 代码中，无论是一元拦截器还是流拦截器，代码其实都是一样的。不过如果你是用 Go 实现的 gRPC，那么这块是不一样的。</p>
<p>所以接下来的内容我就不去区分一元拦截器和流拦截器了，我们直接来看一个服务端拦截器的例子。</p>
<p>这里我就不从头开始写了，我们直接在上篇文章的基础之上继续添加拦截器即可。</p>
<p>服务端拦截器工作位置大致如下：</p>
<p><img src="http://img.itboyhub.com/2022/08/grpc-server-interceptor.drawio.png"></p>
<p>从这张图中小伙伴们可以看到，我们可以在服务端处理请求之前将请求拦截下来，统一进行权限校验等操作，也可以在服务端将请求处理完毕之后，准备响应的时候将响应拦截下来，可以对响应进行二次处理。</p>
<p>首先我们来看请求拦截器，实际上是一个监听器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceCallListener</span>&lt;R&gt; <span class="keyword">extends</span> <span class="title class_">ForwardingServerCallListener</span>&lt;R&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerCall.Listener&lt;R&gt; delegate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BookServiceCallListener</span><span class="params">(ServerCall.Listener&lt;R&gt; delegate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.delegate = delegate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ServerCall.Listener&lt;R&gt; <span class="title function_">delegate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> delegate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(R message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;这是客户端发来的消息，可以在这里进行预处理：&quot;</span>+message);</span><br><span class="line">        <span class="built_in">super</span>.onMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们自定义一个类，继承自 ForwardingServerCallListener 类，在这里重写 onMessage 方法，当有请求到达的时候，就会经过这里的 onMessage 方法。如果我们需要对传入的参数进行验证等操作，就可以在这里完成。</p>
<p>再来看看响应拦截器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceCall</span>&lt;ReqT,RespT&gt; <span class="keyword">extends</span> <span class="title class_">ForwardingServerCall</span>.SimpleForwardingServerCall&lt;ReqT,RespT&gt; &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">BookServiceCall</span><span class="params">(ServerCall&lt;ReqT, RespT&gt; delegate)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(delegate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ServerCall&lt;ReqT, RespT&gt; <span class="title function_">delegate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.delegate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MethodDescriptor&lt;ReqT, RespT&gt; <span class="title function_">getMethodDescriptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.getMethodDescriptor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(RespT message)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;这是服务端返回给客户端的消息：&quot;</span>+message);</span><br><span class="line">        <span class="built_in">super</span>.sendMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小伙伴们可能发现了，我这里用到了很多泛型，请求类型和响应类型都不建议指定具体类型，因为拦截器可能会拦截多种类型的请求，请求参数和响应的数据类型都不一定一样。</p>
<p>这里是重写 sendMessage 方法，在这个方法中我们可以对服务端准备返回给客户端的消息进行预处理。</p>
<p>所以这个位置就相当于<strong>响应拦截器</strong>。</p>
<p>最后，我们需要在启动服务的时候，将这两个拦截器配置进去，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">50051</span>;</span><br><span class="line">    server = ServerBuilder.forPort(port)</span><br><span class="line">            .addService(ServerInterceptors.intercept(<span class="keyword">new</span> <span class="title class_">BookServiceImpl</span>(), <span class="keyword">new</span> <span class="title class_">ServerInterceptor</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> &lt;ReqT, RespT&gt; ServerCall.Listener&lt;ReqT&gt; <span class="title function_">interceptCall</span><span class="params">(ServerCall&lt;ReqT, RespT&gt; call, Metadata headers, ServerCallHandler&lt;ReqT, RespT&gt; next)</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">fullMethodName</span> <span class="operator">=</span> call.getMethodDescriptor().getFullMethodName();</span><br><span class="line">                    System.out.println(fullMethodName + <span class="string">&quot;:pre&quot;</span>);</span><br><span class="line">                    Set&lt;String&gt; keys = headers.keys();</span><br><span class="line">                    <span class="keyword">for</span> (String key : keys) &#123;</span><br><span class="line">                        System.out.println(key + <span class="string">&quot;&gt;&gt;&gt;&quot;</span> + headers.get(Metadata.Key.of(key, ASCII_STRING_MARSHALLER)));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BookServiceCallListener</span>&lt;&gt;(next.startCall(<span class="keyword">new</span> <span class="title class_">BookServiceCall</span>(call), headers));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;))</span><br><span class="line">            .build()</span><br><span class="line">            .start();</span><br><span class="line">    Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        BookServiceServer.<span class="built_in">this</span>.stop();</span><br><span class="line">    &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是我之前服务启动的方法，以前我们调用 addService 方法的时候，直接添加对应的服务就可以了，现在，我们除了添加之前的 BookServiceImpl 服务之外，还额外给了一个拦截器。</p>
<p>每当请求到达的时候，就会经过拦截器的 interceptCall 方法，这个方法有三个参数：</p>
<ul>
<li>第一个参数 call 是消费传入的 RPC 消息的一个回调。</li>
<li>第二个参数 headers 则是请求的消息头，如果我们通过 JWT 进行请求校验，那么就从这个 headers 中提取出请求的 JWT 令牌然后进行校验。</li>
<li>第三个参数 next 就类似于我们在 Java 过滤器 filter 中的 filterChain 一样，让这个请求继续向下走。</li>
</ul>
<p>在这个方法中，我们请求头的信息都打印出来给小伙伴们参考了。然后在返回值中，将我们刚刚写的请求拦截器和响应拦截器构建并返回。</p>
<p>好啦，这样我们的服务端拦截器就搞好啦～无论是一元的 RPC 消息还是流式的 RPC 消息，都会经过这个拦截器，响应也是一样。</p>
<h2 id="3-2-客户端拦截器"><a href="#3-2-客户端拦截器" class="headerlink" title="3.2 客户端拦截器"></a>3.2 客户端拦截器</h2><p>客户端拦截器就比较简单了，客户端拦截器可以将我们的请求拦截下来，例如我们如果想为所有请求添加统一的令牌 Token，那么就可以在这里来做，方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">        .usePlaintext()</span><br><span class="line">        .intercept(<span class="keyword">new</span> <span class="title class_">ClientInterceptor</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> &lt;ReqT, RespT&gt; ClientCall&lt;ReqT, RespT&gt; <span class="title function_">interceptCall</span><span class="params">(MethodDescriptor&lt;ReqT, RespT&gt; method, CallOptions callOptions, Channel next)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;!!!!!!!!!!!!!!!!&quot;</span>);</span><br><span class="line">                callOptions = callOptions.withAuthority(<span class="string">&quot;javaboy&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> next.newCall(method,callOptions);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .build();</span><br><span class="line">BookServiceGrpc.<span class="type">BookServiceStub</span> <span class="variable">stub</span> <span class="operator">=</span> BookServiceGrpc.newStub(channel);</span><br></pre></td></tr></table></figure>

<p>当我们的请求执行的时候，这个客户端拦截器就会被触发。</p>
<h2 id="3-3-小结"><a href="#3-3-小结" class="headerlink" title="3.3 小结"></a>3.3 小结</h2><p>好啦，今天就和小伙伴们简单介绍一下服务端拦截器和客户端拦截器。下篇文章，松哥会通过一个 JWT 认证来和小伙伴们演示这个拦截器的具体用法。</p>
<h1 id="4-gRPC-JWT"><a href="#4-gRPC-JWT" class="headerlink" title="4 gRPC + JWT"></a>4 gRPC + JWT</h1><p>上篇文章松哥和小伙伴们聊了在 gRPC 中如何使用拦截器，这些拦截器有服务端拦截器也有客户端拦截器，这些拦截器的一个重要使用场景，就是可以进行身份的校验。当客户端发起请求的时候，服务端通过拦截器进行身份校验，就知道这个请求是谁发起的了。今天松哥就来通过一个具体的案例，来和小伙伴们演示一下 gRPC 如何结合 JWT 进行身份校验。</p>
<h2 id="4-1-JWT-介绍"><a href="#4-1-JWT-介绍" class="headerlink" title="4.1 JWT 介绍"></a>4.1 JWT 介绍</h2><h3 id="4-1-1-无状态登录"><a href="#4-1-1-无状态登录" class="headerlink" title="4.1.1 无状态登录"></a>4.1.1 无状态登录</h3><h4 id="4-1-1-1-什么是有状态"><a href="#4-1-1-1-什么是有状态" class="headerlink" title="4.1.1.1 什么是有状态"></a>4.1.1.1 什么是有状态</h4><p>有状态服务，即服务端需要记录每次会话的客户端信息，从而识别客户端身份，根据用户身份进行请求的处理，典型的设计如 Tomcat 中的 Session。例如登录：用户登录后，我们把用户的信息保存在服务端 session 中，并且给用户一个 cookie 值，记录对应的 session，然后下次请求，用户携带 cookie 值来（这一步有浏览器自动完成），我们就能识别到对应 session，从而找到用户的信息。这种方式目前来看最方便，但是也有一些缺陷，如下：</p>
<ul>
<li>服务端保存大量数据，增加服务端压力</li>
<li>服务端保存用户状态，不支持集群化部署</li>
</ul>
<h4 id="4-1-1-2-什么是无状态"><a href="#4-1-1-2-什么是无状态" class="headerlink" title="4.1.1.2 什么是无状态"></a>4.1.1.2 什么是无状态</h4><p>微服务集群中的每个服务，对外提供的都使用 RESTful 风格的接口。而 RESTful 风格的一个最重要的规范就是：服务的无状态性，即：</p>
<ul>
<li>服务端不保存任何客户端请求者信息</li>
<li>客户端的每次请求必须具备自描述信息，通过这些信息识别客户端身份</li>
</ul>
<p>那么这种无状态性有哪些好处呢？</p>
<ul>
<li>客户端请求不依赖服务端的信息，多次请求不需要必须访问到同一台服务器</li>
<li>服务端的集群和状态对客户端透明</li>
<li>服务端可以任意的迁移和伸缩（可以方便的进行集群化部署）</li>
<li>减小服务端存储压力</li>
</ul>
<h3 id="4-1-2-如何实现无状态"><a href="#4-1-2-如何实现无状态" class="headerlink" title="4.1.2 如何实现无状态"></a>4.1.2 如何实现无状态</h3><p>无状态登录的流程：</p>
<ul>
<li>首先客户端发送账户名&#x2F;密码到服务端进行认证</li>
<li>认证通过后，服务端将用户信息加密并且编码成一个 token，返回给客户端</li>
<li>以后客户端每次发送请求，都需要携带认证的 token</li>
<li>服务端对客户端发送来的 token 进行解密，判断是否有效，并且获取用户登录信息</li>
</ul>
<h3 id="4-1-3-JWT"><a href="#4-1-3-JWT" class="headerlink" title="4.1.3 JWT"></a>4.1.3 JWT</h3><h4 id="4-1-3-1-简介"><a href="#4-1-3-1-简介" class="headerlink" title="4.1.3.1 简介"></a>4.1.3.1 简介</h4><p>JWT，全称是 Json Web Token， 是一种 JSON 风格的轻量级的授权和身份认证规范，可实现无状态、分布式的 Web 应用授权：</p>
<p><img src="http://img.itboyhub.com/2021/springboot2/37-1.png"></p>
<p>JWT 作为一种规范，并没有和某一种语言绑定在一起，常用的 Java 实现是 GitHub 上的开源项目 jjwt，地址如下：<code>https://github.com/jwtk/jjwt</code></p>
<h4 id="4-1-3-2-JWT数据格式"><a href="#4-1-3-2-JWT数据格式" class="headerlink" title="4.1.3.2 JWT数据格式"></a>4.1.3.2 JWT数据格式</h4><p>JWT 包含三部分数据：</p>
<ul>
<li><p>Header：头部，通常头部有两部分信息：</p>
<ul>
<li>声明类型，这里是JWT</li>
<li>加密算法，自定义</li>
</ul>
</li>
</ul>
<p>我们会对头部进行 Base64Url 编码（可解码），得到第一部分数据。</p>
<ul>
<li><p>Payload：载荷，就是有效数据，在官方文档中(RFC7519)，这里给了7个示例信息：</p>
<ul>
<li>iss (issuer)：表示签发人</li>
<li>exp (expiration time)：表示token过期时间</li>
<li>sub (subject)：主题</li>
<li>aud (audience)：受众</li>
<li>nbf (Not Before)：生效时间</li>
<li>iat (Issued At)：签发时间</li>
<li>jti (JWT ID)：编号</li>
</ul>
</li>
</ul>
<p>这部分也会采用 Base64Url 编码，得到第二部分数据。</p>
<ul>
<li>Signature：签名，是整个数据的认证信息。一般根据前两步的数据，再加上服务的的密钥secret（密钥保存在服务端，不能泄露给客户端），通过 Header 中配置的加密算法生成。用于验证整个数据完整和可靠性。</li>
</ul>
<p>生成的数据格式如下图：</p>
<p><img src="http://img.itboyhub.com/2021/springboot2/37-2.png"></p>
<p>注意，这里的数据通过 <code>.</code> 隔开成了三部分，分别对应前面提到的三部分，另外，这里数据是不换行的，图片换行只是为了展示方便而已。</p>
<h4 id="4-1-3-3-JWT-交互流程"><a href="#4-1-3-3-JWT-交互流程" class="headerlink" title="4.1.3.3 JWT 交互流程"></a>4.1.3.3 JWT 交互流程</h4><p>流程图：</p>
<p> <img src="http://img.itboyhub.com/2021/springboot2/37-3.png"></p>
<p>步骤翻译：</p>
<ol>
<li>应用程序或客户端向授权服务器请求授权</li>
<li>获取到授权后，授权服务器会向应用程序返回访问令牌</li>
<li>应用程序使用访问令牌来访问受保护资源（如 API）</li>
</ol>
<p>因为 JWT 签发的 token 中已经包含了用户的身份信息，并且每次请求都会携带，这样服务的就无需保存用户信息，甚至无需去数据库查询，这样就完全符合了 RESTful 的无状态规范。</p>
<h4 id="4-1-3-4-JWT-存在的问题"><a href="#4-1-3-4-JWT-存在的问题" class="headerlink" title="4.1.3.4 JWT 存在的问题"></a>4.1.3.4 JWT 存在的问题</h4><p>说了这么多，JWT 也不是天衣无缝，由客户端维护登录状态带来的一些问题在这里依然存在，举例如下：</p>
<ol>
<li>续签问题，这是被很多人诟病的问题之一，传统的 cookie+session 的方案天然的支持续签，但是 jwt 由于服务端不保存用户状态，因此很难完美解决续签问题，如果引入 redis，虽然可以解决问题，但是 jwt 也变得不伦不类了。</li>
<li>注销问题，由于服务端不再保存用户信息，所以一般可以通过修改 secret 来实现注销，服务端 secret 修改后，已经颁发的未过期的 token 就会认证失败，进而实现注销，不过毕竟没有传统的注销方便。</li>
<li>密码重置，密码重置后，原本的 token 依然可以访问系统，这时候也需要强制修改 secret。</li>
<li>基于第 2 点和第 3 点，一般建议不同用户取不同 secret。</li>
</ol>
<blockquote>
<p>当然，为了解决 JWT 存在的问题，也可以将 JWT 结合 Redis 来用，服务端生成的 JWT 字符串存入到 Redis 中并设置过期时间，每次校验的时候，先看 Redis 中是否存在该 JWT 字符串，如果存在就进行后续的校验。但是这种方式有点不伦不类（又成了有状态了）。</p>
</blockquote>
<h2 id="4-2-实践"><a href="#4-2-实践" class="headerlink" title="4.2 实践"></a>4.2 实践</h2><p>我们来看下 gRPC 如何结合 JWT。</p>
<h3 id="4-2-1-项目创建"><a href="#4-2-1-项目创建" class="headerlink" title="4.2.1 项目创建"></a>4.2.1 项目创建</h3><p>首先我先给大家看下我的项目结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">├── grpc_api</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   └── src</span><br><span class="line">├── grpc_client</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   └── src</span><br><span class="line">├── grpc_server</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   └── src</span><br><span class="line">└── pom.xml</span><br></pre></td></tr></table></figure>

<p>还是跟之前文章中的一样，三个模块，grpc_api 用来存放一些公共的代码。</p>
<p>grpc_server 用来放服务端的代码，我这里服务端主要提供了两个接口：</p>
<ol>
<li>登录接口，登录成功之后返回 JWT 字符串。</li>
<li>hello 接口，客户端拿着 JWT 字符串来访问 hello 接口。</li>
</ol>
<p>grpc_client 则是我的客户端代码。</p>
<h3 id="4-2-2-grpc-api"><a href="#4-2-2-grpc-api" class="headerlink" title="4.2.2 grpc_api"></a>4.2.2 grpc_api</h3><p>我将 protocol buffers 和一些依赖都放在 grpc_api 模块中，因为将来我的 grpc_server 和 grpc_client 都将依赖 grpc_api。</p>
<p>我们来看下这里需要的依赖和插件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-jackson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-netty-shaded<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.52.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-protobuf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.52.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-stub<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.52.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>annotations-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.53<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">extensions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">extension</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>kr.motd.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>os-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xolstice.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">protocArtifact</span>&gt;</span>com.google.protobuf:protoc:3.21.7:exe:$&#123;os.detected.classifier&#125;<span class="tag">&lt;/<span class="name">protocArtifact</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pluginId</span>&gt;</span>grpc-java<span class="tag">&lt;/<span class="name">pluginId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pluginArtifact</span>&gt;</span>io.grpc:protoc-gen-grpc-java:1.51.0:exe:$&#123;os.detected.classifier&#125;<span class="tag">&lt;/<span class="name">pluginArtifact</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile-custom<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里的依赖和插件松哥在本系列的第一篇文章中都已经介绍过了，唯一不同的是，这里引入了 JWT 插件，JWT 我使用了比较流行的 JJWT 这个工具。JJWT 松哥在之前的文章和视频中也都有介绍过，这里就不再啰嗦了。</p>
<p>先来看看我的 Protocol Buffers 文件：</p>
<figure class="highlight proto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> java_multiple_files = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">option</span> java_package = <span class="string">&quot;org.javaboy.grpc.api&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">&quot;LoginProto&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/wrappers.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> login;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">LoginService</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> login (LoginBody) <span class="keyword">returns</span> (LoginResponse)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">HelloService</span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> sayHello(google.protobuf.StringValue) <span class="keyword">returns</span> (google.protobuf.StringValue)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">LoginBody</span> &#123;</span><br><span class="line">  <span class="type">string</span> username = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> password = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">LoginResponse</span> &#123;</span><br><span class="line">  <span class="type">string</span> token = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过前面几篇文章的介绍，这里我就不多说啦，就是定义了两个服务：</p>
<ul>
<li>LoginService：这个登录服务，传入用户名密码，返回登录成功之后的令牌。</li>
<li>HelloService：这个就是一个打招呼的服务，传入字符串，返回也是字符串。</li>
</ul>
<p>定义完成之后，生成对应的代码即可。</p>
<p>接下来再定义一个常量类供 grpc_server 和 grcp_client 使用，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthConstant</span> &#123;</span><br><span class="line">    <span class="type">SecretKey</span> <span class="variable">JWT_KEY</span> <span class="operator">=</span> Keys.hmacShaKeyFor(<span class="string">&quot;hello_javaboy_hello_javaboy_hello_javaboy_hello_javaboy_&quot;</span>.getBytes());</span><br><span class="line">    Context.Key&lt;String&gt; AUTH_CLIENT_ID = Context.key(<span class="string">&quot;clientId&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">AUTH_HEADER</span> <span class="operator">=</span> <span class="string">&quot;Authorization&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">AUTH_TOKEN_TYPE</span> <span class="operator">=</span> <span class="string">&quot;Bearer&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的每个常量我都给大家解释下：</p>
<ol>
<li>JWT_KEY：这个是生成 JWT 字符串以及进行 JWT 字符串校验的密钥。</li>
<li>AUTH_CLIENT_ID：这个是客户端的 ID，即客户端发送来的请求携带了 JWT 字符串，通过 JWT 字符串确认了用户身份，就存在这个变量中。</li>
<li>AUTH_HEADER：这个是携带 JWT 字符串的请求头的 KEY。</li>
<li>AUTH_TOKEN_TYPE：这个是携带 JWT 字符串的请求头的参数前缀，通过这个可以确认参数的类型，常见取值有 Bearer 和 Basic。</li>
</ol>
<p>如此，我们的 gRPC_api 就定义好了。</p>
<h3 id="4-2-3-grpc-server"><a href="#4-2-3-grpc-server" class="headerlink" title="4.2.3 grpc_server"></a>4.2.3 grpc_server</h3><p>接下来我们来定义 gRPC_server。</p>
<p>首先来定义登录服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">LoginServiceGrpc</span>.LoginServiceImplBase &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(LoginBody request, StreamObserver&lt;LoginResponse&gt; responseObserver)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> request.getUsername();</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> request.getPassword();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;javaboy&quot;</span>.equals(username) &amp;&amp; <span class="string">&quot;123&quot;</span>.equals(password)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;login success&quot;</span>);</span><br><span class="line">            <span class="comment">//登录成功</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">jwtToken</span> <span class="operator">=</span> Jwts.builder().setSubject(username).signWith(AuthConstant.JWT_KEY).compact();</span><br><span class="line">            responseObserver.onNext(LoginResponse.newBuilder().setToken(jwtToken).build());</span><br><span class="line">            responseObserver.onCompleted();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;login error&quot;</span>);</span><br><span class="line">            <span class="comment">//登录失败</span></span><br><span class="line">            responseObserver.onNext(LoginResponse.newBuilder().setToken(<span class="string">&quot;login error&quot;</span>).build());</span><br><span class="line">            responseObserver.onCompleted();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>省事起见，我这里没有连接数据库，用户名和密码固定为 javaboy 和 123。</p>
<p>登录成功之后，就生成一个 JWT 字符串返回。</p>
<p>登录失败，就返回一个 login error 字符串。</p>
<p>再来看我们的 HelloService 服务，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">HelloServiceGrpc</span>.HelloServiceImplBase &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">(StringValue request, StreamObserver&lt;StringValue&gt; responseObserver)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> AuthConstant.AUTH_CLIENT_ID.get();</span><br><span class="line">        responseObserver.onNext(StringValue.newBuilder().setValue(clientId + <span class="string">&quot; say hello:&quot;</span> + request.getValue()).build());</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个服务就更简单了，不啰嗦。唯一值得说的是 <code>AuthConstant.AUTH_CLIENT_ID.get();</code> 表示获取当前访问用户的 ID，这个用户 ID 是在拦截器中存入进来的。</p>
<p>最后，我们来看服务端比较重要的拦截器，我们要在拦截器中从请求头中获取到 JWT 令牌并解析，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ServerInterceptor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">JwtParser</span> <span class="variable">parser</span> <span class="operator">=</span> Jwts.parser().setSigningKey(AuthConstant.JWT_KEY);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;ReqT, RespT&gt; ServerCall.Listener&lt;ReqT&gt; <span class="title function_">interceptCall</span><span class="params">(ServerCall&lt;ReqT, RespT&gt; serverCall, Metadata metadata, ServerCallHandler&lt;ReqT, RespT&gt; serverCallHandler)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">authorization</span> <span class="operator">=</span> metadata.get(Metadata.Key.of(AuthConstant.AUTH_HEADER, Metadata.ASCII_STRING_MARSHALLER));</span><br><span class="line">        <span class="type">Status</span> <span class="variable">status</span> <span class="operator">=</span> Status.OK;</span><br><span class="line">        <span class="keyword">if</span> (authorization == <span class="literal">null</span>) &#123;</span><br><span class="line">            status = Status.UNAUTHENTICATED.withDescription(<span class="string">&quot;miss authentication token&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!authorization.startsWith(AuthConstant.AUTH_TOKEN_TYPE)) &#123;</span><br><span class="line">            status = Status.UNAUTHENTICATED.withDescription(<span class="string">&quot;unknown token type&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Jws&lt;Claims&gt; claims = <span class="literal">null</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> authorization.substring(AuthConstant.AUTH_TOKEN_TYPE.length()).trim();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                claims = parser.parseClaimsJws(token);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JwtException e) &#123;</span><br><span class="line">                status = Status.UNAUTHENTICATED.withDescription(e.getMessage()).withCause(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (claims != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> Context.current()</span><br><span class="line">                        .withValue(AuthConstant.AUTH_CLIENT_ID, claims.getBody().getSubject());</span><br><span class="line">                <span class="keyword">return</span> Contexts.interceptCall(ctx, serverCall, metadata, serverCallHandler);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        serverCall.close(status, <span class="keyword">new</span> <span class="title class_">Metadata</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerCall</span>.Listener&lt;ReqT&gt;() &#123;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码逻辑应该好理解：</p>
<ol>
<li>首先从 Metadata 中提取出当前请求所携带的 JWT 字符串（相当于从请求头中提取出来）。</li>
<li>如果第一步提取到的值为 null 或者这个值不是以指定字符 Bearer 开始的，说明这个令牌是一个非法令牌，设置对应的响应 status 即可。</li>
<li>如果令牌都没有问题的话，接下来就进行令牌的校验，校验失败，则设置相应的 status 即可。</li>
<li>校验成功的话，我们就会获取到一个 Jws<Claims> 对象，从这个对象中我们可以提取出来用户名，并存入到 Context 中，将来我们在 HelloServiceImpl 中就可以获取到这里的用户名了。</li>
<li>最后，登录成功的话，<code>Contexts.interceptCall</code> 方法构建监听器并返回；登录失败，则构建一个空的监听器返回。</li>
</ol>
<p>最后，我们再来看看启动服务端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginServer</span> &#123;</span><br><span class="line">    Server server;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="type">LoginServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginServer</span>();</span><br><span class="line">        server.start();</span><br><span class="line">        server.blockUntilShutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">50051</span>;</span><br><span class="line">        server = ServerBuilder.forPort(port)</span><br><span class="line">                .addService(<span class="keyword">new</span> <span class="title class_">LoginServiceImpl</span>())</span><br><span class="line">                .addService(ServerInterceptors.intercept(<span class="keyword">new</span> <span class="title class_">HelloServiceImpl</span>(), <span class="keyword">new</span> <span class="title class_">AuthInterceptor</span>()))</span><br><span class="line">                .build()</span><br><span class="line">                .start();</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            LoginServer.<span class="built_in">this</span>.stop();</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (server != <span class="literal">null</span>) &#123;</span><br><span class="line">            server.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">blockUntilShutdown</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (server != <span class="literal">null</span>) &#123;</span><br><span class="line">            server.awaitTermination();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个跟之前的相比就多加了一个 Service，添加 HelloServiceImpl 服务的时候，多加了一个拦截器，换言之，登录的时候，请求是不会被这个认证拦截器拦截的。</p>
<p>好啦，这样我们的 grpc_server 就开发完成了。</p>
<h3 id="4-2-4-grpc-client"><a href="#4-2-4-grpc-client" class="headerlink" title="4.2.4 grpc_client"></a>4.2.4 grpc_client</h3><p>接下来我们来看 grpc_client。</p>
<p>先来看登录：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .build();</span><br><span class="line">        LoginServiceGrpc.<span class="type">LoginServiceStub</span> <span class="variable">stub</span> <span class="operator">=</span> LoginServiceGrpc.newStub(channel);</span><br><span class="line">        login(stub);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(LoginServiceGrpc.LoginServiceStub stub)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        stub.login(LoginBody.newBuilder().setUsername(<span class="string">&quot;javaboy&quot;</span>).setPassword(<span class="string">&quot;123&quot;</span>).build(), <span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;LoginResponse&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(LoginResponse loginResponse)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;loginResponse.getToken() = &quot;</span> + loginResponse.getToken());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法直接调用就行了，看过前面几篇 gRPC 文章的话，这里都很好理解。</p>
<p>再来看 hello 接口的调用，这个接口调用需要携带 JWT 字符串，而携带 JWT 字符串，则需要我们构建一个 CallCredentials 对象，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtCredential</span> <span class="keyword">extends</span> <span class="title class_">CallCredentials</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String subject;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JwtCredential</span><span class="params">(String subject)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subject = subject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">applyRequestMetadata</span><span class="params">(RequestInfo requestInfo, Executor executor, MetadataApplier metadataApplier)</span> &#123;</span><br><span class="line">        executor.execute(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Metadata</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Metadata</span>();</span><br><span class="line">                headers.put(Metadata.Key.of(AuthConstant.AUTH_HEADER, Metadata.ASCII_STRING_MARSHALLER),</span><br><span class="line">                        String.format(<span class="string">&quot;%s %s&quot;</span>, AuthConstant.AUTH_TOKEN_TYPE, subject));</span><br><span class="line">                metadataApplier.apply(headers);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                metadataApplier.fail(Status.UNAUTHENTICATED.withCause(e));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">thisUsesUnstableApi</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就是将请求的 JWT 令牌放入到请求头中即可。</p>
<p>最后来看看调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .build();</span><br><span class="line">        LoginServiceGrpc.<span class="type">LoginServiceStub</span> <span class="variable">stub</span> <span class="operator">=</span> LoginServiceGrpc.newStub(channel);</span><br><span class="line">        sayHello(channel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">(ManagedChannel channel)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        HelloServiceGrpc.<span class="type">HelloServiceStub</span> <span class="variable">helloServiceStub</span> <span class="operator">=</span> HelloServiceGrpc.newStub(channel);</span><br><span class="line">        helloServiceStub</span><br><span class="line">                .withCallCredentials(<span class="keyword">new</span> <span class="title class_">JwtCredential</span>(<span class="string">&quot;eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiJqYXZhYm95In0.IMMp7oh1dl_trUn7sn8qiv9GtO-COQyCGDz_Yy8VI4fIqUcRfwQddP45IoxNovxL&quot;</span>))</span><br><span class="line">                .sayHello(StringValue.newBuilder().setValue(<span class="string">&quot;wangwu&quot;</span>).build(), <span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;StringValue&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(StringValue stringValue)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;stringValue.getValue() = &quot;</span> + stringValue.getValue());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;throwable.getMessage() = &quot;</span> + throwable.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的登录令牌就是前面调用 login 方法时获取到的令牌。</p>
<p>好啦，大功告成。</p>
<h2 id="4-3-小结"><a href="#4-3-小结" class="headerlink" title="4.3 小结"></a>4.3 小结</h2><p>上面的登录与校验只是松哥给小伙伴们展示的一个具体案例而已，在此案例基础之上，我们还可以扩展出来更多写法，但是万变不离其宗，其他玩法就需要小伙伴们自行探索啦～</p>
<h1 id="5-gRPC-请求截止时间"><a href="#5-gRPC-请求截止时间" class="headerlink" title="5 gRPC 请求截止时间"></a>5 gRPC 请求截止时间</h1><p>在 HTTP 请求中，我们发送请求的时候，可以设置一个请求超时时间-connectTimeout，即在指定的时间内，如果请求没有到达服务端，为了避免客户端一直进行不必要的等待，就会抛出一个请求超时异常。</p>
<p>但是在微服务系统中，我们却很少设置请求超时时间，一般都是用另外一个概念代替，那就是请求截止时间。</p>
<p>这是什么原因呢？今天我们就来简单聊一聊这个话题。</p>
<p>在微服务中我们客户端的请求在服务端往往会有比较复杂的链条，我想起来 Spring Cloud Sleuth 官方给的一个请求链路追踪的图，我们直接拿来看下：</p>
<p><img src="https://i.328888.xyz/2023/04/04/ijoAso.jpeg"></p>
<p>这张图中，请求从客户端发起之后，在服务端一共经历了四个 SERVICE，对于这样的请求，如果我们还是按照之前发送普通 HTTP 请求的方式，设置一个 connectTimeout 显然是不够的。</p>
<p>我举个例子：</p>
<p>假设我们发送一个请求，为该请求设置 connectTimeout 为 5s，那么这个时间只对第一个服务 SERVICE1 有效，也就是请求在 5s 之内没有到达 SERVICE1，那么就会抛出连接超时异常；请求如果在 5s 之内到达 SERVICE1，那么就不会抛出异常，但是！！！，请求到达 SERVICE1 并不意味着请求结束，后面从 SERVICE1 到 SERVICE2，从 SERVICE2 到 SERVICE3，从 SERVICE3 到 SERVICE4，还有四个 HTTP 请求待处理，这些请求超时了怎么办？很明显，connectTimeout 属性对于后面几个请求就鞭长莫及了。</p>
<p>所以，对于这种场景，我们一般使用截止时间来处理。</p>
<p>截止时间相当于设置<strong>整个请求生命周期</strong>的时间，也就是这个请求，我要多久拿到结果。很明显，这个时间应该在客户端发起请求的时候设置。</p>
<p>gRPC 中提供了对应的方法，我们可以非常方便的设置请求的截止时间 DeadLineTime，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .build();</span><br><span class="line">        LoginServiceGrpc.<span class="type">LoginServiceStub</span> <span class="variable">stub</span> <span class="operator">=</span> LoginServiceGrpc.newStub(channel).withDeadline(Deadline.after(<span class="number">3</span>, TimeUnit.SECONDS));</span><br><span class="line">        login(stub);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(LoginServiceGrpc.LoginServiceStub stub)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        stub.login(LoginBody.newBuilder().setUsername(<span class="string">&quot;javaboy&quot;</span>).setPassword(<span class="string">&quot;123&quot;</span>).build(), <span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;LoginResponse&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(LoginResponse loginResponse)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;loginResponse.getToken() = &quot;</span> + loginResponse.getToken());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;throwable = &quot;</span> + throwable);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端通过 Thread.sleep 做个简单的休眠就行了，超时之后，客户端的 onError 方法会被触发，抛出如下异常：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">throwable = io.grpc.StatusRuntimeException: DEADLINE_EXCEEDED: deadline exceeded after 2.939621462s. [closed=[], open=[[buffered_nanos=285550823, remote_addr=localhost/127.0.0.1:50051]]]</span><br></pre></td></tr></table></figure>

<p>好啦，一个简单的小细节，感兴趣的小伙伴不妨去试试啦～</p>
<h1 id="6-gRPC-异常处理"><a href="#6-gRPC-异常处理" class="headerlink" title="6 gRPC 异常处理"></a>6 gRPC 异常处理</h1><p>今天来和小伙伴们聊一聊该如何处理 gRPC 中遇到的异常。</p>
<p>在之前的几篇文章中，其实我们也遇到过异常问题，只是当时没有和小伙伴们细说，只是囫囵吞枣写了一个案例而已，今天我们就来把这个话题跟小伙伴们仔细捋一捋。</p>
<p>我们之前写过一个登录的案例，在之前的案例中，如果用户在登录时输入了错误的用户名密码的话，那么我们是通过一个普通的数据流返回异常信息，其实，对于异常信息，我们可以通过专门的异常通道来写回到客户端。</p>
<h2 id="6-1-服务端处理异常"><a href="#6-1-服务端处理异常" class="headerlink" title="6.1 服务端处理异常"></a>6.1 服务端处理异常</h2><p>先来看看服务端如何处理异常。</p>
<p>还是以我们之前的 gRPC 登录案例为例，我们修改服务端的登录逻辑如下（完整代码小伙伴们可以参考之前的 <a href="https://mp.weixin.qq.com/s/jIZrP-H3DmS9pvRD5QaTfA">手把手教大家在 gRPC 中使用 JWT 完成身份校验</a> 一文）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">LoginServiceGrpc</span>.LoginServiceImplBase &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(LoginBody request, StreamObserver&lt;LoginResponse&gt; responseObserver)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> request.getUsername();</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> request.getPassword();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;javaboy&quot;</span>.equals(username) &amp;&amp; <span class="string">&quot;123&quot;</span>.equals(password)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;login success&quot;</span>);</span><br><span class="line">            <span class="comment">//登录成功</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">jwtToken</span> <span class="operator">=</span> Jwts.builder().setSubject(username).signWith(AuthConstant.JWT_KEY).compact();</span><br><span class="line">            responseObserver.onNext(LoginResponse.newBuilder().setToken(jwtToken).build());</span><br><span class="line">            responseObserver.onCompleted();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;login error&quot;</span>);</span><br><span class="line">            <span class="comment">//登录失败</span></span><br><span class="line">            responseObserver.onError(Status.UNAUTHENTICATED.withDescription(<span class="string">&quot;login error&quot;</span>).asException());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小伙伴们看到，在登录失败时我们通过 <code>responseObserver.onError</code> 方法将异常信息写回到客户端。这个方法的参数是一个 Throwable 对象，对于这个对象，在 Status 这个枚举类中定义了一些常见的值，分别如下：</p>
<ul>
<li>OK(0)：请求成功。</li>
<li>CANCELLED(1)：操作被取消。</li>
<li>UNKNOWN(2)：未知错误。</li>
<li>INVALID_ARGUMENT(3)：客户端给了无效的请求参数。</li>
<li>DEADLINE_EXCEEDED(4)：请求超过了截止时间。</li>
<li>NOT_FOUND(5)：请求资源未找到。</li>
<li>ALREADY_EXISTS(6)：添加的内容已经存在。</li>
<li>PERMISSION_DENIED(7)：请求权限不足。</li>
<li>RESOURCE_EXHAUSTED(8)：资源耗尽。</li>
<li>FAILED_PRECONDITION(9)：服务端上为准备好。</li>
<li>ABORTED(10)：请求被中止。</li>
<li>OUT_OF_RANGE(11)：请求超出范围。</li>
<li>UNIMPLEMENTED(12)：未实现的操作。</li>
<li>INTERNAL(13)：服务内部错误。</li>
<li>UNAVAILABLE(14)：服务不可用。</li>
<li>DATA_LOSS(15)：数据丢失或者损毁。</li>
<li>UNAUTHENTICATED(16)：请求未认证。</li>
</ul>
<p>系统默认给出的请求类型大致上就这些。当然，如果这些并不能满足你的需求，我们也可以扩展这个枚举类。</p>
<h2 id="6-2-客户端处理异常"><a href="#6-2-客户端处理异常" class="headerlink" title="6.2 客户端处理异常"></a>6.2 客户端处理异常</h2><p>当服务端给出异常信息之后，客户端的处理分为两种情况。</p>
<h3 id="6-2-1-异步请求"><a href="#6-2-1-异步请求" class="headerlink" title="6.2.1 异步请求"></a>6.2.1 异步请求</h3><p>如果客户端是异步请求，则直接在异常回调中处理即可，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .build();</span><br><span class="line">        LoginServiceGrpc.<span class="type">LoginServiceStub</span> <span class="variable">stub</span> <span class="operator">=</span> LoginServiceGrpc.newStub(channel).withDeadline(Deadline.after(<span class="number">3</span>, TimeUnit.SECONDS));</span><br><span class="line">        login(stub);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(LoginServiceGrpc.LoginServiceStub stub)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        stub.login(LoginBody.newBuilder().setUsername(<span class="string">&quot;javaboy&quot;</span>).setPassword(<span class="string">&quot;1234&quot;</span>).build(), <span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;LoginResponse&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(LoginResponse loginResponse)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;loginResponse.getToken() = &quot;</span> + loginResponse.getToken());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;throwable = &quot;</span> + throwable);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小伙伴们看到，直接在 onError 回到中处理异常即可。</p>
<h3 id="6-2-2-同步请求"><a href="#6-2-2-同步请求" class="headerlink" title="6.2.2 同步请求"></a>6.2.2 同步请求</h3><p>如果客户端请求是同步阻塞请求，那么就要通过异常捕获的方式获取服务端返回的异常信息了，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginClient2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .build();</span><br><span class="line">        LoginServiceGrpc.<span class="type">LoginServiceBlockingStub</span> <span class="variable">stub</span> <span class="operator">=</span> LoginServiceGrpc.newBlockingStub(channel).withDeadline(Deadline.after(<span class="number">3</span>, TimeUnit.SECONDS));</span><br><span class="line">        login(stub);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(LoginServiceGrpc.LoginServiceBlockingStub stub)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">LoginResponse</span> <span class="variable">resp</span> <span class="operator">=</span> stub.login(LoginBody.newBuilder().setUsername(<span class="string">&quot;javaboy&quot;</span>).setPassword(<span class="string">&quot;1234&quot;</span>).build());</span><br><span class="line">            System.out.println(<span class="string">&quot;resp.getToken() = &quot;</span> + resp.getToken());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;e.getMessage() = &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同步阻塞请求就通过异常捕获去获取服务端返回的异常信息即可。</p>
<h2 id="6-3-题外话"><a href="#6-3-题外话" class="headerlink" title="6.3 题外话"></a>6.3 题外话</h2><p>最后，再来和小伙伴们说一个提高 gRPC 数据传输效率的小技巧，那就是传输的数据可以使用 gzip 进行压缩。</p>
<p>具体处理方式就是在客户端调用 <code>withCompression</code> 方法指定数据压缩，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginClient2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">&quot;localhost&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .build();</span><br><span class="line">        LoginServiceGrpc.<span class="type">LoginServiceBlockingStub</span> <span class="variable">stub</span> <span class="operator">=</span> LoginServiceGrpc.newBlockingStub(channel).withDeadline(Deadline.after(<span class="number">3</span>, TimeUnit.SECONDS));</span><br><span class="line">        login(stub);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(LoginServiceGrpc.LoginServiceBlockingStub stub)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">LoginResponse</span> <span class="variable">resp</span> <span class="operator">=</span> stub.withCompression(<span class="string">&quot;gzip&quot;</span>).login(LoginBody.newBuilder().setUsername(<span class="string">&quot;javaboy&quot;</span>).setPassword(<span class="string">&quot;123&quot;</span>).build());</span><br><span class="line">            System.out.println(<span class="string">&quot;resp.getToken() = &quot;</span> + resp.getToken());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;e.getMessage() = &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好啦，一个关于 gRPC 的小小知识点～</p>
<h1 id="7-TLS、CA-证书"><a href="#7-TLS、CA-证书" class="headerlink" title="7 TLS、CA 证书"></a>7 TLS、CA 证书</h1><p>松哥最近在和小伙伴们连载 gRPC，如何确保 gRPC 通信的安全性？这就涉及到 TSL 了，但是考虑到可能有小伙伴对加密连接这一整套方案比较陌生，因此我们今天先用一篇文章跟大家捋清楚这些概念，概念搞明白了，再来看 TSL+gRPC 就很容易了。</p>
<h2 id="7-1-HTTP-的问题"><a href="#7-1-HTTP-的问题" class="headerlink" title="7.1 HTTP 的问题"></a>7.1 HTTP 的问题</h2><p>HTTP 协议是超文本传输协议（Hyper Text Transfer Protocol）的缩写，它是从 WEB 服务器传输超文本标记语言 HTML 到本地浏览器的传送协议。HTTP 设计之初是为了提供一种发布和接收 HTML 页面的方法，时至今日，它的作用已经不仅仅于此了。</p>
<p>对于我们 Java 工程师而言，HTTP 应该算是再熟悉不过的东西了，目前 HTTP 有多个版本，使用较多的是 HTTP&#x2F;1.1 版本。</p>
<p>然而 HTTP 协议有一个缺陷那就是它是通过明文传输数据的，用户通过 HTTP 协议传输的内容很容易被恶意拦截，并且黑客可以伪装成服务端，向用户传送错误的信息，并且能轻易获取用户的隐私信息，而这些操作用户是完全无感知的。</p>
<p>由于存在这样的安全隐患，现在小伙伴们见到的大部分网站都在逐步转为 HTTPS，HTTP 网站会越来越少了。</p>
<h2 id="7-2-HTTPS"><a href="#7-2-HTTPS" class="headerlink" title="7.2 HTTPS"></a>7.2 HTTPS</h2><p>HTTPS（HyperText Transfer Protocol Secure）中文译作超文本传输安全协议，这是一种通过计算机网络进行安全通讯的传输协议。</p>
<p>HTTPS 本质上还是由 HTTP 进行通信，只是在 HTTP 协议和 TCP 层之间增加了一个 SSL 的安全传输协议。整个传输的加密过程都在新的安全层 SSL&#x2F;TLS 中实现，而原来的 HTTP 层的传输流程保持不变，这样就很好地兼容了旧的 HTTP 协议，也沿袭了 TCP&#x2F;IP 协议族的分层思想。</p>
<p>通过 HTTPS，客户端可以确认服务端的身份，保证数据在传输过程中不被篡改，当我们在自己的浏览器上与某一个网站建立 HTTPS 连接的时候，满足如下情况可以表示这个服务端可以被信任：</p>
<ol>
<li>首先我们的操作系统中安装了正确且受信任的证书。我们在 cmd 命令行中执行 <code>certmgr.msc</code> 命令，可以查看操作系统已经安装的证书列表。</li>
</ol>
<p><img src="http://img.itboyhub.com/2022/08/20230314195612.png"></p>
<ol start="2">
<li>浏览器本身正确实现了 HTTPS。</li>
<li>被访问的网站提供了一个证书，这个证书是由一个操作系统所信任的证书颁发机构签发的，操作系统所信任的证书颁发机构一般都预装在操作系统中，通过第一步的方式可以查看。</li>
<li>被访问的网站所提供的证书被成功认证。</li>
</ol>
<p>这里边涉及到一些证书和协议的概念，接下来松哥和大家把整个过程捋一捋。</p>
<h2 id="7-3-TLS-SSL"><a href="#7-3-TLS-SSL" class="headerlink" title="7.3 TLS&#x2F;SSL"></a>7.3 TLS&#x2F;SSL</h2><p>前面我们提到，HTTPS 就是在 HTTP 的基础之上增加了 TLS&#x2F;SSL，那么这两个东西该如何理解呢？</p>
<p>SSL&#x2F;TLS 是一种密码通信方案，算是目前使用最广泛的密码通信方案了。SSL 全称是 Secure Socket Layer，中文译作安全套接层，是 1994 年由 Netscape 公司设计的一套协议，并与 1995 年发布了 3.0 版本；TLS 全称是 Transport Layer Security，中文译作传输层安全，则是 IETF 在 SSL3.0 基础上设计的协议，实际上相当于 SSL 的后续版本，目前 TLS 先后迭代了 <code>TLS 1.0</code>、<code>TLS 1.1</code>、<code>TLS 1.2</code> 和 <code>TLS 1.3</code>，目前被广泛使用的是 <code>TLS 1.2</code> 版本。</p>
<p>SSL&#x2F;TLS 涉及到了密码学中的对称加密、非对称加密、数字签名等等，算是密码学领域里的集大成者了。</p>
<h3 id="7-3-1-TLS"><a href="#7-3-1-TLS" class="headerlink" title="7.3.1 TLS"></a>7.3.1 TLS</h3><p>接下来我们就来看看 TLS 如何确保 HTTP 安全。</p>
<p>为了确保客户端和服务端之间的数据安全，我们很容易想到一种方案就是对传输的数据进行加密，没错，这是一个办法，事实上也是这么做的。</p>
<p>加密又分为两种：</p>
<ol>
<li>对称加密</li>
<li>非对称加密</li>
</ol>
<p>那么该使用哪一种呢？</p>
<p>对称加密，也就是加密密钥和解密密钥是同一个，当浏览器和服务端需要进行通信的时候，约定好一个密钥，然后使用这个密钥对发送的消息进行加密，对方收到消息之后再使用相同的密钥对消息进行解密。但是，在 B&#x2F;S 架构的项目中，这种方案显然不合适，一个网站把自己的密钥告诉全世界所有的浏览器，那加密和不加密还有区别吗？</p>
<p>有小伙伴可能又想到了不对称加密，不对称加密倒是个办法，因为不对称加密是有一个密钥对公钥和私钥，公钥可以公布出来告诉所有人，私钥只有自己知道。通信的时候，客户端首先使用公钥对消息进行加密，服务端收到之后，再通过私钥对消息进行解密，这看起来似乎挺完美的。但是！！！非对称加密存在一个问题，就是非对称加密和解密相当耗时，通过这种方式处理加解密效率太低。</p>
<p>那怎么办？我们可以将两者结合起来。</p>
<p>具体来说，就是这样：<strong>首先服务端会生成一个非对称加密的密钥对，私钥自己保存，公钥发送给客户端，客户端拿到这个公钥之后，再生成一个对称加密的密钥，然后把对称加密的密钥通过公钥进行加密，加密之后发送给服务端，服务端通过私钥进行解密，这样客户端和服务端就可以通过对称加密进行通信了。</strong></p>
<p>事实上，TLS 大致上的思路就是这样的。</p>
<p>不过上面这个方案还是有一个漏洞，那就是服务端要通过明文传输的方式把公钥发送给客户端，这个过程还是不安全的，可能被人恶意截胡，那么这个问题该如何解决呢？</p>
<p>这就涉及到另外一个概念叫做数字证书了。</p>
<h3 id="7-3-2-CA"><a href="#7-3-2-CA" class="headerlink" title="7.3.2 CA"></a>7.3.2 CA</h3><p>数字证书是一个<strong>包含了目标网站各种信息如网站域名、证书有效期、签发机构、用于生成对称密钥的公钥、上级证书签发的签名等</strong>的文件，通过数字证书我们可以确认一个用户或者服务站点的身份。</p>
<p>实际场景中的数字证书是一系列的，形成了一个信任链，信任链的最顶端是 CA。</p>
<p>CA 是 Certificate Authority 的简写，它是一个负责发放和管理数字的证书的第三方权威机构。CA 的工作流程是这样的：</p>
<ol>
<li>CA 自己给自己颁发的用自己的私钥签名的证书称为根证书，根证书的私钥安全性至关重要，根证书的私钥都是被保存在离线计算机中，有严格的操作规章，每次需要使用时，会有专人将数据通过 USB 拷贝过去，操作完了以后，再将数据带出来（这个专指 CA 根证书的私钥）。</li>
<li>一个用户想要获取一个证书，首先自己得有一个密钥对，私钥自己留着，公钥以及其他信息发送给 CA，向 CA 提出申请，CA 判明用户的身份之后，会将这个公钥和用户的身份信息绑定，并且为绑定后的信息进行签名（签名是通过 CA 根证书的私钥进行的），最后将签名后的证书发给申请者。</li>
<li>一个用户想要鉴定一个证书的真伪，就通过 CA 的公钥对证书上的数字签名进行验证，验证通过，就认为这个这个证书是有效的。</li>
</ol>
<p><strong>上面这个流程中有一个重要前提，那就是 CA 受到大家所有人的信任。</strong></p>
<p>然而在实际操作中，我们并不能直接去跟 CA 申请一个数字证书，因为全世界要认证的内容太多了，CA 搞不过来，而且频繁的找 CA 申请，还有可能导致私钥泄漏，这可就是一个大的灾难了。</p>
<p>那怎么办呢？实际操作中，我们可以基于 CA 来构建一个信任链。具体来说，步骤是这样：</p>
<ol>
<li>首先我们的手机、笔记本等操作系统中都预装了 CA 颁发的根证书，他们是所有信任构建的基石，前面松哥已经截图给大家看了 Windows 中预装的根证书了。</li>
<li>假设 CA 签发了一个证书 A，在这个过程中 CA 称为 Issuer，A 称为 Subject，假设 A 是一个受信任的中间证书，已经预装在我们的操作系统中了。现在由 A 利用它自己的私钥给某一个网站签发了一个证书 B。</li>
<li>现在当我们的电脑需要访问该网站的时候，该网站就会给我们发来一个证书 B，由于我们的浏览器并不知道 B 证书是否合法，但是我们的电脑上已经预装了 A 证书，我们可以从 A 证书中提取出 A 的公钥，然后利用 A 的公钥对 B 证书的签名进行验证（因为 B 证书的签名是 A 的私钥签的），如果验证通过了，就说明 B 是合法的。</li>
<li>相同的道理，B 也可以继续签发 C 证书，C 继续签发 D 证书，这样就形成了一个信任链。</li>
<li>如果服务端的签名是 D 证书，那么一般来说，服务器返回给浏览器的就会包含 B、C、D 三个证书（因为 A 证书已经在我们的电脑上了），即使只返回 D 证书，浏览器也可以根据 D 书中的信息，自动下载到 B、C 两个证书然后进行验证。</li>
</ol>
<blockquote>
<p>松哥记得以前上大学的时候，在 12306 网站上买火车票，第一次访问的时候必须要自己先手动安装一个根证书到系统中，然后才能访问。这就是因为当时 12306 所使用的证书的签发机构不被浏览器认可，类似于上面的第 3 步，12306 给我发了一个数字证书 B 回来，但是浏览器上没有合适的公钥对这个 B 证书进行验证，当我往自己的系统上安装了 12306 给的证书之后，相当于我的电脑上有了一个证书 A，现在就可以对 B 证书进行验证了。</p>
</blockquote>
<p>总结一下：</p>
<ol>
<li>CA 是一个权威的机构，是一个发证机关，CA 发出来的证书可以证明一个人或者组织的身份。</li>
<li>任何人都可以得到 CA 的证书（含公钥），用以验证 CA 所签发的证书。</li>
<li>每一个数字证书都是由上级证书的私钥来签发的，处于最顶层的就是 CA 签发的根证书了，这个根证书没有上级证书了，所以这个根证书实际上是由 CA 自己的私钥来签发的，这也叫做自签名，即 Self-Signed。</li>
</ol>
<p>当我们有了数字签名之后，就可以解决 3.1 小节最后提出的问题了。服务端将数字签名发给浏览器，浏览器利用系统已经内置的公钥验签，确认签名没问题，然后就提取出来数字签名中的公钥，开始协商对称加密的私钥了～</p>
<p>好啦，有了这些知识储备之后，下篇文章松哥来和大家聊一聊 TLS+gRPC 怎么玩！</p>
<h1 id="8-gRPC-TLS"><a href="#8-gRPC-TLS" class="headerlink" title="8 gRPC+TLS"></a>8 gRPC+TLS</h1><p>前面松哥发了一篇文章和小伙伴们仔细聊了聊 TLS、CA 证书这些问题，还没看过的小伙伴可以先戳下面了解下：</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/4c4xTp52TyLCJtJTR7y_Rw">TLS、SSL、CA 证书、公钥、私钥。。。今天捋一捋！</a></li>
</ul>
<p>今天我们要在前文的基础之上，来和小伙伴们聊一聊如何确保 gRPC 的通信安全。</p>
<p>确保 gRPC 的通信安全我们有很多种不同的方式，其中一种，就是对通信过程进行加密，使用上 TLS。对于 TLS 如何加密，如何协商密钥，这些我这里就不再啰嗦了，我在之前的文章中都已经介绍过了。咱们就直接来看具体的玩法。</p>
<p>这块整体上可以分为两大类：</p>
<ul>
<li>启用单向安全连接</li>
<li>启用 mTLS 安全连接</li>
</ul>
<p>我们分别来看。</p>
<h2 id="8-1-启用单向安全连接"><a href="#8-1-启用单向安全连接" class="headerlink" title="8.1 启用单向安全连接"></a>8.1 启用单向安全连接</h2><p>单向安全连接其实就是说只需要客户端校验服务端，确保客户端收到的消息来自预期的服务端，整个的校验就涉及到我们前文所说的 TLS、CA 等内容了，具体流程是这样：</p>
<ol>
<li>首先我们先在自己电脑本地生成一个自签名的 CA 证书。</li>
<li>利用这个 CA 证书，生成一个服务证书。</li>
</ol>
<p>大致上就这两个步骤就行了，然后在客户端和服务端中分别加载相应的证书即可。</p>
<blockquote>
<p>上面我们提到了需要先有一个自签名的 CA 证书，这一步其实也可以省略，省略之后就直接生成一个自签名的服务证书即可，然后在客户端和服务端都使用这个服务证书。</p>
</blockquote>
<p>来实际操作一下。</p>
<p>先自己安装一下 openssl 工具，配置一下环境变量，软件安装比较简单，我这里就不啰嗦了。</p>
<h3 id="8-1-1-生成-CA-证书"><a href="#8-1-1-生成-CA-证书" class="headerlink" title="8.1.1 生成 CA 证书"></a>8.1.1 生成 CA 证书</h3><p>首先我们来看下如何生成 CA 证书。</p>
<p>一共是三个步骤：</p>
<ol>
<li>生成 <code>.key</code> 私钥文件：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out ca.key 2048</span><br></pre></td></tr></table></figure>

<ul>
<li>out 表示输出的文件名。</li>
<li>2048 表示私钥的位数。</li>
</ul>
<ol start="2">
<li>生成 <code>.csr</code> 证书签名请求文件：</li>
</ol>
<p>CSR 即证书签名申请（Certificate Signing Request），获取 SSL 证书，需要先生成 CSR 文件并提交给证书颁发机构（CA）。CSR 包含了用于签发证书的公钥、用于辨识的名称信息（Distinguished Name）（例如域名）、真实性和完整性保护（例如数字签名），通常从 Web 服务器生成 CSR，同时创建加解密的公钥私钥对。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -key ca.key -out ca.csr  -subj &quot;/C=CN/L=GuangZhou/O=javaboy/CN=local.javaboy.org&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>subj 中描述的是一些国家、城市、组织以及通用名称（域名）等信息。</li>
</ul>
<ol start="3">
<li>自签名生成 <code>.crt</code> 证书文件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -x509 -days 3650 -key ca.key -out ca.crt  -subj &quot;/C=CN/L=GuangZhou/O=javaboy/CN=local.javaboy.org&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>-x509 表示是要生成自签名证书。</li>
<li>-days 3650 表示证书有效期是 3650 天。</li>
<li>-key 表示生成证书所需要的密钥。</li>
</ul>
<p>有人说公钥呢？公钥其实就在 <code>.crt</code> 证书文件中。</p>
<h3 id="8-1-2-生成服务证书"><a href="#8-1-2-生成服务证书" class="headerlink" title="8.1.2 生成服务证书"></a>8.1.2 生成服务证书</h3><p>再来看生成服务证书，生成服务证书和生成 CA 证书其实整个过程差不多，唯一的区别在于，CA 证书是自签名的，而服务证书是 CA 的私钥给签名的，就这个差别。</p>
<ol>
<li>生成 <code>.key</code> 私钥文件：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out server.key 2048</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 <code>.csr</code> 证书签名请求文件：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -key server.key -out server.csr -subj &quot;/C=CN/L=GuangZhou/O=javaboy/CN=local.javaboy.org&quot;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>签名生成 <code>.crt</code> 证书文件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -days 3650 -in server.csr -out server.crt -CA ca.crt -CAkey ca.key</span><br></pre></td></tr></table></figure>

<ul>
<li>-req 和 -in 指定了 server.csr，这个是证书请求文件，这里实际上是表示签署证书请求文件。</li>
</ul>
<p>证书现在就生成完毕。</p>
<p>这里我们生成的私钥都是 <code>.key</code> 文件，这个用我们 Java 代码加载的时候会有问题，我们要将之转为 <code>.pem</code> 格式然后再用 Java 代码进行加载，转换的命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs8 -topk8 -inform pem -in server.key -outform pem -nocrypt -out server.pem</span><br></pre></td></tr></table></figure>

<h3 id="8-1-3-单向加密"><a href="#8-1-3-单向加密" class="headerlink" title="8.1.3 单向加密"></a>8.1.3 单向加密</h3><p>现在证书都有了，在当前项目目录下新建一个文件夹，专门用来放证书，项目目录结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">├── certs</span><br><span class="line">│   ├── ca.crt</span><br><span class="line">│   ├── ca.csr</span><br><span class="line">│   ├── ca.key</span><br><span class="line">│   ├── server.crt</span><br><span class="line">│   ├── server.csr</span><br><span class="line">│   ├── server.key</span><br><span class="line">│   └── server.pem</span><br><span class="line">├── grpc_api</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   ├── src</span><br><span class="line">│   └── target</span><br><span class="line">├── grpc_client</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   ├── src</span><br><span class="line">│   └── target</span><br><span class="line">├── grpc_server</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   ├── src</span><br><span class="line">│   └── target</span><br><span class="line">└── pom.xml</span><br></pre></td></tr></table></figure>


<p>我们看下代码该如何改造实现单向加密通信。</p>
<p>先来看服务端代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">50051</span>;</span><br><span class="line">    <span class="type">File</span> <span class="variable">certFile</span> <span class="operator">=</span> Paths.get( <span class="string">&quot;certs&quot;</span>, <span class="string">&quot;server.crt&quot;</span>).toFile();</span><br><span class="line">    <span class="type">File</span> <span class="variable">keyFile</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;certs&quot;</span>, <span class="string">&quot;server.pem&quot;</span>).toFile();</span><br><span class="line">    server = ServerBuilder.forPort(port)</span><br><span class="line">            .addService(<span class="keyword">new</span> <span class="title class_">LoginServiceImpl</span>())</span><br><span class="line">            .addService(ServerInterceptors.intercept(<span class="keyword">new</span> <span class="title class_">HelloServiceImpl</span>(), <span class="keyword">new</span> <span class="title class_">AuthInterceptor</span>()))</span><br><span class="line">            .useTransportSecurity(certFile,keyFile)</span><br><span class="line">            .build()</span><br><span class="line">            .start();</span><br><span class="line">    Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        LoginServer.<span class="built_in">this</span>.stop();</span><br><span class="line">    &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>大家注意，由于我生成签名的时候，使用的域名是 <code>local.javaboy.org</code> 这是我在本地 hosts 文件中配置的，指向本地地址，所以在后续的通信中，我使用的域名都将是 <code>local.javaboy.org</code>。</p>
</blockquote>
<ol>
<li>Paths.get 方法表示从项目的根目录下开始查找文件，参数是可变长度参数，参数共同组成文件完整路径。</li>
<li>服务端需要加载服务签名和服务私钥，签名证书是客户端验证服务端身份用的，私钥则是服务端解密客户端消息使用的。</li>
</ol>
<p>服务端的改造就这些。</p>
<p>再来看客户端的改造：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">certFile</span> <span class="operator">=</span> Paths.get( <span class="string">&quot;certs&quot;</span>, <span class="string">&quot;ca.crt&quot;</span>).toFile();</span><br><span class="line"><span class="type">SslContext</span> <span class="variable">sslContext</span> <span class="operator">=</span> GrpcSslContexts.forClient().trustManager(certFile).build();</span><br><span class="line"><span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> NettyChannelBuilder.forAddress(<span class="string">&quot;local.javaboy.org&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">        .useTransportSecurity()</span><br><span class="line">        .sslContext(sslContext)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>

<p>客户端主要是加载 CA 证书文件，服务端的证书就是 CA 私钥签发的，但是需要 CA 公钥也就是 ca.crt 进行验签，所以这里客户端加载了 ca.crt 即可。</p>
<p>好啦，整体上的流程差不多就是这个样子。</p>
<h2 id="8-2-启用-mTLS-安全连接"><a href="#8-2-启用-mTLS-安全连接" class="headerlink" title="8.2 启用 mTLS 安全连接"></a>8.2 启用 mTLS 安全连接</h2><p>上面的例子只是客户端校验了服务端的身份，服务端并没有校验客户端的身份，如果想要双向校验，那么就把上面的流程对称操作一遍就可以了。</p>
<p>首先我们需要为客户端生成相应的证书，步骤跟前面也基本上一直，使用 CA 进行签名，如下：</p>
<ol>
<li>生成 <code>.key</code> 私钥文件：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out client.key 2048</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成 <code>.csr</code> 证书签名请求文件：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -key client.key -out client.csr -subj &quot;/C=CN/L=GuangZhou/O=javaboy/CN=local.javaboy.org&quot;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>签名生成 <code>.crt</code> 证书文件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -days 3650 -in client.csr -out client.crt -CA ca.crt -CAkey ca.key</span><br></pre></td></tr></table></figure>

<p>然后来看看代码。</p>
<p>先来看服务端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">50051</span>;</span><br><span class="line">    <span class="type">File</span> <span class="variable">certFile</span> <span class="operator">=</span> Paths.get( <span class="string">&quot;certs&quot;</span>, <span class="string">&quot;server.crt&quot;</span>).toFile();</span><br><span class="line">    <span class="type">File</span> <span class="variable">keyFile</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;certs&quot;</span>, <span class="string">&quot;server.pem&quot;</span>).toFile();</span><br><span class="line">    <span class="type">File</span> <span class="variable">caFile</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;certs&quot;</span>, <span class="string">&quot;ca.crt&quot;</span>).toFile();</span><br><span class="line">    server = NettyServerBuilder.forPort(port)</span><br><span class="line">            .addService(<span class="keyword">new</span> <span class="title class_">LoginServiceImpl</span>())</span><br><span class="line">            .addService(ServerInterceptors.intercept(<span class="keyword">new</span> <span class="title class_">HelloServiceImpl</span>(), <span class="keyword">new</span> <span class="title class_">AuthInterceptor</span>()))</span><br><span class="line">            .sslContext(GrpcSslContexts.forServer(certFile,keyFile).trustManager(caFile).clientAuth(ClientAuth.REQUIRE).build())</span><br><span class="line">            .build()</span><br><span class="line">            .start();</span><br><span class="line">    Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        LoginServer3.<span class="built_in">this</span>.stop();</span><br><span class="line">    &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端要加载的文件多了 <code>ca.crt</code>，这是给客户端验签的时候需要用到。</p>
<p>再来看看客户端代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">caFile</span> <span class="operator">=</span> Paths.get( <span class="string">&quot;certs&quot;</span>, <span class="string">&quot;ca.crt&quot;</span>).toFile();</span><br><span class="line"><span class="type">File</span> <span class="variable">certFile</span> <span class="operator">=</span> Paths.get( <span class="string">&quot;certs&quot;</span>, <span class="string">&quot;client.crt&quot;</span>).toFile();</span><br><span class="line"><span class="type">File</span> <span class="variable">keyFile</span> <span class="operator">=</span> Paths.get( <span class="string">&quot;certs&quot;</span>, <span class="string">&quot;client.pem&quot;</span>).toFile();</span><br><span class="line"><span class="type">SslContext</span> <span class="variable">sslContext</span> <span class="operator">=</span> GrpcSslContexts.forClient().trustManager(caFile)</span><br><span class="line">        .keyManager(certFile, keyFile).build();</span><br><span class="line"><span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> NettyChannelBuilder.forAddress(<span class="string">&quot;local.javaboy.org&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">        .useTransportSecurity()</span><br><span class="line">        .sslContext(sslContext)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>

<p>客户端多了 <code>client.crt</code> 和 <code>client.pem</code>，两者的作用根服务端中这两者的作用基本一致，前文已有说明，这里就不再赘述了。</p>
<p>好啦，如此之后，我们的 gRPC 通信就加上了 TLS 的外壳，更加安全了。</p>
<h1 id="9-gRPC-两种认证方式"><a href="#9-gRPC-两种认证方式" class="headerlink" title="9 gRPC 两种认证方式"></a>9 gRPC 两种认证方式</h1><p>在之前的文章中，松哥和小伙伴们聊了 gRPC+JWT 进行认证，这也是我们常用的认证方式之一，考虑到文章内容的完整性，今天松哥再来和小伙伴们聊一聊在 gRPC 中通过 HttpBasic 进行认证，HttpBasic 认证有一些天然的缺陷，这个在接下来的文章中松哥也会和大家进行分析。</p>
<p>好啦，如果还没看过之前的 gRPC+JWT 的文章，戳这里：</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/jIZrP-H3DmS9pvRD5QaTfA">手把手教大家在 gRPC 中使用 JWT 完成身份校验</a></li>
</ul>
<p>今天我们就来看看如何在 gRPC 中进行 Http Basic 认证。</p>
<h2 id="9-1-什么是-Basic-认证"><a href="#9-1-什么是-Basic-认证" class="headerlink" title="9.1 什么是 Basic 认证"></a>9.1 什么是 Basic 认证</h2><p>HTTP Basic authentication 中文译作 HTTP 基本认证，在这种认证方式中，将用户的登录用户名&#x2F;密码经过 Base64 编码之后，放在请求头的 Authorization 字段中，从而完成用户身份的 认证。</p>
<p>这是一种在 RFC7235(<a href="https://tools.ietf.org/html/rfc7235">https://tools.ietf.org/html/rfc7235</a>) 规范中定义的认证方式，当客户端发起一个请求之后，服务端可以针对该请求返回一个质询信息，然后客户端再􏰀供用户的凭 证信息。具体的质询与应答流程如图所示：</p>
<p><img src="http://img.itboyhub.com/2022/08/axx-xx-x10-1.png"></p>
<p>由上图可以看出，客户端的用户名和密码只是简单做了一个 Base64 转码，然后放到请求头中就传输到服务端了。</p>
<p>我们在日常的开发中，其实也很少见到这种认证方式，有的读者可能在一些老旧路由器中见过这种认证方式;另外，在一些非公开访问的 Web 应用中，可能也会见到这种认证方式。为什么很少见到这种认证方式的应用场景呢?主要还是安全问题。</p>
<p>HTTP 基本认证没有对传输的凭证信息进行加密，仅仅只是进行了 Base64 编码，这就造成了很大的安全隐患，所以如果用到了 HTTP 基本认证，一般都是结合 HTTPS 一起使用；同 时，一旦使用 HTTP 基本认证成功后，由于令牌缺乏有效期，除非用户重启浏览器或者修改密码，否则没有办法退出登录。</p>
<h2 id="9-2-gRPC-中的基本认证"><a href="#9-2-gRPC-中的基本认证" class="headerlink" title="9.2 gRPC 中的基本认证"></a>9.2 gRPC 中的基本认证</h2><p>gRPC 并没有为 Http Basic 认证提供专门的 API，如果我们需要在 gRPC 中进行 Http Basic 认证，需要自己手工处理。</p>
<p>不过相信小伙伴们看了上面的流程图之后，对于手工处理 gRPC+Http Basic 也没啥压力。</p>
<p>首先我们先来看客户端的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpBasicCredential</span> <span class="keyword">extends</span> <span class="title class_">CallCredentials</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HttpBasicCredential</span><span class="params">(String username, String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">applyRequestMetadata</span><span class="params">(RequestInfo requestInfo, Executor executor, MetadataApplier metadataApplier)</span> &#123;</span><br><span class="line">        executor.execute(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(Base64.getEncoder().encode((username + <span class="string">&quot;:&quot;</span> + password).getBytes()));</span><br><span class="line">                <span class="type">Metadata</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Metadata</span>();</span><br><span class="line">                headers.put(Metadata.Key.of(AuthConstant.AUTH_HEADER, Metadata.ASCII_STRING_MARSHALLER),</span><br><span class="line">                        String.format(<span class="string">&quot;%s %s&quot;</span>, AuthConstant.AUTH_TOKEN_TYPE, token));</span><br><span class="line">                metadataApplier.apply(headers);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                metadataApplier.fail(Status.UNAUTHENTICATED.withCause(e));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">thisUsesUnstableApi</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当客户端发起一个请求的时候，我们构建一个 HttpBasicCredential 对象，并传入用户名和密码。</li>
<li>该对象核心的处理逻辑在 applyRequestMetadata 方法中，我们先按照 <code>username + &quot;:&quot; + password</code> 的形式将用户名和密码拼接成一个字符串，并对这个字符串进行 Base64 编码。</li>
<li>最后将编码结果放在请求头中，请求头的 KEY 就是 <code>AuthConstant.AUTH_HEADER</code> 变量，对应的具体值是 Authorization，请求头的 value 是通过 <code>String.format</code> 函数拼接出来的，实际上就是在 Base64 的编码的字符串上加上了 <code>Basic </code> 前缀。</li>
</ul>
<p>这块就是纯手工操作，技术原理跟我们之前讲的 JWT+gRPC 没有任何差别，基本上是一模一样的，所以我就不啰嗦了。</p>
<p>来看下前端请求该如何发起：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, SSLException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">File</span> <span class="variable">certFile</span> <span class="operator">=</span> Paths.get( <span class="string">&quot;certs&quot;</span>, <span class="string">&quot;ca.crt&quot;</span>).toFile();</span><br><span class="line">        <span class="type">SslContext</span> <span class="variable">sslContext</span> <span class="operator">=</span> GrpcSslContexts.forClient().trustManager(certFile).build();</span><br><span class="line"></span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> NettyChannelBuilder.forAddress(<span class="string">&quot;local.javaboy.org&quot;</span>, <span class="number">50051</span>)</span><br><span class="line">                .useTransportSecurity()</span><br><span class="line">                .sslContext(sslContext)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        LoginServiceGrpc.<span class="type">LoginServiceStub</span> <span class="variable">stub</span> <span class="operator">=</span> LoginServiceGrpc.newStub(channel).withDeadline(Deadline.after(<span class="number">3</span>, TimeUnit.SECONDS));</span><br><span class="line">        sayHello(channel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">(ManagedChannel channel)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        HelloServiceGrpc.<span class="type">HelloServiceStub</span> <span class="variable">helloServiceStub</span> <span class="operator">=</span> HelloServiceGrpc.newStub(channel);</span><br><span class="line">        helloServiceStub</span><br><span class="line">                .withCallCredentials(<span class="keyword">new</span> <span class="title class_">HttpBasicCredential</span>(<span class="string">&quot;javaboy&quot;</span>, <span class="string">&quot;123&quot;</span>))</span><br><span class="line">                .sayHello(StringValue.newBuilder().setValue(<span class="string">&quot;wangwu&quot;</span>).build(), <span class="keyword">new</span> <span class="title class_">StreamObserver</span>&lt;StringValue&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(StringValue stringValue)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;stringValue.getValue() = &quot;</span> + stringValue.getValue());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;throwable.getMessage() = &quot;</span> + throwable.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> &#123;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 withCallCredentials 方法，在客户端发起请求的时候，把这段认证信息携带上。</p>
<p>再来看看服务端的处理。</p>
<p>服务端通过一个拦截器来统一处理，从请求头中提取出来认证信息并解析判断，逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthInterceptor</span> <span class="keyword">implements</span> <span class="title class_">ServerInterceptor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">JwtParser</span> <span class="variable">parser</span> <span class="operator">=</span> Jwts.parser().setSigningKey(AuthConstant.JWT_KEY);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;ReqT, RespT&gt; ServerCall.Listener&lt;ReqT&gt; <span class="title function_">interceptCall</span><span class="params">(ServerCall&lt;ReqT, RespT&gt; serverCall, Metadata metadata, ServerCallHandler&lt;ReqT, RespT&gt; serverCallHandler)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">authorization</span> <span class="operator">=</span> metadata.get(Metadata.Key.of(AuthConstant.AUTH_HEADER, Metadata.ASCII_STRING_MARSHALLER));</span><br><span class="line">        <span class="type">Status</span> <span class="variable">status</span> <span class="operator">=</span> Status.OK;</span><br><span class="line">        <span class="keyword">if</span> (authorization == <span class="literal">null</span>) &#123;</span><br><span class="line">            status = Status.UNAUTHENTICATED.withDescription(<span class="string">&quot;miss authentication token&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!authorization.startsWith(AuthConstant.AUTH_TOKEN_TYPE)) &#123;</span><br><span class="line">            status = Status.UNAUTHENTICATED.withDescription(<span class="string">&quot;unknown token type&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> authorization.substring(AuthConstant.AUTH_TOKEN_TYPE.length()).trim();</span><br><span class="line">                String[] split = <span class="keyword">new</span> <span class="title class_">String</span>(Base64.getDecoder().decode(token)).split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> split[<span class="number">0</span>];</span><br><span class="line">                <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> split[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;javaboy&quot;</span>.equals(username) &amp;&amp; <span class="string">&quot;123&quot;</span>.equals(password)) &#123;</span><br><span class="line">                    <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> Context.current()</span><br><span class="line">                            .withValue(AuthConstant.AUTH_CLIENT_ID, username);</span><br><span class="line">                    <span class="keyword">return</span> Contexts.interceptCall(ctx, serverCall, metadata, serverCallHandler);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JwtException e) &#123;</span><br><span class="line">                status = Status.UNAUTHENTICATED.withDescription(e.getMessage()).withCause(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        serverCall.close(status, <span class="keyword">new</span> <span class="title class_">Metadata</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerCall</span>.Listener&lt;ReqT&gt;() &#123;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>首先从请求头中取出 Base64 编码之后的令牌。</li>
<li>如果取出的值为 null，则返回 <code>miss authentication token</code>。</li>
<li>如果取出的令牌的起始字符不对，则返回 <code>unknown token type</code>。</li>
<li>如果前面都没问题，则开始对拿到的字符串进行 Base64 解码，解码之后做字符串拆分，然后分别判断用户名和密码是否正确，如果正确，则将用户名存入到 Context 中，在后续的业务逻辑中就可以使用了。</li>
</ol>
<p>服务端的启动代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginServer</span> &#123;</span><br><span class="line">    Server server;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        <span class="type">LoginServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginServer</span>();</span><br><span class="line">        server.start();</span><br><span class="line">        server.blockUntilShutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">50051</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">certFile</span> <span class="operator">=</span> Paths.get( <span class="string">&quot;certs&quot;</span>, <span class="string">&quot;server.crt&quot;</span>).toFile();</span><br><span class="line">        <span class="type">File</span> <span class="variable">keyFile</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;certs&quot;</span>, <span class="string">&quot;server.pem&quot;</span>).toFile();</span><br><span class="line">        server = ServerBuilder.forPort(port)</span><br><span class="line">                .addService(ServerInterceptors.intercept(<span class="keyword">new</span> <span class="title class_">HelloServiceImpl</span>(), <span class="keyword">new</span> <span class="title class_">AuthInterceptor</span>()))</span><br><span class="line">                .useTransportSecurity(certFile,keyFile)</span><br><span class="line">                .build()</span><br><span class="line">                .start();</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            LoginServer.<span class="built_in">this</span>.stop();</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (server != <span class="literal">null</span>) &#123;</span><br><span class="line">            server.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">blockUntilShutdown</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (server != <span class="literal">null</span>) &#123;</span><br><span class="line">            server.awaitTermination();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小伙伴们看下，就是用了下这个拦截器而已。</p>
<p>最后，在业务代码中，也可以直接访问到刚刚认证成功的用户名：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">HelloServiceGrpc</span>.HelloServiceImplBase &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">(StringValue request, StreamObserver&lt;StringValue&gt; responseObserver)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">clientId</span> <span class="operator">=</span> AuthConstant.AUTH_CLIENT_ID.get();</span><br><span class="line">        responseObserver.onNext(StringValue.newBuilder().setValue(clientId + <span class="string">&quot; say hello:&quot;</span> + request.getValue()).build());</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好啦，大功告成。</p>
<h2 id="9-3-小结"><a href="#9-3-小结" class="headerlink" title="9.3 小结"></a>9.3 小结</h2><p>和之前的 JWT 相比，Http Basic 认证的缺点还是非常明显的，但是从认证流程来说，感觉两者差别不大，只是创建令牌和解析令牌的方式不同而已。</p>
<p>感兴趣的小伙伴可以尝试一下哦。</p>
<p>本文松哥只贴出来了一些关键代码，完整的代码小伙伴们可以从 GitHub 上下载：<a href="https://github.com/lenve/javaboy-code-samples">https://github.com/lenve/javaboy-code-samples</a></p>
<h1 id="10-Spring-Boot-Nacos-gRPC"><a href="#10-Spring-Boot-Nacos-gRPC" class="headerlink" title="10 Spring Boot+Nacos+gRPC"></a>10 Spring Boot+Nacos+gRPC</h1><p>gRPC 的基础知识前面跟小伙伴们分享了很多了，今天再写一篇给这个小小的系列收个尾。</p>
<p>我们前面介绍的都是 gRPC 的基本用法，最终目的当然是希望能够在 Spring Boot 中用上这个东西，相信大部分小伙伴对于微服务的通信方案如 OpenFeign、Dubbo、消息驱动都有所了解，但是对于这三种方案之外的其他方案，可能听的多用的少，今天我们就来实践一下 gRPC 这种方案。</p>
<blockquote>
<p>顺便说一下我为什么会想到写 gRPC 教程呢，是因为之前我想给小伙伴们总结一下常见的各种微服务通信方案。整理到 gRPC 的时候发现我还没写过 gRPC 相关的教程，因此就有了一个小系列。</p>
</blockquote>
<h2 id="10-1-依赖选择"><a href="#10-1-依赖选择" class="headerlink" title="10.1 依赖选择"></a>10.1 依赖选择</h2><p>Spring Boot 整合 gRPC，官方其实并没有提供相应的依赖，不过目前有一个比较流行的第三方库可以使用：</p>
<ul>
<li><a href="https://github.com/yidongnan/grpc-spring-boot-starter">https://github.com/yidongnan/grpc-spring-boot-starter</a></li>
</ul>
<p>接下来松哥就结合这个库，来和小伙伴们演示一下 Spring Boot+Nacos+gRPC 的用法。</p>
<p>可能有小伙伴也会见到一些其他的第三方库，这个其实都可以，只要稳定可靠就行，本文就以上面这个库为例来和小伙伴们介绍。</p>
<h2 id="10-2-准备工作"><a href="#10-2-准备工作" class="headerlink" title="10.2 准备工作"></a>10.2 准备工作</h2><p>这里我采用了 Nacos 来做服务注册中心，使用的 Nacos 版本是 2.0.2 这个版本。Nacos 简单安装一下就行了，为了省事，数据持久化啥的可以先不配置。也就是 Nacos 下载解压之后，直接执行如下命令单体运行就行了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh startup.sh -m standalone</span><br></pre></td></tr></table></figure>

<p>这块没啥好说的，松哥在 vhr 系列里也有相关的视频教程，这里就不啰嗦了。</p>
<h2 id="10-3-代码实践"><a href="#10-3-代码实践" class="headerlink" title="10.3 代码实践"></a>10.3 代码实践</h2><p>首先我们来看看我们的项目结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">├─grpc-api</span><br><span class="line">│  └─src</span><br><span class="line">│      └─main</span><br><span class="line">│          └─proto</span><br><span class="line">├─grpc-client</span><br><span class="line">│  └─src</span><br><span class="line">│      ├─main</span><br><span class="line">│      │  ├─java</span><br><span class="line">│      │  └─resources</span><br><span class="line">│      └─test</span><br><span class="line">└─grpc-server</span><br><span class="line">    └─src</span><br><span class="line">        ├─main</span><br><span class="line">        │  ├─java</span><br><span class="line">        │  └─resources</span><br><span class="line">        └─test</span><br></pre></td></tr></table></figure>

<p>首先有一个公共的模块 grpc-api，这个模块用来放我们的公共代码和依赖，包括 Protocol Buffers 文件也放在这里。</p>
<p>grpc-client 和 grpc-server 就不用多说了，分别是我们的客户端和服务端。</p>
<h3 id="10-3-1-grpc-api"><a href="#10-3-1-grpc-api" class="headerlink" title="10.3.1 grpc-api"></a>10.3.1 grpc-api</h3><p>grpc-api 中主要是处理 grpc 相关的事情，包括添加需要的依赖、插件等，编写 Protocol Buffers 文件等。</p>
<p>我们先来看看该项目的 pom.xml 文件中的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">protobuf.version</span>&gt;</span>3.21.7<span class="tag">&lt;/<span class="name">protobuf.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">protobuf-plugin.version</span>&gt;</span>0.6.1<span class="tag">&lt;/<span class="name">protobuf-plugin.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">grpc.version</span>&gt;</span>1.52.1<span class="tag">&lt;/<span class="name">grpc.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-stub<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-protobuf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Java 9+ compatibility - Do NOT update to 2.0.0 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jakarta.annotation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jakarta.annotation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">extensions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">extension</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>kr.motd.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>os-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xolstice.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;protobuf-plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">protocArtifact</span>&gt;</span>com.google.protobuf:protoc:$&#123;protobuf.version&#125;:exe:$&#123;os.detected.classifier&#125;<span class="tag">&lt;/<span class="name">protocArtifact</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pluginId</span>&gt;</span>grpc-java<span class="tag">&lt;/<span class="name">pluginId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pluginArtifact</span>&gt;</span>io.grpc:protoc-gen-grpc-java:$&#123;grpc.version&#125;:exe:$&#123;os.detected.classifier&#125;<span class="tag">&lt;/<span class="name">pluginArtifact</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile-custom<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这块的依赖跟我们之前的 gRPC 文章中案例的依赖基本上都是一致的，没有区别，再来看看我们的 Protocol Buffers 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">option java_multiple_files = true;</span><br><span class="line">option java_package = &quot;org.javaboy.grpc.api&quot;;</span><br><span class="line">option java_outer_classname = &quot;LoginProto&quot;;</span><br><span class="line">import &quot;google/protobuf/wrappers.proto&quot;;</span><br><span class="line"></span><br><span class="line">package login;</span><br><span class="line"></span><br><span class="line">service HelloService&#123;</span><br><span class="line">  rpc sayHello(google.protobuf.StringValue) returns (google.protobuf.StringValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很简单的一个 HelloService 服务。</p>
<h3 id="10-3-2-grpc-server"><a href="#10-3-2-grpc-server" class="headerlink" title="10.3.2 grpc-server"></a>10.3.2 grpc-server</h3><p>grpc-server 则是我们的服务端，这是一个 Spring Boot 工程，项目依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javaboy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>grpc-server<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">description</span>&gt;</span>grpc-server<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>17<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javaboy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.devh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-server-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.14.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.0.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于第三方库 <code>grpc-server-spring-boot-starter</code> 在支持 Spring Boot3 上还有一些瑕疵，因此我这里使用了 Spring Boot2.7.7 这个版本。</p>
<p>这里需要注意的是就是添加了 gRPC 的依赖 <code>grpc-server-spring-boot-starter</code> 和 nacos 的依赖。其他都是常规配置。</p>
<p>接下来我们来在服务端提供 gRPC 方法的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GrpcService</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">HelloServiceGrpc</span>.HelloServiceImplBase &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">(StringValue request, StreamObserver&lt;StringValue&gt; responseObserver)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> request.getValue();</span><br><span class="line">        responseObserver.onNext(StringValue.newBuilder().setValue(<span class="string">&quot;hello &quot;</span> + value).build());</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小伙伴们看到，通过 <code>@GrpcService</code> 注解去标记我们的一个服务即可。</p>
<p>最后，在 application.yaml 中进行配置，将当前服务注册到 nacos 容器中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">grpc:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9099</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">hc.javaboy.org:8848</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">grpc_server</span></span><br></pre></td></tr></table></figure>

<p>OK，服务端搞定。</p>
<h3 id="10-3-3-grpc-client"><a href="#10-3-3-grpc-client" class="headerlink" title="10.3.3 grpc-client"></a>10.3.3 grpc-client</h3><p>最后再来看看客户端。</p>
<p>先来看依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javaboy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>grpc-client<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">description</span>&gt;</span>grpc-client<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>17<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javaboy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.devh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-client-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.14.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.0.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意，客户端 grpc 的依赖是 <code>grpc-client-spring-boot-starter</code>，其他的基本上和服务端一致。</p>
<p>然后配置客户端，将之注册到 nacos 上，如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8088</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">hc.javaboy.org:8848</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">grpc_client</span></span><br><span class="line"><span class="attr">grpc:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">grpc_server:</span></span><br><span class="line">      <span class="attr">negotiation-type:</span> <span class="string">plaintext</span></span><br></pre></td></tr></table></figure>

<p>最后面有一个 grpc_server，这个是固定的（依据就是 grpc_server 注册到 nacos 上的名称），表示这个服务的通信不使用 TLS 加密。</p>
<p>最后再来看看调用代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    GrpcClientService grpcClientService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        grpcClientService.hello();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrpcClientService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GrpcClient(&quot;grpc_server&quot;)</span></span><br><span class="line">    HelloServiceGrpc.HelloServiceBlockingStub helloServiceBlockingStub;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringValue</span> <span class="variable">s</span> <span class="operator">=</span> helloServiceBlockingStub.sayHello(StringValue.newBuilder().setValue(<span class="string">&quot;javaboy&quot;</span>).build());</span><br><span class="line">        System.out.println(<span class="string">&quot;s = &quot;</span> + s.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的核心其实就是通过 <code>@GrpcClient</code> 注解注入一个 HelloServiceBlockingStub 实例，其中 <code>@GrpcClient</code> 注解中的参数就是注册到 nacos 上服务的名字，将来会自动根据服务的名字查找到服务的具体地址进行调用。</p>
<p>好啦，大功告成。</p>
<p>接下来我们启动 grpc_server 和 grpc_client 就可以进行测试了。</p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/gRPC/">gRPC</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="https://www.javaboy.org/images/sb/weixin_pay.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2023/0412/mysql_index.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">MySQL索引数据结构入门</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2023/0403/gprc_nacos_springboot.html"><span class="level-item">Spring Boot+Nacos+gRPC，一个区别于 OpenFeign 的微服务通信方案！</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="http://img.itboyhub.com/2024/mp/20241218191201.png" alt="江南一点雨"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">江南一点雨</p><p class="is-size-6 is-block">江南一点雨</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>China · ShenZhen</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives/"><p class="title">768</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories/"><p class="title">78</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags/"><p class="title">154</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/lenve" target="_blank" rel="me noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Github" href="https://github.com/lenve"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="envelope" href="mailto:wangsong0210@gmail.com"><i class="fa fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/2019/"><span class="level-start"><span class="level-item">2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Blog/"><span class="level-start"><span class="level-item">Blog</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Chrome/"><span class="level-start"><span class="level-item">Chrome</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Docker/"><span class="level-start"><span class="level-item">Docker</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/ElasticSearch/"><span class="level-start"><span class="level-item">ElasticSearch</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/FastDFS/"><span class="level-start"><span class="level-item">FastDFS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Git/"><span class="level-start"><span class="level-item">Git</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/GitHub/"><span class="level-start"><span class="level-item">GitHub</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/HDC/"><span class="level-start"><span class="level-item">HDC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/HUAWEI/"><span class="level-start"><span class="level-item">HUAWEI</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/IDEA/"><span class="level-start"><span class="level-item">IDEA</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/IntelliJ-IDEA/"><span class="level-start"><span class="level-item">IntelliJ IDEA</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/JavaWeb/"><span class="level-start"><span class="level-item">JavaWeb</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/MacBookPro/"><span class="level-start"><span class="level-item">MacBookPro</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Maven/"><span class="level-start"><span class="level-item">Maven</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/MongoDB/"><span class="level-start"><span class="level-item">MongoDB</span></span><span class="level-end"><span class="level-item tag">19</span></span></a></li><li><a class="level is-mobile" href="/categories/MyBatis/"><span class="level-start"><span class="level-item">MyBatis</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/MyBatis-Plus/"><span class="level-start"><span class="level-item">MyBatis-Plus</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/MySQL/"><span class="level-start"><span class="level-item">MySQL</span></span><span class="level-end"><span class="level-item tag">59</span></span></a></li><li><a class="level is-mobile" href="/categories/MySQL8/"><span class="level-start"><span class="level-item">MySQL8</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/Nginx/"><span class="level-start"><span class="level-item">Nginx</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/OAuth2/"><span class="level-start"><span class="level-item">OAuth2</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/RabbitMQ/"><span class="level-start"><span class="level-item">RabbitMQ</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li><li><a class="level is-mobile" href="/categories/Redis/"><span class="level-start"><span class="level-item">Redis</span></span><span class="level-end"><span class="level-item tag">20</span></span></a></li><li><a class="level is-mobile" href="/categories/Resume/"><span class="level-start"><span class="level-item">Resume</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/SSM/"><span class="level-start"><span class="level-item">SSM</span></span><span class="level-end"><span class="level-item tag">25</span></span></a></li><li><a class="level is-mobile" href="/categories/Shiro/"><span class="level-start"><span class="level-item">Shiro</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Spring/"><span class="level-start"><span class="level-item">Spring</span></span><span class="level-end"><span class="level-item tag">58</span></span></a></li><li><a class="level is-mobile" href="/categories/Spring-Boot/"><span class="level-start"><span class="level-item">Spring Boot</span></span><span class="level-end"><span class="level-item tag">131</span></span></a></li><li><a class="level is-mobile" href="/categories/Spring-Cloud/"><span class="level-start"><span class="level-item">Spring Cloud</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Spring-Security/"><span class="level-start"><span class="level-item">Spring Security</span></span><span class="level-end"><span class="level-item tag">76</span></span></a></li><li><a class="level is-mobile" href="/categories/Spring6/"><span class="level-start"><span class="level-item">Spring6</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/categories/SpringBoot/"><span class="level-start"><span class="level-item">SpringBoot</span></span><span class="level-end"><span class="level-item tag">28</span></span></a></li><li><a class="level is-mobile" href="/categories/SpringCloud/"><span class="level-start"><span class="level-item">SpringCloud</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/SpringMVC/"><span class="level-start"><span class="level-item">SpringMVC</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/SpringSecurity/"><span class="level-start"><span class="level-item">SpringSecurity</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/TienChin/"><span class="level-start"><span class="level-item">TienChin</span></span><span class="level-end"><span class="level-item tag">87</span></span></a></li><li><a class="level is-mobile" href="/categories/Transaction/"><span class="level-start"><span class="level-item">Transaction</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/WebFlux/"><span class="level-start"><span class="level-item">WebFlux</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/categories/blog/"><span class="level-start"><span class="level-item">blog</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/chrome/"><span class="level-start"><span class="level-item">chrome</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/docker/"><span class="level-start"><span class="level-item">docker</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/domain/"><span class="level-start"><span class="level-item">domain</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/gRPC/"><span class="level-start"><span class="level-item">gRPC</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/hexo/"><span class="level-start"><span class="level-item">hexo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/idea/"><span class="level-start"><span class="level-item">idea</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/java/"><span class="level-start"><span class="level-item">java</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/layui/"><span class="level-start"><span class="level-item">layui</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/life/"><span class="level-start"><span class="level-item">life</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/mail/"><span class="level-start"><span class="level-item">mail</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/mysql/"><span class="level-start"><span class="level-item">mysql</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/nginx/"><span class="level-start"><span class="level-item">nginx</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/redis/"><span class="level-start"><span class="level-item">redis</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/transaction/"><span class="level-start"><span class="level-item">transaction</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/vhr/"><span class="level-start"><span class="level-item">vhr</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/video/"><span class="level-start"><span class="level-item">video</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/vue/"><span class="level-start"><span class="level-item">vue</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/weixin/"><span class="level-start"><span class="level-item">weixin</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E4%BE%83%E4%BE%83%E8%80%8C%E8%B0%88/"><span class="level-start"><span class="level-item">侃侃而谈</span></span><span class="level-end"><span class="level-item tag">31</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"><span class="level-start"><span class="level-item">分布式事务</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/"><span class="level-start"><span class="level-item">分布式系统</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB/"><span class="level-start"><span class="level-item">前后端分离</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%8D%8E%E4%B8%BA/"><span class="level-start"><span class="level-item">华为</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%A4%96%E5%8C%85/"><span class="level-start"><span class="level-item">外包</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90/"><span class="level-start"><span class="level-item">学习资源</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"><span class="level-start"><span class="level-item">定时任务</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%B7%A5%E5%85%B7/"><span class="level-start"><span class="level-item">工具</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%BE%AE%E4%BA%BA%E4%BA%8B/"><span class="level-start"><span class="level-item">微人事</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"><span class="level-start"><span class="level-item">微服务</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%9D%82%E8%B0%88/"><span class="level-start"><span class="level-item">杂谈</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%94%9F%E6%B4%BB/"><span class="level-start"><span class="level-item">生活</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"><span class="level-start"><span class="level-item">程序人生</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%A7%86%E9%A2%91%E6%95%99%E7%A8%8B/"><span class="level-start"><span class="level-item">视频教程</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%AE%AD%E7%BB%83%E8%90%A5/"><span class="level-start"><span class="level-item">训练营</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%B5%84%E6%96%99/"><span class="level-start"><span class="level-item">资料</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%9D%A2%E8%AF%95/"><span class="level-start"><span class="level-item">面试</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/"><span class="level-start"><span class="level-item">项目实战</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-06-27T12:28:13.000Z">2024-06-27</time></p><p class="title"><a href="/2024/0627/mysql-navicat.html">这款老牌 MySQL 客户端可以免费用了！</a></p><p class="categories"><a href="/categories/MySQL/">MySQL</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-06-17T12:27:45.000Z">2024-06-17</time></p><p class="title"><a href="/2024/0617/spring-security-logout.html">管理员如何踢掉登录用户？</a></p><p class="categories"><a href="/categories/Spring-Security/">Spring Security</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-06-16T12:27:34.000Z">2024-06-16</time></p><p class="title"><a href="/2024/0616/redis-video.html">面试为什么老爱问 Redis？</a></p><p class="categories"><a href="/categories/Redis/">Redis</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-06-13T12:27:21.000Z">2024-06-13</time></p><p class="title"><a href="/2024/0613/java-python.html">Java 猿的 Python 奇遇</a></p><p class="categories"><a href="/categories/%E4%BE%83%E4%BE%83%E8%80%8C%E8%B0%88/">侃侃而谈</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-06-12T12:26:49.000Z">2024-06-12</time></p><p class="title"><a href="/2024/0612/spring-transaction.html">事务中存在多线程，怎么处理？</a></p><p class="categories"><a href="/categories/Spring/">Spring</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/06/"><span class="level-start"><span class="level-item">六月 2024</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/05/"><span class="level-start"><span class="level-item">五月 2024</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/04/"><span class="level-start"><span class="level-item">四月 2024</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/03/"><span class="level-start"><span class="level-item">三月 2024</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">一月 2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/12/"><span class="level-start"><span class="level-item">十二月 2023</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/11/"><span class="level-start"><span class="level-item">十一月 2023</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/10/"><span class="level-start"><span class="level-item">十月 2023</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/09/"><span class="level-start"><span class="level-item">九月 2023</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/08/"><span class="level-start"><span class="level-item">八月 2023</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/07/"><span class="level-start"><span class="level-item">七月 2023</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/05/"><span class="level-start"><span class="level-item">五月 2023</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/04/"><span class="level-start"><span class="level-item">四月 2023</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/03/"><span class="level-start"><span class="level-item">三月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/12/"><span class="level-start"><span class="level-item">十二月 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/11/"><span class="level-start"><span class="level-item">十一月 2022</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/09/"><span class="level-start"><span class="level-item">九月 2022</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">二月 2022</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">一月 2022</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">十二月 2021</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">21</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">23</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">25</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">25</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">20</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span><span class="level-end"><span class="level-item tag">40</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/09/"><span class="level-start"><span class="level-item">九月 2019</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">六月 2019</span></span><span class="level-end"><span class="level-item tag">43</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">四月 2019</span></span><span class="level-end"><span class="level-item tag">26</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/2019-article/"><span class="tag">2019-article</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Actuator/"><span class="tag">Actuator</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Blog/"><span class="tag">Blog</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Bug/"><span class="tag">Bug</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CAS/"><span class="tag">CAS</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CORS/"><span class="tag">CORS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Chrome/"><span class="tag">Chrome</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Druid/"><span class="tag">Druid</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ehcache/"><span class="tag">Ehcache</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ElasticJob/"><span class="tag">ElasticJob</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ElasticSearch/"><span class="tag">ElasticSearch</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ElasticSerach/"><span class="tag">ElasticSerach</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Eureka/"><span class="tag">Eureka</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/FastDFS/"><span class="tag">FastDFS</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Flowable/"><span class="tag">Flowable</span><span class="tag">38</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Flyway/"><span class="tag">Flyway</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Freemarker/"><span class="tag">Freemarker</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git/"><span class="tag">Git</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GitHub/"><span class="tag">GitHub</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HDC/"><span class="tag">HDC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Https/"><span class="tag">Https</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/I18N/"><span class="tag">I18N</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/IDEA/"><span class="tag">IDEA</span><span class="tag">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/IDEA%EF%BC%8CEasyCode/"><span class="tag">IDEA，EasyCode</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/IntelliJ-IDEA/"><span class="tag">IntelliJ IDEA</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JDK16/"><span class="tag">JDK16</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JWT/"><span class="tag">JWT</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaWeb/"><span class="tag">JavaWeb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JdbcTemplate/"><span class="tag">JdbcTemplate</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Jedis/"><span class="tag">Jedis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Jenkins/"><span class="tag">Jenkins</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Jpa/"><span class="tag">Jpa</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LiveReload/"><span class="tag">LiveReload</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Log/"><span class="tag">Log</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Lombok/"><span class="tag">Lombok</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MacBook/"><span class="tag">MacBook</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MacBookPro/"><span class="tag">MacBookPro</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mail/"><span class="tag">Mail</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Maven/"><span class="tag">Maven</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MongoDB/"><span class="tag">MongoDB</span><span class="tag">19</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MyBatis/"><span class="tag">MyBatis</span><span class="tag">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MyBatis-Plus/"><span class="tag">MyBatis-Plus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MyBatisPlus/"><span class="tag">MyBatisPlus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MyCat/"><span class="tag">MyCat</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">66</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL8/"><span class="tag">MySQL8</span><span class="tag">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nacos/"><span class="tag">Nacos</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nginx/"><span class="tag">Nginx</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OAuth2/"><span class="tag">OAuth2</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PicGo/"><span class="tag">PicGo</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Platform/"><span class="tag">Platform</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Plugin/"><span class="tag">Plugin</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RabbitMQ/"><span class="tag">RabbitMQ</span><span class="tag">19</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag">24</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Resume/"><span class="tag">Resume</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SSM/"><span class="tag">SSM</span><span class="tag">22</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Shiro/"><span class="tag">Shiro</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring/"><span class="tag">Spring</span><span class="tag">75</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring-Boot/"><span class="tag">Spring Boot</span><span class="tag">182</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring-Cloud/"><span class="tag">Spring Cloud</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring-Data/"><span class="tag">Spring Data</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring-Security/"><span class="tag">Spring Security</span><span class="tag">102</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring6/"><span class="tag">Spring6</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringBoot/"><span class="tag">SpringBoot</span><span class="tag">43</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringBoot3/"><span class="tag">SpringBoot3</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringCloud/"><span class="tag">SpringCloud</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringData/"><span class="tag">SpringData</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringDataJpa/"><span class="tag">SpringDataJpa</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringMVC/"><span class="tag">SpringMVC</span><span class="tag">25</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringSecurity/"><span class="tag">SpringSecurity</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Swagger/"><span class="tag">Swagger</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Swagger2/"><span class="tag">Swagger2</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Swagger3/"><span class="tag">Swagger3</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TLS/"><span class="tag">TLS</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Tencent/"><span class="tag">Tencent</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Thymeleaf/"><span class="tag">Thymeleaf</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TienChin/"><span class="tag">TienChin</span><span class="tag">89</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Transaction/"><span class="tag">Transaction</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Video/"><span class="tag">Video</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ViewResolver/"><span class="tag">ViewResolver</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vue/"><span class="tag">Vue</span><span class="tag">45</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Vue3/"><span class="tag">Vue3</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Web/"><span class="tag">Web</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WebFlux/"><span class="tag">WebFlux</span><span class="tag">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/blog/"><span class="tag">blog</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/domain/"><span class="tag">domain</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elasticjob/"><span class="tag">elasticjob</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/es/"><span class="tag">es</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gRPC/"><span class="tag">gRPC</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hdz/"><span class="tag">hdz</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hexo/"><span class="tag">hexo</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/huawei/"><span class="tag">huawei</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/i18n/"><span class="tag">i18n</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/idea/"><span class="tag">idea</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">java</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/life/"><span class="tag">life</span><span class="tag">18</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mail/"><span class="tag">mail</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/router/"><span class="tag">router</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/saga/"><span class="tag">saga</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/seata/"><span class="tag">seata</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tcc/"><span class="tag">tcc</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/transaction/"><span class="tag">transaction</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vhr/"><span class="tag">vhr</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/video/"><span class="tag">video</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vue/"><span class="tag">vue</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vuepress/"><span class="tag">vuepress</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/weixin/"><span class="tag">weixin</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xa/"><span class="tag">xa</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xxl-job/"><span class="tag">xxl-job</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/yaml/"><span class="tag">yaml</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%B8%83%E7%89%9B%E4%BA%91/"><span class="tag">七牛云</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"><span class="tag">中间件</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"><span class="tag">主从复制</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BA%8B%E5%8A%A1/"><span class="tag">事务</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BE%83%E4%BE%83%E8%80%8C%E8%B0%88/"><span class="tag">侃侃而谈</span><span class="tag">25</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%85%A8%E5%B1%80ID/"><span class="tag">全局ID</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"><span class="tag">分布式</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"><span class="tag">分布式事务</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"><span class="tag">分布式锁</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB/"><span class="tag">前后端分离</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%8E%E4%B8%BA/"><span class="tag">华为</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%95%E4%BD%93%E5%BA%94%E7%94%A8/"><span class="tag">单体应用</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A4%96%E5%8C%85/"><span class="tag">外包</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90/"><span class="tag">学习资源</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"><span class="tag">定时任务</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B7%A5%E5%85%B7/"><span class="tag">工具</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B9%B2%E8%B4%A7%E6%B1%87%E6%80%BB/"><span class="tag">干货汇总</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97/"><span class="tag">延迟队列</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BE%AE%E4%BA%BA%E4%BA%8B/"><span class="tag">微人事</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"><span class="tag">微服务</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82%E8%B0%88/"><span class="tag">杂谈</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%A1%E4%BB%B6%E6%B3%A8%E8%A7%A3/"><span class="tag">条件注解</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97/"><span class="tag">死信队列</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B6%88%E6%81%AF%E8%BF%87%E6%9C%9F/"><span class="tag">消息过期</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8/"><span class="tag">消息驱动</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"><span class="tag">源码解析</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"><span class="tag">源码解读</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%9F%E6%B4%BB/"><span class="tag">生活</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A7%81%E6%B4%BB/"><span class="tag">私活</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E4%BA%BA%E7%94%9F/"><span class="tag">程序人生</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A8%8B%E5%BA%8F%E5%91%98/"><span class="tag">程序员</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%85%BE%E8%AE%AF/"><span class="tag">腾讯</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%87%AA%E5%AD%A6/"><span class="tag">自学</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%A7%86%E9%A2%91/"><span class="tag">视频</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%A7%86%E9%A2%91%E6%95%99%E7%A8%8B/"><span class="tag">视频教程</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AE%AD%E7%BB%83%E8%90%A5/"><span class="tag">训练营</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%B5%84%E6%96%99/"><span class="tag">资料</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/"><span class="tag">逆向工程</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9D%A2%E8%AF%95/"><span class="tag">面试</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="http://www.itboyhub.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">江南一点雨-国内站(速度快)</span></span><span class="level-right"><span class="level-item tag">www.itboyhub.com</span></span></a></li><li><a class="level is-mobile" href="http://www.ityouknow.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">纯洁的微笑</span></span><span class="level-right"><span class="level-item tag">www.ityouknow.com</span></span></a></li><li><a class="level is-mobile" href="http://cxy521.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">程序员一站式导航</span></span><span class="level-right"><span class="level-item tag">cxy521.com</span></span></a></li><li><a class="level is-mobile" href="https://bugstack.cn" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">bugstack虫洞栈</span></span><span class="level-right"><span class="level-item tag">bugstack.cn</span></span></a></li><li><a class="level is-mobile" href="http://www.itwanger.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">沉默王二</span></span><span class="level-right"><span class="level-item tag">www.itwanger.com</span></span></a></li><li><a class="level is-mobile" href="https://tanqingbo.cn" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">IT码农</span></span><span class="level-right"><span class="level-item tag">tanqingbo.cn</span></span></a></li><li><a class="level is-mobile" href="https://www.cxyxiaowu.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">五分钟学算法</span></span><span class="level-right"><span class="level-item tag">www.cxyxiaowu.com</span></span></a></li><li><a class="level is-mobile" href="http://www.justdojava.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Java 极客技术</span></span><span class="level-right"><span class="level-item tag">www.justdojava.com</span></span></a></li><li><a class="level is-mobile" href="http://cxytiandi.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">猿天地</span></span><span class="level-right"><span class="level-item tag">cxytiandi.com</span></span></a></li><li><a class="level is-mobile" href="https://vimjc.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Vim教程网</span></span><span class="level-right"><span class="level-item tag">vimjc.com</span></span></a></li><li><a class="level is-mobile" href="http://muggle.javaboy.org/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">muggle</span></span><span class="level-right"><span class="level-item tag">muggle.javaboy.org</span></span></a></li><li><a class="level is-mobile" href="https://crossoverjie.top/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">crossoverJie&#039;s Blog</span></span><span class="level-right"><span class="level-item tag">crossoverjie.top</span></span></a></li><li><a class="level is-mobile" href="http://cmsblogs.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Java 技术驿站</span></span><span class="level-right"><span class="level-item tag">cmsblogs.com</span></span></a></li><li><a class="level is-mobile" href="https://maizitoday.github.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">麦子的博客</span></span><span class="level-right"><span class="level-item tag">maizitoday.github.io</span></span></a></li><li><a class="level is-mobile" href="http://www.haoservice.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">码农code之路</span></span><span class="level-right"><span class="level-item tag">www.haoservice.cn</span></span></a></li><li><a class="level is-mobile" href="https://www.jitwxs.cn" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Jitwxs</span></span><span class="level-right"><span class="level-item tag">www.jitwxs.cn</span></span></a></li><li><a class="level is-mobile" href="http://www.gameboys.cn" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Java 烂笔头</span></span><span class="level-right"><span class="level-item tag">www.gameboys.cn</span></span></a></li><li><a class="level is-mobile" href="https://www.a2data.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">A2Data</span></span><span class="level-right"><span class="level-item tag">www.a2data.cn</span></span></a></li><li><a class="level is-mobile" href="https://www.itechyou.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">I Tech You, 我教你！</span></span><span class="level-right"><span class="level-item tag">www.itechyou.cn</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="http://img.itboyhub.com/2024/mp/20241218191201.png" alt="江南一点雨" height="28"></a><p class="is-size-7"><span>&copy; 2024 江南一点雨</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>