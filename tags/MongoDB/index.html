<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
<title>标签: MongoDB - 江南一点雨</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



    <meta name="description" content="Spring Boot,SpringBoot,SpringCloud,Spring Cloud,微服务,Spring Boot 学习资料，Spring, Spring Boot, 导航,Spring Boot 开源项目,Spring Cloud学习资料,Spring, Spring Cloud, 导航,Spring Cloud 开源项目">
<meta name="keywords" content="Spring Boot,SpringBoot,SpringCloud,Spring Cloud,微服务,Spring Boot 学习资料，Spring, Spring Boot, 导航,Spring Boot 开源项目,Spring Cloud学习资料,Spring, Spring Cloud, 导航,Spring Cloud 开源项目">
<meta property="og:type" content="website">
<meta property="og:title" content="江南一点雨">
<meta property="og:url" content="http://www.javaboy.org/tags/MongoDB/index.html">
<meta property="og:site_name" content="江南一点雨">
<meta property="og:description" content="Spring Boot,SpringBoot,SpringCloud,Spring Cloud,微服务,Spring Boot 学习资料，Spring, Spring Boot, 导航,Spring Boot 开源项目,Spring Cloud学习资料,Spring, Spring Cloud, 导航,Spring Cloud 开源项目">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://www.javaboy.org/images/og_image.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="江南一点雨">
<meta name="twitter:description" content="Spring Boot,SpringBoot,SpringCloud,Spring Cloud,微服务,Spring Boot 学习资料，Spring, Spring Boot, 导航,Spring Boot 开源项目,Spring Cloud学习资料,Spring, Spring Cloud, 导航,Spring Cloud 开源项目">
<meta name="twitter:image" content="http://www.javaboy.org/images/og_image.png">







<link rel="icon" href="https://www.javaboy.org/favicon.ico">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
                
                <img src="https://www.javaboy.org/images/sb/javaboy.jpg" alt="江南一点雨" height="28">
                
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">江南一点雨</a>
                
                <a class="navbar-item" href="/archives">归档</a>
                
                <a class="navbar-item" href="/fronted-backend">前后端分离</a>
                
                <a class="navbar-item" href="http://springboot.javaboy.org">Spring Boot</a>
                
                <a class="navbar-item" href="/redis">Redis</a>
                
                <a class="navbar-item" href="/mysql">MySQL</a>
                
                <a class="navbar-item" href="/docker">Docker</a>
                
                <a class="navbar-item" href="/git">Git</a>
                
                <a class="navbar-item" href="/about">About</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                
                <a class="navbar-item search" style="height: 40px;line-height: 60px;width: 180px;margin: 12px 15px;box-sizing: border-box;border: 1px solid #dedede;border-radius: 20px;display: flex;justify-content: space-between;padding-left: 12px;padding-right: 10px" title="搜索" href="javascript:;">
                    <!--<div style="border: 1px solid #dedede;border-radius: 10px;">-->
                    <div>搜索</div>
                        <i class="fas fa-search"></i>
                    <!--</div>-->
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-9-desktop is-6-widescreen has-order-2 column-main"><div class="card">
    <div class="card-content">
        <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li><a href="/tags">标签</a></li>
            <li class="is-active"><a href="#" aria-current="page">MongoDB</a></li>
        </ul>
        </nav>
    </div>
</div>

    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-09-19T02:17:28.000Z">2019-09-19</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/MongoDB/">MongoDB</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 分钟 读完 (大约 1050 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/0919/mongodb-in-java.html">Java 操作 MongoDB</a>
            
        </h1>
        <div class="content">
            <p>之前我们介绍的 MongoDB 的操作都是在 shell 命令中写的，在项目开发时我们当然都是用程序去操作 MongoDB 的，本文我们来看看如何用 Java 代码操作 MongoDB。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>首先我们需要驱动，MongoDB 的 Java 驱动我们可以直接在 Maven 中央仓库去下载，也可以创建 Maven 工程添加如下依赖：</p>
<figure class="highlight xml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mongodb-driver<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>建议通过 Maven 来添加依赖，如果自己下载 jar，需要下载如下三个 jar：</p>
<blockquote>
<ol>
<li>org.mongodb:bson:jar:3.5.0</li>
<li>org.mongodb:mongodb-driver-core:jar:3.5.0</li>
<li>org.mongodb:mongodb-driver:jar:3.5.0</li>
</ol>
</blockquote>
<p>另外，在使用 Java 操作 MongoDB 之前，记得启动 MongoDB 哦~</p>
<h2 id="获取集合"><a href="#获取集合" class="headerlink" title="获取集合"></a>获取集合</h2><p>所有准备工作完成之后，我们首先需要一个 MongoClient，如下：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MongoClient client = <span class="hljs-keyword">new</span> MongoClient(<span class="hljs-string">"192.168.248.136"</span>, <span class="hljs-number">27017</span>);</span><br></pre></td></tr></table></figure>
<p>然后通过如下方式获取一个数据库，如果要获取的数据库本身就存在，直接获取到，不存在 MongoDB 会自动创建：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MongoDatabase sang = client.getDatabase(<span class="hljs-string">"sang"</span>);</span><br></pre></td></tr></table></figure>
<p>然后通过如下方式获取一个名为c1的集合，这个集合存在的话就直接获取到，不存在的话 MongoDB 会自动创建出来，如下：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MongoCollection&lt;Document&gt; c = sang.getCollection(<span class="hljs-string">"c1"</span>);</span><br></pre></td></tr></table></figure>
<p>有了集合之后，我们就可以向集合中插入数据了。</p>
<h2 id="增"><a href="#增" class="headerlink" title="增"></a>增</h2><p>和在 shell 中的操作一样，我们可以一条一条的添加数据，也可以批量添加，添加单条数据操作如下：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Document d1 = <span class="hljs-keyword">new</span> Document();</span><br><span class="line">d1.append(<span class="hljs-string">"name"</span>, <span class="hljs-string">"三国演义"</span>).append(<span class="hljs-string">"author"</span>, <span class="hljs-string">"罗贯中"</span>);</span><br><span class="line">c.insertOne(d1);</span><br></pre></td></tr></table></figure>
<p>添加多条数据的操作如下：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Document&gt; collections = <span class="hljs-keyword">new</span> ArrayList&lt;Document&gt;();</span><br><span class="line">Document d1 = <span class="hljs-keyword">new</span> Document();</span><br><span class="line">d1.append(<span class="hljs-string">"name"</span>, <span class="hljs-string">"三国演义"</span>).append(<span class="hljs-string">"author"</span>, <span class="hljs-string">"罗贯中"</span>);</span><br><span class="line">collections.add(d1);</span><br><span class="line">Document d2 = <span class="hljs-keyword">new</span> Document();</span><br><span class="line">d2.append(<span class="hljs-string">"name"</span>, <span class="hljs-string">"红楼梦"</span>).append(<span class="hljs-string">"author"</span>, <span class="hljs-string">"曹雪芹"</span>);</span><br><span class="line">collections.add(d2);</span><br><span class="line">c.insertMany(collections);</span><br></pre></td></tr></table></figure>
<h2 id="改"><a href="#改" class="headerlink" title="改"></a>改</h2><p>可以修改查到的第一条数据，操作如下：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.updateOne(Filters.eq(<span class="hljs-string">"author"</span>, <span class="hljs-string">"罗贯中"</span>), <span class="hljs-keyword">new</span> Document(<span class="hljs-string">"$set"</span>, <span class="hljs-keyword">new</span> Document(<span class="hljs-string">"name"</span>, <span class="hljs-string">"三国演义123"</span>)));</span><br></pre></td></tr></table></figure>
<p>上例中小伙伴们也看到了修改器要如何使用，不管是 $set 还是 $inc，用法都一致，我这里不再一个一个演示。也可以修改查到的所有数据，如下：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.updateMany(Filters.eq(<span class="hljs-string">"author"</span>, <span class="hljs-string">"罗贯中"</span>), <span class="hljs-keyword">new</span> Document(<span class="hljs-string">"$set"</span>, <span class="hljs-keyword">new</span> Document(<span class="hljs-string">"name"</span>, <span class="hljs-string">"三国演义456"</span>)));</span><br></pre></td></tr></table></figure>
<h2 id="删"><a href="#删" class="headerlink" title="删"></a>删</h2><p>可以删除查到的一条数据，如下：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.deleteOne(Filters.eq(<span class="hljs-string">"author"</span>, <span class="hljs-string">"罗贯中"</span>));</span><br></pre></td></tr></table></figure>
<p>也可以删除查到的所有数据：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.deleteMany(Filters.eq(<span class="hljs-string">"author"</span>, <span class="hljs-string">"罗贯中"</span>));</span><br></pre></td></tr></table></figure>
<p>Filters 里边还有其他的查询条件，都是见名知意，不赘述。</p>
<h2 id="查"><a href="#查" class="headerlink" title="查"></a>查</h2><p>可以直接查询所有文档：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FindIterable&lt;Document&gt; documents = c.find();</span><br><span class="line">MongoCursor&lt;Document&gt; iterator = documents.iterator();</span><br><span class="line"><span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    System.out.println(iterator.next());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以按照条件查询：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FindIterable&lt;Document&gt; documents = c.find(Filters.eq(<span class="hljs-string">"author"</span>, <span class="hljs-string">"罗贯中"</span>));</span><br><span class="line">MongoCursor&lt;Document&gt; iterator = documents.iterator();</span><br><span class="line"><span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    System.out.println(iterator.next());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他的方法基本都是见名知意，这里不再赘述。</p>
<h2 id="验证问题"><a href="#验证问题" class="headerlink" title="验证问题"></a>验证问题</h2><p>上面我们演示的获取一个集合是不需要登录 MongoDB 数据库的，如果需要登录，我们获取集合的方式改为下面这种：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ServerAddress serverAddress = <span class="hljs-keyword">new</span> ServerAddress(<span class="hljs-string">"192.168.248.128"</span>, <span class="hljs-number">27017</span>);</span><br><span class="line">List&lt;MongoCredential&gt; credentialsList = <span class="hljs-keyword">new</span> ArrayList&lt;MongoCredential&gt;();</span><br><span class="line">MongoCredential mc = MongoCredential.createScramSha1Credential(<span class="hljs-string">"readuser"</span>,<span class="hljs-string">"sang"</span>,<span class="hljs-string">"123"</span>.toCharArray());</span><br><span class="line">credentialsList.add(mc);</span><br><span class="line">MongoClient client = <span class="hljs-keyword">new</span> MongoClient(serverAddress,credentialsList);</span><br><span class="line">MongoDatabase sang = client.getDatabase(<span class="hljs-string">"sang"</span>);</span><br><span class="line">c = sang.getCollection(<span class="hljs-string">"c1"</span>);</span><br></pre></td></tr></table></figure>
<p>MongoCredential 是一个凭证，第一个参数为用户名，第二个参数是要在哪个数据库中验证，第三个参数是密码的 char 数组，然后将登录地址封装成一个 ServerAddress，最后将两个参数都传入 MongoClient 中实现登录功能。</p>
<h2 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h2><p>在连接数据库的时候也可以设置连接超时等信息，在MongoClientOptions中设置即可，设置方式如下：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ServerAddress serverAddress = <span class="hljs-keyword">new</span> ServerAddress(<span class="hljs-string">"192.168.248.128"</span>, <span class="hljs-number">27017</span>);</span><br><span class="line">List&lt;MongoCredential&gt; credentialsList = <span class="hljs-keyword">new</span> ArrayList&lt;MongoCredential&gt;();</span><br><span class="line">MongoCredential mc = MongoCredential.createScramSha1Credential(<span class="hljs-string">"rwuser"</span>,<span class="hljs-string">"sang"</span>,<span class="hljs-string">"123"</span>.toCharArray());</span><br><span class="line">credentialsList.add(mc);</span><br><span class="line">MongoClientOptions options = MongoClientOptions.builder()</span><br><span class="line">        <span class="hljs-comment">//设置连接超时时间为10s</span></span><br><span class="line">        .connectTimeout(<span class="hljs-number">1000</span>*<span class="hljs-number">10</span>)</span><br><span class="line">        <span class="hljs-comment">//设置最长等待时间为10s</span></span><br><span class="line">        .maxWaitTime(<span class="hljs-number">1000</span>*<span class="hljs-number">10</span>)</span><br><span class="line">        .build();</span><br><span class="line">MongoClient client = <span class="hljs-keyword">new</span> MongoClient(serverAddress,credentialsList,options);</span><br><span class="line">MongoDatabase sang = client.getDatabase(<span class="hljs-string">"sang"</span>);</span><br><span class="line">c = sang.getCollection(<span class="hljs-string">"c1"</span>);</span><br></pre></td></tr></table></figure>
<p>好了，Java 操作 MongoDB 我们就先说到这里，小伙伴们有问题欢迎留言讨论。</p>
<p>参考资料：</p>
<ol>
<li>《MongoDB权威指南第2版》 </li>
</ol>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-09-18T02:17:28.000Z">2019-09-18</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/MongoDB/">MongoDB</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    13 分钟 读完 (大约 1898 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/0918/mongodb-shard.html">初识 MongoDB 分片</a>
            
        </h1>
        <div class="content">
            <p>分片是指将数据拆分，拆分后存放在不同的机器上的过程，以此来降低单个服务器的压力，同时也解决单个服务器硬盘空间不足的问题，让我们可以用廉价的机器实现高性能的数据架构。有的小伙伴不理解分片和副本集的差异，一言以蔽之：副本集上每个备份节点存储的数据都是相同的，分片上存储的数据则是不同的。好了，本文我们就先来看看分片环境的搭建。</p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>准备三台已经装好了 MongoDB 的服务器，地址分别是：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.248.128</span><br><span class="line">192.168.248.135</span><br><span class="line">192.168.248.136</span><br></pre></td></tr></table></figure>
<p>本文使用的 MongoDB 版本为 3.4.9</p>
<h2 id="规划"><a href="#规划" class="headerlink" title="规划"></a>规划</h2><p>首先我们需要三台配置服务器，配置服务器相当于集群的大脑，配置服务器中保存着集群和分片的元数据，即每个分片都包含了哪些数据信息，这些数据都是保存在配置服务器中的，我这里将开启三个配置服务器实例，这三个配置服务器将运行在三个 MongoDB 服务器上，地址分别如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.248.128:20000</span><br><span class="line">192.168.248.135:20000</span><br><span class="line">192.168.248.136:20000</span><br></pre></td></tr></table></figure>
<p>接下来需要一个 Mongos 实例，Mongos 对请求进行路由，Mongos 扮演的角色有点类似于一个门面，我们以后访问的时候，直接访问 Mongos 即可，再由 Mongos 将请求路由到不同的分片上去，Mongos 在启动时会去访问配置服务器，它将从配置服务器中获取数据的存储信息，Mongos 我将启动在如下服务器上：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.248.128:30000</span><br></pre></td></tr></table></figure>
<p>最后需要三个分片实例，三个分片依然运行在三台服务器上，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.248.128:27017</span><br><span class="line">192.168.248.135:27017</span><br><span class="line">192.168.248.136:27017</span><br></pre></td></tr></table></figure>
<h2 id="搭建配置服务器"><a href="#搭建配置服务器" class="headerlink" title="搭建配置服务器"></a>搭建配置服务器</h2><p>配置服务器中不需要太多的空间和资源，因为配置服务器上保存的只是数据的分布表，不保存具体的数据，具体的数据都保存在分片上，配置服务器中 1KB 的空间约为 200MB 的真实数据。<strong>注意，从 MongoDB3.4 开始，配置服务器要做成集群的方式。</strong></p>
<p>由于配置服务器是独立的 mongod 进程，所以我们可以像启动普通的 MongoDB 服务一样启动配置服务器，只是这里的配置不同罢了。</p>
<p>我这里以 <code>192.168.248.128</code> 服务器为例来讲述配置服务器的配置启动，另外两台服务器如法炮制即可：</p>
<ol>
<li>在 mongodb 解压目录下创建 db20000 文件夹，用来存储配置服务器中的数据。</li>
<li>复制一份 mongodb.conf，命名为 mongodb20000.conf，修改文件内容如下：</li>
</ol>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dbpath=/opt/mongodb/db20000</span><br><span class="line">logpath=/opt/mongodb/logs/mongodb20000.log</span><br><span class="line">port=20000</span><br><span class="line">fork=true</span><br><span class="line">configsvr=true</span><br><span class="line">replSet=rs</span><br></pre></td></tr></table></figure>
<p>注意 dbpath 改为我们第一步创建的目录，端口号改为 20000 （这个随意，只要该端口没被占用即可）， configsvr 表示这是一个配置服务器，另外由于我们的配置服务器要做成备份集，所以要设置 replSet。</p>
<p>3.做好前两步之后，执行如下命令启动配置服务器：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod -f /opt/mongodb/bin/mongodb20000.conf</span><br></pre></td></tr></table></figure>
<p>最后，在另外两台服务器上重复上面三个步骤。</p>
<p>三台服务器上都启动成功之后，参考我们之前的<a href>MongoDB 副本集搭建</a>一文，将这三台配置服务器配成一个副本集，副本集的配置我这里就不再赘述。</p>
<h2 id="搭建Mongos"><a href="#搭建Mongos" class="headerlink" title="搭建Mongos"></a>搭建Mongos</h2><p>Mongos 实例我们可以启动在任意一台服务器上，我这里就启动在 <code>192.168.248.128</code>上，Mongos 的配置步骤如下：</p>
<p>1.复制一份 mongodb.conf，命名为 mongos.conf，修改内容：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">logpath=/opt/mongodb/logs/mongos.log</span><br><span class="line">port=30000</span><br><span class="line">fork=true</span><br><span class="line">configdb=rs/192.168.248.128:20000,192.168.248.135:20000,192.168.248.136:20000</span><br></pre></td></tr></table></figure>
<p>因为 mongos 中不需要保存数据，所以不需要 dbpath，端口号改为 30000，configdb 表示三个配置服务器的地址，注意最前面的 rs 表示配置服务器副本集的名称。</p>
<p>2.配置完成后，执行如下命令启动 mongos:</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongos -f /opt/mongodb/bin/mongos.conf</span><br></pre></td></tr></table></figure>
<h2 id="搭建三个分片"><a href="#搭建三个分片" class="headerlink" title="搭建三个分片"></a>搭建三个分片</h2><p>三个分片实际上就是三个普通的 MongoDB 服务器，给大家看下我的配置文件：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dbpath=/opt/mongodb/db</span><br><span class="line">logpath=/opt/mongodb/logs/mongodb.log</span><br><span class="line">port=27017</span><br><span class="line">fork=true</span><br><span class="line">shardsvr=true</span><br></pre></td></tr></table></figure>
<p>注意多了个 shardsvr 表示这是一个分片服务器。<br>然后在三台服务器上分别执行如下命令启动分片：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod -f /opt/mongodb/bin/mongodb.conf</span><br></pre></td></tr></table></figure>
<h2 id="添加分片"><a href="#添加分片" class="headerlink" title="添加分片"></a>添加分片</h2><p>上面三个步骤完成之后，我们就进入到 mongos 的 shell 命令行了，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --port=30000</span><br></pre></td></tr></table></figure>
<p>然后我们可以通过如下命令查看一下分片的当前状态：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh.status()</span><br></pre></td></tr></table></figure>
<p>执行结果如下(部分)：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--- Sharding Status ---</span><br><span class="line">  sharding version: &#123;</span><br><span class="line">&#125;</span><br><span class="line">  shards:</span><br><span class="line">  databases:</span><br></pre></td></tr></table></figure>
<p>shards 表示分片服务器，目前还没有，databases 表示分片的库，目前也还没有，接下来我们通过如下命令添加分片服务器：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sh.addShard(&quot;192.168.248.128:27017&quot;)</span><br><span class="line">sh.addShard(&quot;192.168.248.135:27017&quot;)</span><br><span class="line">sh.addShard(&quot;192.168.248.136:27017&quot;)</span><br></pre></td></tr></table></figure>
<p>添加三个分片服务器，然后再执行 <code>sh.status()</code>,结果如下(部分)：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--- Sharding Status ---</span><br><span class="line">  sharding version: &#123;</span><br><span class="line">&#125;</span><br><span class="line">  shards:</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard0000&quot;,  &quot;host&quot; : &quot;192.168.248.128:27017&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard0001&quot;,  &quot;host&quot; : &quot;192.168.248.135:27017&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard0002&quot;,  &quot;host&quot; : &quot;192.168.248.136:27017&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">  databases:</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;test&quot;,  &quot;primary&quot; : &quot;shard0000&quot;,  &quot;partitioned&quot; : false &#125;</span><br></pre></td></tr></table></figure>
<h2 id="设置集合分片"><a href="#设置集合分片" class="headerlink" title="设置集合分片"></a>设置集合分片</h2><p>接下来我们来设置集合的分片，首先执行如下命令表示给某个数据库分片：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh.enableSharding(&quot;sang&quot;)</span><br></pre></td></tr></table></figure>
<p>对集合分片时，需要选择一个片键，片键实际上就是集合中的一个键，MongoDB 将根据这个片键来拆分数据，我们需要先对片键建立索引，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.c1.ensureIndex(&#123;x:1&#125;)</span><br></pre></td></tr></table></figure>
<p>然后以 x 为片键，对 c1 集合进行分片，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh.shardCollection(&quot;sang.c1&quot;,&#123;x:1&#125;)</span><br></pre></td></tr></table></figure>
<p>做完这些之后，再执行 <code>sh.status()</code> 命令，查看目前状态，结果如下(部分)：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">--- Sharding Status ---</span><br><span class="line">  sharding version: &#123;</span><br><span class="line">&#125;</span><br><span class="line">  shards:</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard0000&quot;,  &quot;host&quot; : &quot;192.168.248.128:27017&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard0001&quot;,  &quot;host&quot; : &quot;192.168.248.135:27017&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;shard0002&quot;,  &quot;host&quot; : &quot;192.168.248.136:27017&quot;,  &quot;state&quot; : 1 &#125;</span><br><span class="line">  databases:</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;test&quot;,  &quot;primary&quot; : &quot;shard0000&quot;,  &quot;partitioned&quot; : false &#125;</span><br><span class="line">        &#123;  &quot;_id&quot; : &quot;sang&quot;,  &quot;primary&quot; : &quot;shard0001&quot;,  &quot;partitioned&quot; : true &#125;</span><br><span class="line">                sang.c1</span><br><span class="line">                        shard key: &#123; &quot;x&quot; : 1 &#125;</span><br><span class="line">                        unique: false</span><br><span class="line">                        balancing: true</span><br><span class="line">                        chunks:</span><br><span class="line">                                shard0001       1</span><br><span class="line">                        &#123; &quot;x&quot; : &#123; &quot;$minKey&quot; : 1 &#125; &#125; --&gt;&gt; &#123; &quot;x&quot; : &#123; &quot;$maxKey&quot; : 1 &#125; &#125; on : shard0001 Timestamp(1, 0)</span><br></pre></td></tr></table></figure>
<p>做完上面这些之后，我们再做两个操作：</p>
<p>1.设置自动分片：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh.setBalancerState(true)</span><br></pre></td></tr></table></figure>
<p>2.设置 chunksize,chunksize 这一项是用来指定 chunk 的大小的，为了方便测试分片效果，我们把 chunksize 指定为 1MB，即当这个分片中插入的数据大于 1M 时开始进行数据分片</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.settings.save(&#123;_id:&quot;chunksize&quot;,value:1&#125;)</span><br></pre></td></tr></table></figure>
<p>OK，做好这些之后，大功告成。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>测试方式很简单，我们直接在 mongos 的命令行向 sang 的 c1 集合中插入 50000 条数据，然后再查看这些数据的分布，就知道分片有没有成功了：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for(var i=0;i&lt;50000;i++)&#123;db.c1.insert(&#123;x:Math.random()*1000000,name:&quot;hahah&quot;+i&#125;)&#125;</span><br></pre></td></tr></table></figure>
<p>然后执行 <code>db.c1.stats()</code> ,结果如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="hljs-attr">"sharded"</span> : <span class="hljs-literal">true</span>,</span><br><span class="line"><span class="hljs-attr">"capped"</span> : <span class="hljs-literal">false</span>,</span><br><span class="line"><span class="hljs-attr">"ns"</span> : <span class="hljs-string">"sang.c1"</span>,</span><br><span class="line"><span class="hljs-attr">"count"</span> : <span class="hljs-number">50000</span>,</span><br><span class="line"><span class="hljs-attr">"size"</span> : <span class="hljs-number">2688890</span>,</span><br><span class="line"><span class="hljs-attr">"storageSize"</span> : <span class="hljs-number">1781760</span>,</span><br><span class="line"><span class="hljs-attr">"totalIndexSize"</span> : <span class="hljs-number">1978368</span>,</span><br><span class="line"><span class="hljs-attr">"avgObjSize"</span> : <span class="hljs-number">53</span>,</span><br><span class="line"><span class="hljs-attr">"nindexes"</span> : <span class="hljs-number">2</span>,</span><br><span class="line"><span class="hljs-attr">"nchunks"</span> : <span class="hljs-number">5</span>,</span><br><span class="line"><span class="hljs-attr">"shards"</span> : &#123;</span><br><span class="line">		<span class="hljs-attr">"shard0000"</span> : &#123;</span><br><span class="line">				<span class="hljs-attr">"ns"</span> : <span class="hljs-string">"sang.c1"</span>,</span><br><span class="line">				<span class="hljs-attr">"size"</span> : <span class="hljs-number">926504</span>,</span><br><span class="line">				<span class="hljs-attr">"count"</span> : <span class="hljs-number">17229</span>,</span><br><span class="line">				<span class="hljs-attr">"avgObjSize"</span> : <span class="hljs-number">53</span>,</span><br><span class="line">				<span class="hljs-attr">"storageSize"</span> : <span class="hljs-number">462848</span>,</span><br><span class="line">				<span class="hljs-attr">"capped"</span> : <span class="hljs-literal">false</span>,</span><br><span class="line">				<span class="hljs-attr">"nindexes"</span> : <span class="hljs-number">2</span>,</span><br><span class="line">				<span class="hljs-attr">"totalIndexSize"</span> : <span class="hljs-number">516096</span>,</span><br><span class="line">				<span class="hljs-attr">"indexSizes"</span> : &#123;</span><br><span class="line">						<span class="hljs-attr">"_id_"</span> : <span class="hljs-number">184320</span>,</span><br><span class="line">						<span class="hljs-attr">"x_1"</span> : <span class="hljs-number">331776</span></span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="hljs-attr">"ok"</span> : <span class="hljs-number">1</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="hljs-attr">"shard0001"</span> : &#123;</span><br><span class="line">				<span class="hljs-attr">"ns"</span> : <span class="hljs-string">"sang.c1"</span>,</span><br><span class="line">				<span class="hljs-attr">"size"</span> : <span class="hljs-number">392593</span>,</span><br><span class="line">				<span class="hljs-attr">"count"</span> : <span class="hljs-number">7299</span>,</span><br><span class="line">				<span class="hljs-attr">"avgObjSize"</span> : <span class="hljs-number">53</span>,</span><br><span class="line">				<span class="hljs-attr">"storageSize"</span> : <span class="hljs-number">667648</span>,</span><br><span class="line">				<span class="hljs-attr">"capped"</span> : <span class="hljs-literal">false</span>,</span><br><span class="line">				<span class="hljs-attr">"nindexes"</span> : <span class="hljs-number">2</span>,</span><br><span class="line">				<span class="hljs-attr">"totalIndexSize"</span> : <span class="hljs-number">737280</span>,</span><br><span class="line">				<span class="hljs-attr">"indexSizes"</span> : &#123;</span><br><span class="line">						<span class="hljs-attr">"_id_"</span> : <span class="hljs-number">253952</span>,</span><br><span class="line">						<span class="hljs-attr">"x_1"</span> : <span class="hljs-number">483328</span></span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="hljs-attr">"ok"</span> : <span class="hljs-number">1</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="hljs-attr">"shard0002"</span> : &#123;</span><br><span class="line">				<span class="hljs-attr">"ns"</span> : <span class="hljs-string">"sang.c1"</span>,</span><br><span class="line">				<span class="hljs-attr">"size"</span> : <span class="hljs-number">1369793</span>,</span><br><span class="line">				<span class="hljs-attr">"count"</span> : <span class="hljs-number">25472</span>,</span><br><span class="line">				<span class="hljs-attr">"avgObjSize"</span> : <span class="hljs-number">53</span>,</span><br><span class="line">				<span class="hljs-attr">"storageSize"</span> : <span class="hljs-number">651264</span>,</span><br><span class="line">				<span class="hljs-attr">"capped"</span> : <span class="hljs-literal">false</span>,</span><br><span class="line">				<span class="hljs-attr">"nindexes"</span> : <span class="hljs-number">2</span>,</span><br><span class="line">				<span class="hljs-attr">"totalIndexSize"</span> : <span class="hljs-number">724992</span>,</span><br><span class="line">				<span class="hljs-attr">"indexSizes"</span> : &#123;</span><br><span class="line">						<span class="hljs-attr">"_id_"</span> : <span class="hljs-number">237568</span>,</span><br><span class="line">						<span class="hljs-attr">"x_1"</span> : <span class="hljs-number">487424</span></span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="hljs-attr">"ok"</span> : <span class="hljs-number">1</span></span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OK，看到如上结果，说明我们的数据已经分布在三个分片服务器中了。</p>
<p>好了，MongoDB 中分片环境的搭建我们就先说到这里，小伙伴们有问题欢迎留言讨论。<br>参考资料：</p>
<ol>
<li>《MongoDB权威指南第2版》 </li>
</ol>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-09-17T02:17:28.000Z">2019-09-17</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/MongoDB/">MongoDB</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    9 分钟 读完 (大约 1424 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/0917/mongodb-replicaset-details.html">MongoDB副本集其他细节</a>
            
        </h1>
        <div class="content">
            <p>副本集环境的搭建以及一些基本的操作我们都了解了，本文我们来看看这个数据复制到底是怎么实现的。</p>
<h2 id="数据同步方式"><a href="#数据同步方式" class="headerlink" title="数据同步方式"></a>数据同步方式</h2><p>MongoDB 中的复制功能主要是使用操作日志 oplog.rs 来实现的，oplog.rs 包含了主节点的每一次写操作，oplog.rs 是主节点中 local 数据库的一个固定集合，我们可以通过如下命令查看到：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use local</span><br><span class="line">show tables</span><br></pre></td></tr></table></figure>
<p>如下：</p>
<p><img src="https://www.javaboy.org/images/mongodb/17-1.png" alt="p254"></p>
<p>备份节点通过查询这个集合就知道要复制哪些数据，同时，每一个备份节点也都维护着自己的 oplog.rs，自己的 oplog.rs 则用来记录每一次从主节点复制数据的操作，如此，每一个备份节点都可以再作为数据源提供给其他成员使用，如果某一个备份节点在使用的过程中挂掉了，那么当它重启之后，会自动从 oplog.rs 的最后一个操作开始同步。</p>
<p>上文我们也已经说过 oplog.rs 是一个固定集合，我们可以通过 <code>db.getCollection(&#39;oplog.rs&#39;).stats()</code> 这个命令来查看这个固定集合的属性，包括集合大小等，执行部分结果如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"ns"</span> : <span class="hljs-string">"local.oplog.rs"</span>,</span><br><span class="line">    <span class="hljs-attr">"size"</span> : <span class="hljs-number">18170305</span>,</span><br><span class="line">    <span class="hljs-attr">"count"</span> : <span class="hljs-number">177443</span>,</span><br><span class="line">    <span class="hljs-attr">"avgObjSize"</span> : <span class="hljs-number">102</span>,</span><br><span class="line">    <span class="hljs-attr">"storageSize"</span> : <span class="hljs-number">5902336</span>,</span><br><span class="line">    <span class="hljs-attr">"capped"</span> : <span class="hljs-literal">true</span>,</span><br><span class="line">    <span class="hljs-attr">"max"</span> : <span class="hljs-number">-1</span>,</span><br><span class="line">    <span class="hljs-attr">"maxSize"</span> : <span class="hljs-number">1038090240</span>,</span><br><span class="line">    <span class="hljs-attr">"sleepCount"</span> : <span class="hljs-number">0</span>,</span><br><span class="line">    <span class="hljs-attr">"sleepMS"</span> : <span class="hljs-number">0</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然是固定集合，它里边能够保存的数据大小就是有限的。通常，oplog.rs 使用空间的增长速度与系统处理处理写请求的速率近乎相同，比如主节点每分钟处理了 1KB 的写入请求，那么 oplog.rs 也可能会在一分钟内写入 1KB 条操作日志，但是如果主节点执行了批量删除的命令，比如下面这种：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.c1.deleteMany(&#123;x:&#123;$type:1&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>此时每一个受影响的文档都会产生一条 oplog 中的日志，这个时候 oplog.rs 中的日志会快速增加。</p>
<h2 id="成员状态"><a href="#成员状态" class="headerlink" title="成员状态"></a>成员状态</h2><p>到目前为止我们了解到的成员状态有两种，一个是 PRIMARY ，还有一个是 SECONDDARY ，成员状态的获取需要靠心跳来维护，副本集中的每一个成员每隔两秒就会向其他成员发送一个心跳请求，用来检查成员的状态，成员的状态主要有如下几种：</p>
<h4 id="STARTUP"><a href="#STARTUP" class="headerlink" title="STARTUP"></a>STARTUP</h4><p>副本集中的成员刚刚启动时处于这个状态下，此时，MongoDB 会去加载成员的副本集配置，配置加载成功之后，就进入到 STARTUP2 的状态。</p>
<h4 id="STARTUP2"><a href="#STARTUP2" class="headerlink" title="STARTUP2"></a>STARTUP2</h4><p>整个初始化同步过程都处于这个状态。</p>
<h4 id="RECOVERING"><a href="#RECOVERING" class="headerlink" title="RECOVERING"></a>RECOVERING</h4><p>这个状态是由 STARTUP2 状态来的，此时成员运转正常，但是此时还不能处理读取请求。</p>
<h4 id="ARBITER"><a href="#ARBITER" class="headerlink" title="ARBITER"></a>ARBITER</h4><p>这是仲裁者所处的状态。</p>
<h4 id="DOWN"><a href="#DOWN" class="headerlink" title="DOWN"></a>DOWN</h4><p>当一个原本运行正常的成员无法访问到时，该成员就处于 DOWN 的状态。</p>
<h4 id="UNKNOWN"><a href="#UNKNOWN" class="headerlink" title="UNKNOWN"></a>UNKNOWN</h4><p>如果一个成员无法到达其他任何成员，该成员就处于 UNKNOWN 状态，比如我们利用 rs.add() 方法添加一个不存在的成员，这个成员的状态就是 UNKNOWN。</p>
<h4 id="REMOVED"><a href="#REMOVED" class="headerlink" title="REMOVED"></a>REMOVED</h4><p>成员被从副本集中移除时就变成这个状态。</p>
<h4 id="ROLLBACK"><a href="#ROLLBACK" class="headerlink" title="ROLLBACK"></a>ROLLBACK</h4><p>如果成员正在进行数据回滚，它就处于 ROLLBACK 状态，回滚结束后会转换为 RECOVERING 状态。</p>
<h4 id="FATAL"><a href="#FATAL" class="headerlink" title="FATAL"></a>FATAL</h4><p>当一个成员发生了不可挽回的错误时，且不再尝试恢复正常的话，就处于这个状态。</p>
<h2 id="主节点转备份节点"><a href="#主节点转备份节点" class="headerlink" title="主节点转备份节点"></a>主节点转备份节点</h2><p>通过如下命令可以让主节点转为备份节点：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.stepDown()</span><br></pre></td></tr></table></figure>
<p>主节点转为备份节点之后会有新的主节点被选举出来，可以通过 rs.status() 来查看新的主节点。</p>
<h2 id="rs-status-方法"><a href="#rs-status-方法" class="headerlink" title="rs.status()方法"></a>rs.status()方法</h2><p>前面我们已经多次使用过 rs.status() 方法， rs.status() 方法会列出每个备份节点的含义，我们来看看这些参数的含义，先来列出一个 rs.status() 方法的返回值样例：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;members&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;_id&quot; : 1,</span><br><span class="line">        &quot;name&quot; : &quot;192.168.248.135:27017&quot;,</span><br><span class="line">        &quot;health&quot; : 1,</span><br><span class="line">        &quot;state&quot; : 2,</span><br><span class="line">        &quot;stateStr&quot; : &quot;SECONDARY&quot;,</span><br><span class="line">        &quot;uptime&quot; : 241,</span><br><span class="line">        &quot;optime&quot; : &#123;</span><br><span class="line">                &quot;ts&quot; : Timestamp(1509881297, 1),</span><br><span class="line">                &quot;t&quot; : NumberLong(16)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;optimeDurable&quot; : &#123;</span><br><span class="line">                &quot;ts&quot; : Timestamp(1509881297, 1),</span><br><span class="line">                &quot;t&quot; : NumberLong(16)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;optimeDate&quot; : ISODate(&quot;2017-11-05T11:28:17Z&quot;),</span><br><span class="line">        &quot;optimeDurableDate&quot; : ISODate(&quot;2017-11-05T11:28:17Z&quot;),</span><br><span class="line">        &quot;lastHeartbeat&quot; : ISODate(&quot;2017-11-05T11:28:18.073Z&quot;),</span><br><span class="line">        &quot;lastHeartbeatRecv&quot; : ISODate(&quot;2017-11-05T11:28:18.769Z&quot;),</span><br><span class="line">        &quot;pingMs&quot; : NumberLong(0),</span><br><span class="line">        &quot;syncingTo&quot; : &quot;192.168.248.136:27017&quot;,</span><br><span class="line">        &quot;configVersion&quot; : 15</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;_id&quot; : 3,</span><br><span class="line">        &quot;name&quot; : &quot;192.168.248.136:27017&quot;,</span><br><span class="line">        &quot;health&quot; : 1,</span><br><span class="line">        &quot;state&quot; : 1,</span><br><span class="line">        &quot;stateStr&quot; : &quot;PRIMARY&quot;,</span><br><span class="line">        &quot;uptime&quot; : 250,</span><br><span class="line">        &quot;optime&quot; : &#123;</span><br><span class="line">                &quot;ts&quot; : Timestamp(1509881297, 1),</span><br><span class="line">                &quot;t&quot; : NumberLong(16)</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;optimeDate&quot; : ISODate(&quot;2017-11-05T11:28:17Z&quot;),</span><br><span class="line">        &quot;electionTime&quot; : Timestamp(1509881276, 1),</span><br><span class="line">        &quot;electionDate&quot; : ISODate(&quot;2017-11-05T11:27:56Z&quot;),</span><br><span class="line">        &quot;configVersion&quot; : 15,</span><br><span class="line">        &quot;self&quot; : true</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>stateStr用来描述当前节点的状态。</li>
<li>uptime表示从成员可达到现在所经历的时间。</li>
<li>optimeDate表示每个成员的oplog中最后一个操作发生的时间。</li>
<li>lastHeartbeat表示当前服务器最后一次收到其他成员心跳的时间。</li>
<li>pingMs表示心跳从当前服务器到达某个成员所花费的平均时间。</li>
<li>syncingTo表示同步的数据源。</li>
<li>health表示该服务器是否可达，1表示可达，0表示不可达。</li>
</ol>
<h2 id="复制链问题"><a href="#复制链问题" class="headerlink" title="复制链问题"></a>复制链问题</h2><p>数据复制时可以从主节点直接复制，也可以从备份节点开始复制，从备份节点复制可以形成复制链，如果想禁止复制链，即所有的数据都从主节点复制，可以通过 chainingAllowed 属性来设置，具体步骤如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config=rs.config()</span><br><span class="line">config.settings.chainingAllowed=false</span><br><span class="line">rs.reconfig(config)</span><br></pre></td></tr></table></figure>
<p>好了，MongoDB 中副本集的其他细节我们就先说到这里，小伙伴们有问题欢迎留言讨论。<br>参考资料：</p>
<ol>
<li>《MongoDB权威指南第2版》</li>
</ol>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-09-16T02:17:28.000Z">2019-09-16</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/MongoDB/">MongoDB</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    6 分钟 读完 (大约 873 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/0916/mongodb-replicaset-settings.html">MongoDB 副本集配置</a>
            
        </h1>
        <div class="content">
            <p>上篇文章我们搭建了 MongoDB 副本集的环境，验证了数据已经可以成功的复制，本文我们就来看看 MongoDB 副本集的其他操作。</p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>三台服务器，地址分别是：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.248.128</span><br><span class="line">192.168.248.135</span><br><span class="line">192.168.248.136</span><br></pre></td></tr></table></figure>
<p>按照上文介绍的步骤搭建副本集环境，这里不再赘述。</p>
<h2 id="副本集成员添加删除"><a href="#副本集成员添加删除" class="headerlink" title="副本集成员添加删除"></a>副本集成员添加删除</h2><p>在副本集环境搭建好之后，我们可以利用如下命令删除一个副本集成员：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.remove(&apos;192.168.248.128:27017&apos;)</span><br></pre></td></tr></table></figure>
<p>上面的命令执行完成后，我们可以通过 rs.status() 命令来查看是否删除成功，也可以通过如下命令来为副本集添加一个成员：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.add(&apos;192.168.248.128:27017&apos;)</span><br></pre></td></tr></table></figure>
<p>当然，副本集也是可以更新的，使用 reconfig 命令即可，如下：</p>
<p>首先定义 config，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config=&#123;_id:&quot;rs&quot;,members:[&#123;_id:3,host:&quot;192.168.248.128&quot;&#125;,&#123;_id:1,host:&quot;192.168.248.135&quot;&#125;]&#125;</span><br></pre></td></tr></table></figure>
<p>然后执行更新操作：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.reconfig(config)</span><br></pre></td></tr></table></figure>
<p>我们也可以利用 config=rs.config() 获取原始的 config 文件，然后进行修改，修改之后再执行 rs.reconfig(config)，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config=rs.config()</span><br><span class="line">config.members[0].host=&quot;192.168.248.136&quot;</span><br><span class="line">rs.reconfig(config)</span><br></pre></td></tr></table></figure>
<h2 id="选举仲裁者"><a href="#选举仲裁者" class="headerlink" title="选举仲裁者"></a>选举仲裁者</h2><p>在上文中给小伙伴们演示了主节点挂掉后的情况，和其他的(如 Redis )数据库主从复制不同，MongoDB 中主节点挂掉之后会自动从备份节点中选出一个新的主节点出来，这是一个选举的过程，投票选举，但是如果备份节点数为偶数的话，可能会出现两台服务器票数相等的情况，为了避免这种问题的出现，我们一般有两种解决方案：</p>
<blockquote>
<ol>
<li>数据节点为奇数个，这样就会避免上面描述的问题出现。</li>
<li>使用选举仲裁者，这是一种特殊的成员，仲裁者不保存数据，也不为客户端提供服务，只是在选举投票出现僵持时出来投个票，一个副本集中最多只能有一个仲裁者。</li>
</ol>
</blockquote>
<p>选举仲裁者占用的系统资源很小，因此对部署的服务器性能没多大要求，向副本集中添加仲裁者的方式如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.addArb(&apos;192.168.248.128:27017&apos;)</span><br></pre></td></tr></table></figure>
<p>也可以利用我们之前说的 reconfig 来操作：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config=rs.config()</span><br><span class="line">config.members[2]=&#123;_id:2,host:&apos;192.168.248.128&apos;,arbiterOnly:true&#125;</span><br><span class="line">rs.reconfig(config)</span><br></pre></td></tr></table></figure>
<p>添加完成之后，我们可以通过 rs.status() 命令来查看是否添加成功，如果看到如下内容，表示添加成功：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="hljs-attr">"_id"</span> : <span class="hljs-number">2</span>,</span><br><span class="line"><span class="hljs-attr">"name"</span> : <span class="hljs-string">"192.168.248.128:27017"</span>,</span><br><span class="line"><span class="hljs-attr">"health"</span> : <span class="hljs-number">1</span>,</span><br><span class="line"><span class="hljs-attr">"state"</span> : <span class="hljs-number">7</span>,</span><br><span class="line"><span class="hljs-attr">"stateStr"</span> : <span class="hljs-string">"ARBITER"</span>,</span><br><span class="line"><span class="hljs-attr">"uptime"</span> : <span class="hljs-number">2</span>,</span><br><span class="line"><span class="hljs-attr">"lastHeartbeat"</span> : ISODate(<span class="hljs-string">"2017-11-03T08:56:12.406Z"</span>),</span><br><span class="line"><span class="hljs-attr">"lastHeartbeatRecv"</span> : ISODate(<span class="hljs-string">"2017-11-03T08:56:08.417Z"</span>),</span><br><span class="line"><span class="hljs-attr">"pingMs"</span> : NumberLong(<span class="hljs-number">1</span>),</span><br><span class="line"><span class="hljs-attr">"configVersion"</span> : <span class="hljs-number">8</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>仲裁者的移除和普通节点的移除是一样的，这里不再赘述。</p>
<h2 id="优先级问题"><a href="#优先级问题" class="headerlink" title="优先级问题"></a>优先级问题</h2><p>优先级用来描述一个备份节点成为主节点的优先性问题，优先级的取值范围为 [0-100]，默认为 1，数字越大优先级越高，越有可能成为主节点，0 表示该节点永远不能成为主节点。</p>
<p>我们可以在添加节点时指定优先级，如下:</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.add(&#123;_id:0,host:&apos;192.168.248.128:27017&apos;,priority:2&#125;)</span><br></pre></td></tr></table></figure>
<p>也可以为已有的节点设置优先级：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config=rs.config()</span><br><span class="line">config.members[0].priority=99</span><br><span class="line">rs.reconfig(config)</span><br></pre></td></tr></table></figure>
<p>好了，MongoDB 中副本集的配置我们就先说到这里，小伙伴们有问题欢迎留言讨论。</p>
<p>参考资料：</p>
<ol>
<li>《MongoDB权威指南第2版》  </li>
</ol>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-09-15T02:17:28.000Z">2019-09-15</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/MongoDB/">MongoDB</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    10 分钟 读完 (大约 1502 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/0915/mongodb-replicaset-install.html">MongoDB 副本集搭建</a>
            
        </h1>
        <div class="content">
            <p>我们之前的案例都是在单个节点上实现的，在生产环境中这种做法是有风险的，如果服务宕机、崩溃或者硬盘坏了都会对公司业务造成损失，因此我们需要数据备份。在 MongoDB 中我们可以通过副本集来实现这一需求，MongoDB 副本集 (Replica Set) 是有自动故障恢复功能的主从集群，有一个 Primary 节点和一个或多个 Secondary 节点组成，如果 Primary 崩溃了，会自动从 Secondary 中选择一个将其升级为新的主服务器，本文我们先来看看副本集环境的搭建。</p>
<h2 id="单台服务器模拟"><a href="#单台服务器模拟" class="headerlink" title="单台服务器模拟"></a>单台服务器模拟</h2><p>我们在实际的生产环境中肯定是多台服务器部署，但是在自己学习过程中，我们可以在一台服务器上来模拟这个环境，这样可以简化我们的操作，让小伙伴们快速上手。下一小节我会和大家分享如何在真实的生产环境中创建副本集。</p>
<p>好了，开始吧。</p>
<p>首先我们在 Linux 根目录下创建 /data/db 目录作为我们的数据保存目录，然后执行如下命令启动一个 mongo shell：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --nodb</span><br></pre></td></tr></table></figure>
<p>–nodb 表示启动时不连接任何数据库，然后通过如下命令创建一个副本集：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replicaSet=new ReplSetTest(&#123;nodes:3&#125;)</span><br></pre></td></tr></table></figure>
<p>在创建的日志中，我们可以看到三个实例的端口号，我这里分别是 20000、20001、20002，此时我们的副本集创建好了，但是并未启动，接下来执行如下命令启动三个 mongodb 实例：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replicaSet.startSet()</span><br></pre></td></tr></table></figure>
<p>再执行如下命令配置复制功能：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replicaSet.initiate()</span><br></pre></td></tr></table></figure>
<p>这样环境基本就配好了，此时当前的 shell 不要关闭，我们重新打开一个 Linux 命令窗口，执行如下命令：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo 192.168.248.128:20000/sang_1</span><br></pre></td></tr></table></figure>
<p>表示连接端口为 20000 的那个实例中的 sang_1 数据库，连接成功后，我们可以执行如下命令查看当前实例的身份，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.isMaster()</span><br></pre></td></tr></table></figure>
<p>返回的数据很多，其中有一条是 <code>&quot;ismaster&quot; : true</code>，表示这是一个主节点，此时我们再分别打开两个 Linux 窗口，分别执行如下两条命令，进入另外两个节点：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongo 192.168.248.128:20001/sang_1</span><br><span class="line">mongo 192.168.248.128:20002/sang_1</span><br></pre></td></tr></table></figure>
<p>连接成功之后，依然可以通过 <code>db.isMaster()</code> 命令来查看备份节点的身份，我们发现此时 <code>&quot;ismaster&quot; : false</code>，表示这是一个备份节点，此时我们可以先做个简单的测试了，此时我在主节点(端口为 20000)那个节点上写一个文档，写完之后，我们看看其他副本集成员上是否有我刚才的写的文档的副本，执行命令顺序如下：</p>
<p>主节点写入数据：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collect1.insert(&#123;x:&quot;hahaha&quot;&#125;)</span><br></pre></td></tr></table></figure>
<p>任意一个副本节点，先执行如下命令表示可以从备份节点读取数据：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.setSlaveOk()</span><br></pre></td></tr></table></figure>
<p>然后再在备份节点中执行如下命令读取数据：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.collect1.find()</span><br></pre></td></tr></table></figure>
<p>此时，我们发现数据已经备份成功了。</p>
<p>如果此时我们尝试向备份节点中直接写入文档，会发现写入失败，这里需要注意备份节点中的数据都是备份来的，不可以直接写入，想写入，除非等它的身份转为主节点才可以。</p>
<p>此时，我们尝试通过如下命令关闭主节点：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line">db.shutdownServer()</span><br></pre></td></tr></table></figure>
<p>然后查看两个备份节点的 db.isMaster(),发现有一个备份节点自动上位成为了主节点。</p>
<p>最后如果想关闭副本集，可以回到第一个shell命令行中，输入如下命令：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replicaSet.stopSet()</span><br></pre></td></tr></table></figure>
<h2 id="多台服务器模拟"><a href="#多台服务器模拟" class="headerlink" title="多台服务器模拟"></a>多台服务器模拟</h2><p>OK，以上操作是我们单台服务器模拟搭建副本集，方便我们做实验，在生产环境中，我们可能有多个服务器，多台服务器又要如何搭建副本集呢？各位看官继续向下看。</p>
<p>首先准备好三台装好了MongoDB的服务器，地址分别如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.248.128</span><br><span class="line">192.168.248.135</span><br><span class="line">192.168.248.136</span><br></pre></td></tr></table></figure>
<p>修改每台服务器的配置文件 mongodb.conf，添加 replSet=rs，表示副本集的名称，修改后的配置文件内容如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dbpath=/opt/mongodb/db</span><br><span class="line">logpath=/opt/mongodb/logs/mongodb.log</span><br><span class="line">port=27017</span><br><span class="line">fork=true</span><br><span class="line">replSet=rs</span><br></pre></td></tr></table></figure>
<p>修改完成之后，分别启动三台服务器上的 MongoDB，启动成功之后，连接上任意一台的 shell，连接成功之后，先定义配置文件，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config=&#123;_id:&quot;rs&quot;,members:[&#123;_id:0,host:&quot;192.168.248.128:27017&quot;&#125;,&#123;_id:1,host:&quot;192.168.248.135:27017&quot;&#125;,&#123;_id:2,host:&quot;192.168.248.136:27017&quot;&#125;]&#125;</span><br></pre></td></tr></table></figure>
<p>id 后面跟着的是副本集的名称，也就是我们在 mongodb.conf 中定义的名称，后面三个是副本集的成员，定义好之后，再执行如下命令初始化副本集：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.initiate(config)</span><br></pre></td></tr></table></figure>
<p>初始化成功之后，我们就可以通过 rs.status() 来查看副本集的状态，也可以看到每个服务器的角色，部分日志内容如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="hljs-attr">"members"</span> : [</span><br><span class="line">&#123;</span><br><span class="line">        <span class="hljs-attr">"_id"</span> : <span class="hljs-number">0</span>,</span><br><span class="line">        <span class="hljs-attr">"name"</span> : <span class="hljs-string">"192.168.248.128:27017"</span>,</span><br><span class="line">        <span class="hljs-attr">"health"</span> : <span class="hljs-number">1</span>,</span><br><span class="line">        <span class="hljs-attr">"state"</span> : <span class="hljs-number">1</span>,</span><br><span class="line">        <span class="hljs-attr">"stateStr"</span> : <span class="hljs-string">"PRIMARY"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">        <span class="hljs-attr">"_id"</span> : <span class="hljs-number">1</span>,</span><br><span class="line">        <span class="hljs-attr">"name"</span> : <span class="hljs-string">"192.168.248.135:27017"</span>,</span><br><span class="line">        <span class="hljs-attr">"health"</span> : <span class="hljs-number">1</span>,</span><br><span class="line">        <span class="hljs-attr">"state"</span> : <span class="hljs-number">2</span>,</span><br><span class="line">        <span class="hljs-attr">"stateStr"</span> : <span class="hljs-string">"SECONDARY"</span>,</span><br><span class="line">        <span class="hljs-attr">"syncingTo"</span> : <span class="hljs-string">"192.168.248.128:27017"</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">        <span class="hljs-attr">"_id"</span> : <span class="hljs-number">2</span>,</span><br><span class="line">        <span class="hljs-attr">"name"</span> : <span class="hljs-string">"192.168.248.136:27017"</span>,</span><br><span class="line">        <span class="hljs-attr">"health"</span> : <span class="hljs-number">1</span>,</span><br><span class="line">        <span class="hljs-attr">"state"</span> : <span class="hljs-number">2</span>,</span><br><span class="line">        <span class="hljs-attr">"stateStr"</span> : <span class="hljs-string">"SECONDARY"</span>,</span><br><span class="line">        <span class="hljs-attr">"syncingTo"</span> : <span class="hljs-string">"192.168.248.128:27017"</span>,</span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到每台服务器的角色，有 primary，也有 secondary，secondary 上还注明了从哪个服务器上同步数据。所有这些工作做好之后，我们就可以按照上文介绍的方式来测一下这里的副本集了，测试工作我就不再重复介绍了。</p>
<p>好了，MongoDB 中副本集的搭建我们就先说到这里，小伙伴们有问题欢迎留言讨论。</p>
<p>参考资料：</p>
<ol>
<li>《MongoDB权威指南第2版》</li>
</ol>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-09-14T02:17:28.000Z">2019-09-14</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/MongoDB/">MongoDB</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    10 分钟 读完 (大约 1513 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/0914/mongodb-in-mapreduce.html">MongoDB 中 MapReduce 使用</a>
            
        </h1>
        <div class="content">
            <p>玩过 Hadoop 的小伙伴对 MapReduce 应该不陌生，MapReduce 的强大且灵活，它可以将一个大问题拆分为多个小问题，将各个小问题发送到不同的机器上去处理，所有的机器都完成计算后，再将计算结果合并为一个完整的解决方案，这就是所谓的分布式计算。本文我们就来看看 MongoDB 中 MapReduce 的使用。</p>
<h2 id="mapReduce"><a href="#mapReduce" class="headerlink" title="mapReduce"></a>mapReduce</h2><p>MongoDB 中的 MapReduce 可以用来实现更复杂的聚合命令，使用 MapReduce 主要实现两个函数：map 函数和 reduce 函数，map 函数用来生成键值对序列， map 函数的结果作为 reduce 函数的参数，reduce 函数中再做进一步的统计，比如我的数据集如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59fa71d71fd59c3b2cd908d7"</span>),<span class="hljs-attr">"name"</span> : <span class="hljs-string">"鲁迅"</span>,<span class="hljs-attr">"book"</span> : <span class="hljs-string">"呐喊"</span>,<span class="hljs-attr">"price"</span> : <span class="hljs-number">38.0</span>,<span class="hljs-attr">"publisher"</span> : <span class="hljs-string">"人民文学出版社"</span>&#125;</span><br><span class="line">&#123;<span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59fa71d71fd59c3b2cd908d8"</span>),<span class="hljs-attr">"name"</span> : <span class="hljs-string">"曹雪芹"</span>,<span class="hljs-attr">"book"</span> : <span class="hljs-string">"红楼梦"</span>,<span class="hljs-attr">"price"</span> : <span class="hljs-number">22.0</span>,<span class="hljs-attr">"publisher"</span> : <span class="hljs-string">"人民文学出版社"</span>&#125;</span><br><span class="line">&#123;<span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59fa71d71fd59c3b2cd908d9"</span>),<span class="hljs-attr">"name"</span> : <span class="hljs-string">"钱钟书"</span>,<span class="hljs-attr">"book"</span> : <span class="hljs-string">"宋诗选注"</span>,<span class="hljs-attr">"price"</span> : <span class="hljs-number">99.0</span>,<span class="hljs-attr">"publisher"</span> : <span class="hljs-string">"人民文学出版社"</span>&#125;</span><br><span class="line">&#123;<span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59fa71d71fd59c3b2cd908da"</span>),<span class="hljs-attr">"name"</span> : <span class="hljs-string">"钱钟书"</span>,<span class="hljs-attr">"book"</span> : <span class="hljs-string">"谈艺录"</span>,<span class="hljs-attr">"price"</span> : <span class="hljs-number">66.0</span>,<span class="hljs-attr">"publisher"</span> : <span class="hljs-string">"三联书店"</span>&#125;</span><br><span class="line">&#123;<span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59fa71d71fd59c3b2cd908db"</span>),<span class="hljs-attr">"name"</span> : <span class="hljs-string">"鲁迅"</span>,<span class="hljs-attr">"book"</span> : <span class="hljs-string">"彷徨"</span>,<span class="hljs-attr">"price"</span> : <span class="hljs-number">55.0</span>,<span class="hljs-attr">"publisher"</span> : <span class="hljs-string">"花城出版社"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>假如我想查询每位作者所出的书的总价，操作如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var map=function()&#123;emit(this.name,this.price)&#125;</span><br><span class="line">var reduce=function(key,value)&#123;return Array.sum(value)&#125;</span><br><span class="line">var options=&#123;out:&quot;totalPrice&quot;&#125;</span><br><span class="line">db.sang_books.mapReduce(map,reduce,options);</span><br><span class="line">db.totalPrice.find()</span><br></pre></td></tr></table></figure>
<p>emit 函数主要用来实现分组，接收两个参数，第一个参数表示分组的字段，第二个参数表示要统计的数据，reduce 来做具体的数据处理操作，接收两个参数，对应 emit 方法的两个参数，这里使用了 Array 中的 sum 函数对 price 字段进行自加处理，options 中定义了将结果输出的集合，届时我们将在这个集合中去查询数据，默认情况下，这个集合即使在数据库重启后也会保留，并且保留集合中的数据。查询结果如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"曹雪芹"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : <span class="hljs-number">22.0</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"钱钟书"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : <span class="hljs-number">165.0</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"鲁迅"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : <span class="hljs-number">93.0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再比如我想查询每位作者出了几本书，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var map=function()&#123;emit(this.name,1)&#125;</span><br><span class="line">var reduce=function(key,value)&#123;return Array.sum(value)&#125;</span><br><span class="line">var options=&#123;out:&quot;bookNum&quot;&#125;</span><br><span class="line">db.sang_books.mapReduce(map,reduce,options);</span><br><span class="line">db.bookNum.find()</span><br></pre></td></tr></table></figure>
<p>查询结果如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"曹雪芹"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : <span class="hljs-number">1.0</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"钱钟书"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : <span class="hljs-number">2.0</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"鲁迅"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : <span class="hljs-number">2.0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将每位作者的书列出来，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var map=function()&#123;emit(this.name,this.book)&#125;</span><br><span class="line">var reduce=function(key,value)&#123;return value.join(&apos;,&apos;)&#125;</span><br><span class="line">var options=&#123;out:&quot;books&quot;&#125;</span><br><span class="line">db.sang_books.mapReduce(map,reduce,options);</span><br><span class="line">db.books.find()</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"曹雪芹"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : <span class="hljs-string">"红楼梦"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"钱钟书"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : <span class="hljs-string">"宋诗选注,谈艺录"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"鲁迅"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : <span class="hljs-string">"呐喊,彷徨"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比如查询每个人售价在 ￥40 以上的书：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var map=function()&#123;emit(this.name,this.book)&#125;</span><br><span class="line">var reduce=function(key,value)&#123;return value.join(&apos;,&apos;)&#125;</span><br><span class="line">var options=&#123;query:&#123;price:&#123;$gt:40&#125;&#125;,out:&quot;books&quot;&#125;</span><br><span class="line">db.sang_books.mapReduce(map,reduce,options);</span><br><span class="line">db.books.find()</span><br></pre></td></tr></table></figure>
<p>query 表示对查到的集合再进行筛选。</p>
<p>结果如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"钱钟书"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : <span class="hljs-string">"宋诗选注,谈艺录"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"鲁迅"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : <span class="hljs-string">"彷徨"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="runCommand实现"><a href="#runCommand实现" class="headerlink" title="runCommand实现"></a>runCommand实现</h2><p>我们也可以利用 runCommand 命令来执行 MapReduce。格式如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">db.runCommand(</span><br><span class="line">               &#123;</span><br><span class="line">                 mapReduce: &lt;collection&gt;,</span><br><span class="line">                 map: &lt;function&gt;,</span><br><span class="line">                 reduce: &lt;function&gt;,</span><br><span class="line">                 finalize: &lt;function&gt;,</span><br><span class="line">                 out: &lt;output&gt;,</span><br><span class="line">                 query: &lt;document&gt;,</span><br><span class="line">                 sort: &lt;document&gt;,</span><br><span class="line">                 limit: &lt;number&gt;,</span><br><span class="line">                 scope: &lt;document&gt;,</span><br><span class="line">                 jsMode: &lt;boolean&gt;,</span><br><span class="line">                 verbose: &lt;boolean&gt;,</span><br><span class="line">                 bypassDocumentValidation: &lt;boolean&gt;,</span><br><span class="line">                 collation: &lt;document&gt;</span><br><span class="line">               &#125;</span><br><span class="line">             )</span><br></pre></td></tr></table></figure>
<p>含义如下：</p>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">mapReduce</td>
<td style="text-align:left">表示要操作的集合</td>
</tr>
<tr>
<td style="text-align:left">map</td>
<td style="text-align:left">map函数</td>
</tr>
<tr>
<td style="text-align:left">reduce</td>
<td style="text-align:left">reduce函数</td>
</tr>
<tr>
<td style="text-align:left">finalize</td>
<td style="text-align:left">最终处理函数</td>
</tr>
<tr>
<td style="text-align:left">out</td>
<td style="text-align:left">输出的集合</td>
</tr>
<tr>
<td style="text-align:left">query</td>
<td style="text-align:left">对结果进行过滤</td>
</tr>
<tr>
<td style="text-align:left">sort</td>
<td style="text-align:left">对结果排序</td>
</tr>
<tr>
<td style="text-align:left">limit</td>
<td style="text-align:left">返回的结果数</td>
</tr>
<tr>
<td style="text-align:left">scope</td>
<td style="text-align:left">设置参数值，在这里设置的值在map、reduce、finalize函数中可见</td>
</tr>
<tr>
<td style="text-align:left">jsMode</td>
<td style="text-align:left">是否将map执行的中间数据由javascript对象转换成BSON对象，默认为false</td>
</tr>
<tr>
<td style="text-align:left">verbose</td>
<td style="text-align:left">是否显示详细的时间统计信息</td>
</tr>
<tr>
<td style="text-align:left">bypassDocumentValidation</td>
<td style="text-align:left">是否绕过文档验证</td>
</tr>
<tr>
<td style="text-align:left">collation</td>
<td style="text-align:left">其他一些校对</td>
</tr>
</tbody>
</table>
<p>如下操作，表示执行 MapReduce 操作并对统计的集合限制返回条数，限制返回条数之后再进行统计操作，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var map=function()&#123;emit(this.name,this.book)&#125;</span><br><span class="line">var reduce=function(key,value)&#123;return value.join(&apos;,&apos;)&#125;</span><br><span class="line">db.runCommand(&#123;mapreduce:&apos;sang_books&apos;,map,reduce,out:&quot;books&quot;,limit:4,verbose:true&#125;)</span><br><span class="line">db.books.find()</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"曹雪芹"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : <span class="hljs-string">"红楼梦"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"钱钟书"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : <span class="hljs-string">"宋诗选注,谈艺录"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"鲁迅"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : <span class="hljs-string">"呐喊"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>小伙伴们看到，鲁迅有一本书不见了，就是因为 limit 是先限制集合返回条数，然后再执行统计操作。</p>
<p>finalize 操作表示最终处理函数，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var f1 = function(key,reduceValue)&#123;var obj=&#123;&#125;;obj.author=key;obj.books=reduceValue; return obj&#125;</span><br><span class="line">var map=function()&#123;emit(this.name,this.book)&#125;</span><br><span class="line">var reduce=function(key,value)&#123;return value.join(&apos;,&apos;)&#125;</span><br><span class="line">db.runCommand(&#123;mapreduce:&apos;sang_books&apos;,map,reduce,out:&quot;books&quot;,finalize:f1&#125;)</span><br><span class="line">db.books.find()</span><br></pre></td></tr></table></figure>
<p>f1 第一个参数 key 表示 emit 中的第一个参数，第二个参数表示 reduce 的执行结果，我们可以在 f1 中对这个结果进行再处理，结果如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"曹雪芹"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : &#123;</span><br><span class="line">        <span class="hljs-attr">"author"</span> : <span class="hljs-string">"曹雪芹"</span>,</span><br><span class="line">        <span class="hljs-attr">"books"</span> : <span class="hljs-string">"红楼梦"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"钱钟书"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : &#123;</span><br><span class="line">        <span class="hljs-attr">"author"</span> : <span class="hljs-string">"钱钟书"</span>,</span><br><span class="line">        <span class="hljs-attr">"books"</span> : <span class="hljs-string">"宋诗选注,谈艺录"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"鲁迅"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : &#123;</span><br><span class="line">        <span class="hljs-attr">"author"</span> : <span class="hljs-string">"鲁迅"</span>,</span><br><span class="line">        <span class="hljs-attr">"books"</span> : <span class="hljs-string">"呐喊,彷徨"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>scope 则可以用来定义一个在 map、reduce 和 finalize 中都可见的变量，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var f1 = function(key,reduceValue)&#123;var obj=&#123;&#125;;obj.author=key;obj.books=reduceValue;obj.sang=sang; return obj&#125;</span><br><span class="line">var map=function()&#123;emit(this.name,this.book)&#125;</span><br><span class="line">var reduce=function(key,value)&#123;return value.join(&apos;,--&apos;+sang+&apos;--,&apos;)&#125;</span><br><span class="line">db.runCommand(&#123;mapreduce:&apos;sang_books&apos;,map,reduce,out:&quot;books&quot;,finalize:f1,scope:&#123;sang:&quot;haha&quot;&#125;&#125;)</span><br><span class="line">db.books.find()</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"曹雪芹"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : &#123;</span><br><span class="line">        <span class="hljs-attr">"author"</span> : <span class="hljs-string">"曹雪芹"</span>,</span><br><span class="line">        <span class="hljs-attr">"books"</span> : <span class="hljs-string">"红楼梦"</span>,</span><br><span class="line">        <span class="hljs-attr">"sang"</span> : <span class="hljs-string">"haha"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"钱钟书"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : &#123;</span><br><span class="line">        <span class="hljs-attr">"author"</span> : <span class="hljs-string">"钱钟书"</span>,</span><br><span class="line">        <span class="hljs-attr">"books"</span> : <span class="hljs-string">"宋诗选注,--haha--,谈艺录"</span>,</span><br><span class="line">        <span class="hljs-attr">"sang"</span> : <span class="hljs-string">"haha"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"鲁迅"</span>,</span><br><span class="line">    <span class="hljs-attr">"value"</span> : &#123;</span><br><span class="line">        <span class="hljs-attr">"author"</span> : <span class="hljs-string">"鲁迅"</span>,</span><br><span class="line">        <span class="hljs-attr">"books"</span> : <span class="hljs-string">"呐喊,--haha--,彷徨"</span>,</span><br><span class="line">        <span class="hljs-attr">"sang"</span> : <span class="hljs-string">"haha"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好了，MongoDB 中的 MapReduce 我们就先说到这里，小伙伴们有问题欢迎留言讨论。</p>
<p>参考资料：</p>
<ol>
<li>《MongoDB权威指南第2版》</li>
<li><a href="http://www.cnblogs.com/xiazh/archive/2012/09/05/2671730.html" target="_blank" rel="noopener">mongodb mapreduce小试</a></li>
<li><a href="http://blog.csdn.net/gaopeng0071/article/details/42027745" target="_blank" rel="noopener">mongoDB–mapreduce用法详解(未找到原始出处)</a></li>
</ol>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-09-13T02:17:28.000Z">2019-09-13</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/MongoDB/">MongoDB</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 分钟 读完 (大约 1065 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/0913/mongodb-pipelines.html">MongoDB 管道操作符(二)</a>
            
        </h1>
        <div class="content">
            <p>上篇文章中我们已经学习了 MongoDB 中几个基本的管道操作符，本文我们再来看看其他的管道操作符。</p>
<h2 id="group"><a href="#group" class="headerlink" title="$group"></a>$group</h2><h3 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h3><p>$group 可以用来对文档进行分组，比如我想将订单按照城市进行分组，并统计出每个城市的订单数量：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$group:&#123;_id:&quot;$orderAddressL&quot;,count:&#123;$sum:1&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>我们将要分组的字段传递给 $group 函数的 <code>_id</code> 字段，然后每当查到一个，就给 count 加 1，这样就可以统计出每个城市的订单数量。</p>
<h3 id="算术操作符"><a href="#算术操作符" class="headerlink" title="算术操作符"></a>算术操作符</h3><p>通过算术操作符我们可以对分组后的文档进行求和或者求平均数。比如我想计算每个城市订单运费总和，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$group:&#123;_id:&quot;$orderAddressL&quot;,totalFreight:&#123;$sum:&quot;$freight&quot;&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>先按地址分组，再求和。这里贴出部分查询结果，如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"HaiKou"</span>,</span><br><span class="line">    <span class="hljs-attr">"totalFreight"</span> : <span class="hljs-number">20.0</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : <span class="hljs-string">"HangZhou"</span>,</span><br><span class="line">    <span class="hljs-attr">"totalFreight"</span> : <span class="hljs-number">10.0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以计算每个城市运费的平均数，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$group:&#123;_id:&quot;$orderAddressL&quot;,avgFreight:&#123;$avg:&quot;$freight&quot;&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>先按地址分组，然后再计算平均数。</p>
<h3 id="极值操作符"><a href="#极值操作符" class="headerlink" title="极值操作符"></a>极值操作符</h3><p>极值操作符用来获取分组后数据集的边缘值，比如获取每个城市最贵的运费，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$group:&#123;_id:&quot;$orderAddressL&quot;,maxFreight:&#123;$max:&quot;$freight&quot;&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>查询每个城市最便宜的运费：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$group:&#123;_id:&quot;$orderAddressL&quot;,minFreight:&#123;$min:&quot;$freight&quot;&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>按城市分组之后，获取该城市第一个运费单：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$group:&#123;_id:&quot;$orderAddressL&quot;,firstFreight:&#123;$first:&quot;$freight&quot;&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>获取分组后的最后一个运费单：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$group:&#123;_id:&quot;$orderAddressL&quot;,lastFreight:&#123;$last:&quot;$freight&quot;&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="数据操作符"><a href="#数据操作符" class="headerlink" title="数据操作符"></a>数据操作符</h3><p>$addToSet 可以将分组后的某一个字段放到一个数组中，但是重复的元素将只出现一次，而且元素加入到数组中的顺序是无规律的，比如将分组后的每个城市的运费放到一个数组中，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$group:&#123;_id:&quot;$orderAddressL&quot;,freights:&#123;$addToSet:&quot;$freight&quot;&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>重复的 freight 将不会被添加进来。</p>
<p>$push 则对重复的数据不做限制，都可以添加进来，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$group:&#123;_id:&quot;$orderAddressL&quot;,freights:&#123;$push:&quot;$freight&quot;&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="unwind"><a href="#unwind" class="headerlink" title="$unwind"></a>$unwind</h2><p>$unwind 用来实现对文档的拆分,可以将文档中的值拆分为单独的文档，比如我的数据如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59f93c8b8523cfae4cf4ba86"</span>),</span><br><span class="line">    <span class="hljs-attr">"name"</span> : <span class="hljs-string">"鲁迅"</span>,</span><br><span class="line">    <span class="hljs-attr">"books"</span> : [ </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-attr">"name"</span> : <span class="hljs-string">"呐喊"</span>,</span><br><span class="line">            <span class="hljs-attr">"publisher"</span> : <span class="hljs-string">"花城出版社"</span></span><br><span class="line">        &#125;, </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="hljs-attr">"name"</span> : <span class="hljs-string">"彷徨"</span>,</span><br><span class="line">            <span class="hljs-attr">"publisher"</span> : <span class="hljs-string">"南海出版出"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 $unwind 命令将其拆分为独立文档，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_books.aggregate(&#123;$unwind:&quot;$books&quot;&#125;)</span><br></pre></td></tr></table></figure>
<p>拆分结果如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59f93c8b8523cfae4cf4ba86"</span>),</span><br><span class="line">    <span class="hljs-attr">"name"</span> : <span class="hljs-string">"鲁迅"</span>,</span><br><span class="line">    <span class="hljs-attr">"books"</span> : &#123;</span><br><span class="line">        <span class="hljs-attr">"name"</span> : <span class="hljs-string">"呐喊"</span>,</span><br><span class="line">        <span class="hljs-attr">"publisher"</span> : <span class="hljs-string">"花城出版社"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59f93c8b8523cfae4cf4ba86"</span>),</span><br><span class="line">    <span class="hljs-attr">"name"</span> : <span class="hljs-string">"鲁迅"</span>,</span><br><span class="line">    <span class="hljs-attr">"books"</span> : &#123;</span><br><span class="line">        <span class="hljs-attr">"name"</span> : <span class="hljs-string">"彷徨"</span>,</span><br><span class="line">        <span class="hljs-attr">"publisher"</span> : <span class="hljs-string">"南海出版出"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="其他操作符"><a href="#其他操作符" class="headerlink" title="其他操作符"></a>其他操作符</h2><p>$sort 操作可以对文档进行排序，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$sort:&#123;orderAddressL:1&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>用法和我们之前介绍普通搜索中的一致，可以按照存在的字段排序，也可以按照重命名的字段排序，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;oa:&quot;$orderAddressL&quot;&#125;&#125;,&#123;$sort:&#123;oa:-1&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>1 表示升序、-1 表示降序。</p>
<p>$limit 返回结果中的前 n 个文档，如下表示返回结果中的前三个文档：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;oa:&quot;$orderAddressL&quot;&#125;&#125;,&#123;$limit:3&#125;)</span><br></pre></td></tr></table></figure>
<p>$skip 表示跳过前 n 个文档，比如跳过前 5 个文档，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;oa:&quot;$orderAddressL&quot;&#125;&#125;,&#123;$skip:5&#125;)</span><br></pre></td></tr></table></figure>
<p>$skip 的效率低，要慎用。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在管道开始执行的阶段尽可能过滤掉足够多的数据，这样做有两个好处：</p>
<ol>
<li>只有从集合中直接查询时才会使用索引，尽早执行过滤可以让索引发挥作用；</li>
<li>该过滤的数据过滤掉之后，也可以降低后面管道的执行压力。另外，MongoDB 不允许一个聚合操作占用过多的内存，如果有一个聚合操作占用了超过 20% 的内存，则会直接报错。</li>
</ol>
<p>好了，MongoDB 中的管道操作符我们就先说到这里，小伙伴们有问题欢迎留言讨论。</p>
<p>参考资料：</p>
<ol>
<li>《MongoDB权威指南第2版》</li>
</ol>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-09-12T02:17:28.000Z">2019-09-12</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/MongoDB/">MongoDB</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    10 分钟 读完 (大约 1525 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/0912/mongodb-pipelines.html">MongoDB 管道操作符(一)</a>
            
        </h1>
        <div class="content">
            <p>熟悉 Linux 操作系统的小伙伴们应该知道 Linux 中有管道的说法，可以用来方便的处理数据。MongoDB2.2 版本也引入了新的数据聚合框架，一个文档可以经过多个节点组成的管道，每个节点都有自己特殊的功能，比如文档分组、文档过滤等，每一个节点都会接受一连串的文档，对这些文档做一些类型转换，然后将转换后的文档传递给下一个节点，最后一个节点则会将结果返回给客户端。本文我们就先来看几个基本的管道操作符。</p>
<h2 id="match"><a href="#match" class="headerlink" title="$match"></a>$match</h2><p>$match 可以用来对文档进行筛选，筛选完成之后我们就可以在筛选获得到的文档子集上来做数据聚合操作了，我们之前介绍的查询的操作符在 $match 中都可以使用，比如获取集合中所有 author 为”杜甫”的文档，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$match:&#123;author:&quot;杜甫&quot;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>我们在实际使用时最好将 $match 放在管道的前面，这样可以减少后面管道的工作量，同时，我们在投射和分组之前执行 $match 还可以用索引。</p>
<h2 id="project"><a href="#project" class="headerlink" title="$project"></a>$project</h2><h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3><p>$project 可以用来 <strong> 提取想要的字段 </strong>，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;title:1,_id:0&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>1 表示要该字段，0 表示不要该字段，也可以对返回的字段进行 <strong> 重命名 </strong>，比如将 title 改为 articleTitle，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;&quot;articleTitle&quot;:&quot;$title&quot;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>不过这里有一个问题需要注意，如果原字段上有索引，重命名之后的字段上就没有索引了，因此最好在重命名之前使用索引。</p>
<h3 id="数学表达式"><a href="#数学表达式" class="headerlink" title="数学表达式"></a>数学表达式</h3><p>数学表达式可以用来对一组数值进行加减乘除取模，比如我的数据结构如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_id&quot; : ObjectId(&quot;59f841f5b998d8acc7d08863&quot;),</span><br><span class="line">    &quot;orderAddressL&quot; : &quot;ShenZhen&quot;,</span><br><span class="line">    &quot;prodMoney&quot; : 45.0,</span><br><span class="line">    &quot;freight&quot; : 13.0,</span><br><span class="line">    &quot;discounts&quot; : 3.0,</span><br><span class="line">    &quot;orderDate&quot; : ISODate(&quot;2017-10-31T09:27:17.342Z&quot;),</span><br><span class="line">    &quot;prods&quot; : [ </span><br><span class="line">        &quot;可乐&quot;, </span><br><span class="line">        &quot;奶茶&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>订单的总费用为商品费用加上运费，查询如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;totalMoney:&#123;$add:[&quot;$prodMoney&quot;,&quot;$freight&quot;]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>实际付款的费用是总费用减去折扣，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;totalPay:&#123;$subtract:[&#123;$add:[&quot;$prodMoney&quot;,&quot;$freight&quot;]&#125;,&quot;$discounts&quot;]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>再来三个无厘头运算，比如计算 prodMoney 和 freight 和 discounts 的乘积：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;test1:&#123;$multiply:[&quot;$prodMoney&quot;,&quot;$freight&quot;,&quot;$discounts&quot;]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>再比如求 $prodMoney 和 $freight 的商，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;test1:&#123;$divide:[&quot;$prodMoney&quot;,&quot;$freight&quot;]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>再比如用 $freight 对 $prodMoney 取模，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;test1:&#123;$mod:[&quot;$prodMoney&quot;,&quot;$freight&quot;]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>加法和乘法都可以接收多个参数，其余的都接收两个参数。</p>
<h3 id="日期表达式"><a href="#日期表达式" class="headerlink" title="日期表达式"></a>日期表达式</h3><p>日期表达式可以从一个日期类型中提取出年、月、日、星期、时、分、秒等信息，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;&quot;年份&quot;:&#123;$year:&quot;$orderDate&quot;&#125;,&quot;月份&quot;:&#123;$month:&quot;$orderDate&quot;&#125;,&quot;一年中第几周&quot;:&#123;$week:&quot;$orderDate&quot;&#125;,&quot;日期&quot;:&#123;$dayOfMonth:&quot;$orderDate&quot;&#125;,&quot;星期&quot;:&#123;$dayOfWeek:&quot;$orderDate&quot;&#125;,&quot;一年中第几天&quot;:&#123;$dayOfYear:&quot;$orderDate&quot;&#125;,&quot;时&quot;:&#123;$hour:&quot;$orderDate&quot;&#125;,&quot;分&quot;:&#123;$minute:&quot;$orderDate&quot;&#125;,&quot;秒&quot;:&#123;$second:&quot;$orderDate&quot;&#125;,&quot;毫秒&quot;:&#123;$millisecond:&quot;$orderDate&quot;&#125;,&quot;自定义格式化时间&quot;:&#123;$dateToString:&#123;format:&quot;%Y年%m月%d %H:%M:%S&quot;,date:&quot;$orderDate&quot;&#125;&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59f841f5b998d8acc7d08861"</span>),</span><br><span class="line">    <span class="hljs-attr">"年份"</span> : <span class="hljs-number">2017</span>,</span><br><span class="line">    <span class="hljs-attr">"月份"</span> : <span class="hljs-number">10</span>,</span><br><span class="line">    <span class="hljs-attr">"一年中第几周"</span> : <span class="hljs-number">44</span>,</span><br><span class="line">    <span class="hljs-attr">"日期"</span> : <span class="hljs-number">31</span>,</span><br><span class="line">    <span class="hljs-attr">"星期"</span> : <span class="hljs-number">3</span>,</span><br><span class="line">    <span class="hljs-attr">"一年中第几天"</span> : <span class="hljs-number">304</span>,</span><br><span class="line">    <span class="hljs-attr">"时"</span> : <span class="hljs-number">9</span>,</span><br><span class="line">    <span class="hljs-attr">"分"</span> : <span class="hljs-number">27</span>,</span><br><span class="line">    <span class="hljs-attr">"秒"</span> : <span class="hljs-number">17</span>,</span><br><span class="line">    <span class="hljs-attr">"毫秒"</span> : <span class="hljs-number">342</span>,</span><br><span class="line">    <span class="hljs-attr">"自定义格式化时间"</span> : <span class="hljs-string">"2017年10月31 09:27:17"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>$dayOfWeek 返回的是星期，1 表示星期天，7 表示星期六，$week 表示本周是本年的第几周，从 0 开始计。$dateToString 是 MongoDB3.0+ 中的功能。格式化的字符还有以下几种：</p>
<table>
<thead>
<tr>
<th style="text-align:left">字符</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">取值范围</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">%Y</td>
<td style="text-align:left">Year (4 digits, zero padded)</td>
<td style="text-align:left">0000-9999</td>
</tr>
<tr>
<td style="text-align:left">%m</td>
<td style="text-align:left">Month (2 digits, zero padded)</td>
<td style="text-align:left">01-12</td>
</tr>
<tr>
<td style="text-align:left">%d</td>
<td style="text-align:left">Day of Month (2 digits, zero padded)</td>
<td style="text-align:left">01-31</td>
</tr>
<tr>
<td style="text-align:left">%H</td>
<td style="text-align:left">Hour (2 digits, zero padded, 24-hour clock)</td>
<td style="text-align:left">00-23</td>
</tr>
<tr>
<td style="text-align:left">%M</td>
<td style="text-align:left">Minute (2 digits, zero padded)</td>
<td style="text-align:left">00-59</td>
</tr>
<tr>
<td style="text-align:left">%S</td>
<td style="text-align:left">Second (2 digits, zero padded)</td>
<td style="text-align:left">00-60</td>
</tr>
<tr>
<td style="text-align:left">%L</td>
<td style="text-align:left">Millisecond (3 digits, zero padded)</td>
<td style="text-align:left">000-999</td>
</tr>
<tr>
<td style="text-align:left">%j</td>
<td style="text-align:left">Day of year (3 digits, zero padded)</td>
<td style="text-align:left">001-366</td>
</tr>
<tr>
<td style="text-align:left">%w</td>
<td style="text-align:left">Day of week (1-Sunday, 7-Saturday)</td>
<td style="text-align:left">1-7</td>
</tr>
<tr>
<td style="text-align:left">%U</td>
<td style="text-align:left">Week of year (2 digits, zero padded)</td>
<td style="text-align:left">00-53</td>
</tr>
</tbody>
</table>
<h3 id="字符串表达式"><a href="#字符串表达式" class="headerlink" title="字符串表达式"></a>字符串表达式</h3><p>字符串表达式中有字符串的截取、拼接、转大写、转小写等操作，比如我截取 orderAddressL 前两个字符返回，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;addr:&#123;$substr:[&quot;$orderAddressL&quot;,0,2]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>再比如我将 orderAddressL 和 orderDate 拼接后返回：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;addr:&#123;$concat:[&quot;$orderAddressL&quot;,&#123;$dateToString:&#123;format:&quot;--%Y年%m月%d&quot;,date:&quot;$orderDate&quot;&#125;&#125;]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59f841f5b998d8acc7d08861"</span>),</span><br><span class="line">    <span class="hljs-attr">"addr"</span> : <span class="hljs-string">"NanJing--2017年10月31"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再比如我将 orderAddressL 全部转为小写返回：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;addr:&#123;$toLower:&quot;$orderAddressL&quot;&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>再比如我将 orderAddressL 全部转为大写返回：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;addr:&#123;$toUpper:&quot;$orderAddressL&quot;&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="逻辑表达式"><a href="#逻辑表达式" class="headerlink" title="逻辑表达式"></a>逻辑表达式</h3><p>想要比较两个数字的大小，可以使用 $cmp 操作符，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;test:&#123;$cmp:[&quot;$freight&quot;,&quot;$discounts&quot;]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>如果第一个参数大于第二个参数返回正数，第一个参数小于第二个则返回负数，也可以利用 $strcasecmp 来比较字符串（中文无效）：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;test:&#123;$strcasecmp:[&#123;$dateToString:&#123;format:&quot;..%Y年%m月%d&quot;,date:&quot;$orderDate&quot;&#125;&#125;,&quot;$orderAddressL&quot;]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>至于我们之前介绍的 $eq/$ne/$gt/$gte/$lt/$lte 等操作符在这里一样是适用的。另外还有 and、$or、$not 等表达式可用，以 $and 为例，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;test:&#123;$and:[&#123;&quot;$eq&quot;:[&quot;$freight&quot;,&quot;$prodMoney&quot;]&#125;,&#123;&quot;$eq&quot;:[&quot;$freight&quot;,&quot;$discounts&quot;]&#125;]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>$and 中的每个参数都为 true 时返回 true，$or 则表示参数中有一个为 true 就返回 true，$not 则会对它的参数的值取反，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;test:&#123;$not:&#123;&quot;$eq&quot;:[&quot;$freight&quot;,&quot;$prodMoney&quot;]&#125;&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>另外还有两个流程控制语句，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;test:&#123;$cond:[false,&quot;trueExpr&quot;,&quot;falseExpr&quot;]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>$cond 第一个参数如果为 true，则返回 trueExpr，否则返回 falseExpr.</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.aggregate(&#123;$project:&#123;test:&#123;$ifNull:[null,&quot;replacementExpr&quot;]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>$ifNull 第一个参数如果为 null，则返回 replacementExpr，否则就返回第一个参数。</p>
<p>好了，MongoDB 中的管道操作符我们就先说到这里，下篇文章继续，小伙伴们有问题欢迎留言讨论。<br>参考资料：</p>
<ol>
<li>《MongoDB权威指南第2版》</li>
<li><a href="http://blog.csdn.net/u013066244/article/details/53842355" target="_blank" rel="noopener">mongodb聚合利用日期分组</a>  </li>
</ol>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-09-11T02:17:28.000Z">2019-09-11</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/MongoDB/">MongoDB</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    4 分钟 读完 (大约 666 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/0911/mongodb-collections.html">MongoDB 固定集合</a>
            
        </h1>
        <div class="content">
            <p>一般情况下我们创建的集合是没有大小的，可以一直往里边添加文档，这种集合可以动态增长，MongoDB 中还有一种集合叫做固定集合，这种集合的大小是固定的，我可以在创建的时候设置该集合中文档的数目，假设为 100 条，当集合中的文档数目达到 100 条时，如果再向集合中插入文档，则只会保留最新的 100 个文档，之前的文档则会被删除。一般像日志信息我们就可以使用固定集合，其他一些需要定期删除的数据也可以使用固定集合，本文我们就来看看这个固定集合的使用。</p>
<h2 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h2><p>固定集合的创建方式也比较简单，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection(&quot;my_collect&quot;,&#123;capped:true,size:10000,max:100&#125;)</span><br></pre></td></tr></table></figure>
<p>capped:true 参数表示该集合为一个固定大小集合，size 表示集合的大小，单位为 kb，max 则表示集合中文档的最大数量。我们这里相当于给了固定集合两个限制条件，只要有任意一个限制条件满足，集合都会开始将更古老的数据删除。固定集合一旦创建成功就不能再修改，想修改只能删除重来。此时我们可以尝试向集合中添加 120 条简单的数据，然后我们会发现最早的 20 条数据消失了。</p>
<p>除了直接创建一个固定集合外，我们也可以通过 convertToCapped 操作将一个普通集合转为一个固定集合，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.runCommand(&#123;convertToCapped:&quot;sang_collect&quot;,size:10&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="自然排序问题"><a href="#自然排序问题" class="headerlink" title="自然排序问题"></a>自然排序问题</h2><p>自然排序就是按照文档在磁盘中的顺序来进行排列，在普通的集合中自然排序并没有多大的意义，因为文档的位置总是在变化，而固定集合中的文档是按照文档被插入的顺序保存的，自然顺序也就是文档的插入顺序，因此我们可以利用自然排序对文档从旧到新排序，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.find().sort(&#123;$natural:1&#125;)</span><br></pre></td></tr></table></figure>
<p>也可以从新到旧排序：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.find().sort(&#123;$natural:-1&#125;)</span><br></pre></td></tr></table></figure>
<p>固定集合中的其他操作和普通集合基本一致，这里就不再赘述。</p>
<p>好了，MongoDB 中的固定集合我们就说到这里，小伙伴们有问题欢迎留言讨论。</p>
<p>参考资料：</p>
<ol>
<li>《MongoDB权威指南第2版》</li>
</ol>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-09-10T02:17:28.000Z">2019-09-10</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/MongoDB/">MongoDB</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    12 分钟 读完 (大约 1753 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/0910/mongodb-index-types.html">MongoDB 中各种类型的索引</a>
            
        </h1>
        <div class="content">
            <p>上篇文章中我们介绍了 MongoDB 中索引的简单操作，创建、查看、删除等基本操作，不过上文我们只介绍了一种类型的索引，本文我们来看看其他类型的索引。</p>
<h2 id="id-索引"><a href="#id-索引" class="headerlink" title="_id 索引"></a>_id 索引</h2><p>我们在上文介绍过，我们往集合中添加文档时，默认情况下 MongoDB 都会帮助我们创建一个名为 <code>_id</code> 的字段，这个字段就是一个索引。默认情况下，一般的集合都会帮我们创建这个字段作为索引，但也有一些集合不会将 <code>_id</code> 默认作为索引，比如固定集合，这个我们后面的文章会详细说到这个问题。</p>
<h2 id="复合索引"><a href="#复合索引" class="headerlink" title="复合索引"></a>复合索引</h2><p>如果我们的查询条件有多个的话，我们可以对这多个查询条件都建立索引，比如我们可以对文档中的 x 和 y 字段都建立索引，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.ensureIndex(&#123;x:1,y:-1&#125;)</span><br></pre></td></tr></table></figure>
<p>此时执行如下查询语句时就会用到这个复合索引：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.find(&#123;x:1,y:999&#125;)</span><br></pre></td></tr></table></figure>
<p>小伙伴们也可以通过查看查询计划来确定确实使用到了上文创建好的索引。</p>
<h2 id="过期索引"><a href="#过期索引" class="headerlink" title="过期索引"></a>过期索引</h2><p>顾名思义，过期索引就是一种会过期的索引，在索引过期之后，索引对应的数据会被删除，创建方式如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.ensureIndex(&#123;time:1&#125;,&#123;expireAfterSeconds:30&#125;)</span><br></pre></td></tr></table></figure>
<p>expireAfterSeconds 表示索引的过期时间，单位为秒。time 表示索引的字段，time 的数据类型必须是 ISODate 或者 ISODate 数组，否则的话，当索引过期之后，time 的数据就不会被删除。</p>
<h2 id="全文索引"><a href="#全文索引" class="headerlink" title="全文索引"></a>全文索引</h2><p>全文索引虽然好用，可惜不支持中文，我们这里就先做一个简单的了解。</p>
<p>比如，我的数据集如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59f5a3da1f9e8e181ffc3189"</span>),</span><br><span class="line">    <span class="hljs-attr">"x"</span> : <span class="hljs-string">"Java C# Python PHP"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59f5a3da1f9e8e181ffc318a"</span>),</span><br><span class="line">    <span class="hljs-attr">"x"</span> : <span class="hljs-string">"Java C#"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59f5a3da1f9e8e181ffc318b"</span>),</span><br><span class="line">    <span class="hljs-attr">"x"</span> : <span class="hljs-string">"Java Python"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59f5a3da1f9e8e181ffc318c"</span>),</span><br><span class="line">    <span class="hljs-attr">"x"</span> : <span class="hljs-string">"PHP Python"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59f5a4541f9e8e181ffc318d"</span>),</span><br><span class="line">    <span class="hljs-attr">"x"</span> : <span class="hljs-string">"C C++"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以给 x 字段建立一个全文索引，创建方式如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.ensureIndex(&#123;x:&quot;text&quot;&#125;)</span><br></pre></td></tr></table></figure>
<p>MongoDB 会自动对 x 字段的数据进行分词，然后我们就可以通过如下语句进行查询：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.find(&#123;$text:&#123;$search:&quot;Java&quot;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>此时 x 中包含 Java 的文档都会被查询出来。如果想查询既包含 Java 又包含 C# 的文档，操作如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.find(&#123;$text:&#123;$search:&quot;\&quot;Java C#\&quot;&quot;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>用一对双引号将查询条件括起来，如果想查询包含 PHP 或者 Python 的文档，操作如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.find(&#123;$text:&#123;$search:&quot;PHP Python&quot;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>如果想查询既有 PHP，又有 Python，但是又不包括 Java 的文档，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.find(&#123;$text:&#123;$search:&quot;PHP Python -Java&quot;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>建立了全文索引之后，我们也可以查看查询结果的相似度，使用 $meta，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.find(&#123;$text:&#123;$search:&quot;PHP Python&quot;&#125;&#125;,&#123;score:&#123;$meta:&quot;textScore&quot;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>此时查询结果中会多出一个 score 字段，该字段的值越大，表示相似度越高，我们可以根据 score 利用 sort 来对其进行排序，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.find(&#123;$text:&#123;$search:&quot;PHP Python&quot;&#125;&#125;,&#123;score:&#123;$meta:&quot;textScore&quot;&#125;&#125;).sort(&#123;score:&#123;$meta:&quot;textScore&quot;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>全文索引目前看起来功能还是很强大，可惜暂时不支持中文，不过网上对此也有很多解决方案，小伙伴们可以自行搜索查看。</p>
<h2 id="地理空间索引"><a href="#地理空间索引" class="headerlink" title="地理空间索引"></a>地理空间索引</h2><h3 id="地理空间索引类型"><a href="#地理空间索引类型" class="headerlink" title="地理空间索引类型"></a>地理空间索引类型</h3><p>地理空间索引可以分为两类：</p>
<ol>
<li>2d 索引，可以用来存储和查找平面上的点。</li>
<li>2d sphere 索引，可以用来存储和查找球面上的点。</li>
</ol>
<h4 id="2d索引"><a href="#2d索引" class="headerlink" title="2d索引"></a>2d索引</h4><p>2d 索引一般我们可以用在游戏地图中。<br>向集合中插入一条记录点的数据：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.insert(&#123;x:[90,0]&#125;)</span><br></pre></td></tr></table></figure>
<p>插入数据的格式为[经度,纬度]，取值范围，经度 [-180,180]，纬度 [-90,90]。数据插入成功之后，我们先通过如下命令创建索引：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.ensureIndex(&#123;x:&quot;2d&quot;&#125;)</span><br></pre></td></tr></table></figure>
<p>然后通过 $near 我们可以查询某一个点附近的点，如下:</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.find(&#123;x:&#123;$near:[90,0]&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>默认情况下返回该点附近 100 个点，我们可以通过 $maxDistance 来设置返回的最远距离：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.find(&#123;x:&#123;$near:[90,0],$maxDistance:99&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>我们也可以通过 $geoWithin 查询某个形状内的点，比如查询矩形中的点：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.find(&#123;x:&#123;$geoWithin:&#123;$box:[[0,0],[91,1]]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>两个坐标点用来确定矩形的位置。</p>
<p>查询圆中的点：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.find(&#123;x:&#123;$geoWithin:&#123;$center:[[0,0],90]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>参数分别表示圆的圆心和半径。</p>
<p>查询多边形中的点：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.find(&#123;x:&#123;$geoWithin:&#123;$polygon:[[0,0],[100,0],[100,1],[0,1]]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>这里可以填入任意多个点，表示多边形中的各个点。</p>
<h4 id="2d-sphere索引"><a href="#2d-sphere索引" class="headerlink" title="2d sphere索引"></a>2d sphere索引</h4><p>2dsphere 适用于球面类型的地图，它的数据类型是 GeoJSON 格式的，我们可以在 <a href="http://geojson.org/" target="_blank" rel="noopener">http://geojson.org/</a> 地址上查看 GeoJSON 格式的样式，比如我们描述一个点， GeoJSON 如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59f5e0571f9e8e181ffc3196"</span>),</span><br><span class="line">    <span class="hljs-attr">"name"</span> : <span class="hljs-string">"shenzhen"</span>,</span><br><span class="line">    <span class="hljs-attr">"location"</span> : &#123;</span><br><span class="line">        <span class="hljs-attr">"type"</span> : <span class="hljs-string">"Point"</span>,</span><br><span class="line">        <span class="hljs-attr">"coordinates"</span> : [ </span><br><span class="line">            <span class="hljs-number">90.0</span>, </span><br><span class="line">            <span class="hljs-number">0.0</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>描述线，GeoJSON 格式如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59f5e0d01f9e8e181ffc3199"</span>),</span><br><span class="line">    <span class="hljs-attr">"name"</span> : <span class="hljs-string">"shenzhen"</span>,</span><br><span class="line">    <span class="hljs-attr">"location"</span> : &#123;</span><br><span class="line">        <span class="hljs-attr">"type"</span> : <span class="hljs-string">"LineString"</span>,</span><br><span class="line">        <span class="hljs-attr">"coordinates"</span> : [ </span><br><span class="line">            [ </span><br><span class="line">                <span class="hljs-number">90.0</span>, </span><br><span class="line">                <span class="hljs-number">0.0</span></span><br><span class="line">            ], </span><br><span class="line">            [ </span><br><span class="line">                <span class="hljs-number">90.0</span>, </span><br><span class="line">                <span class="hljs-number">1.0</span></span><br><span class="line">            ], </span><br><span class="line">            [ </span><br><span class="line">                <span class="hljs-number">90.0</span>, </span><br><span class="line">                <span class="hljs-number">2.0</span></span><br><span class="line">            ]</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>描述多边形，GeoJSON 格式如下：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"59f5e3f91f9e8e181ffc31d0"</span>),</span><br><span class="line">    <span class="hljs-attr">"name"</span> : <span class="hljs-string">"beijing"</span>,</span><br><span class="line">    <span class="hljs-attr">"location"</span> : &#123;</span><br><span class="line">        <span class="hljs-attr">"type"</span> : <span class="hljs-string">"Polygon"</span>,</span><br><span class="line">        <span class="hljs-attr">"coordinates"</span> : [ </span><br><span class="line">            [ </span><br><span class="line">                [ </span><br><span class="line">                    <span class="hljs-number">0.0</span>, </span><br><span class="line">                    <span class="hljs-number">1.0</span></span><br><span class="line">                ], </span><br><span class="line">                [ </span><br><span class="line">                    <span class="hljs-number">0.0</span>, </span><br><span class="line">                    <span class="hljs-number">2.0</span></span><br><span class="line">                ], </span><br><span class="line">                [ </span><br><span class="line">                    <span class="hljs-number">1.0</span>, </span><br><span class="line">                    <span class="hljs-number">2.0</span></span><br><span class="line">                ], </span><br><span class="line">                [ </span><br><span class="line">                    <span class="hljs-number">0.0</span>, </span><br><span class="line">                    <span class="hljs-number">1.0</span></span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还有其他的类型，具体小伙伴们可以参考 <a href="http://geojson.org/" target="_blank" rel="noopener">http://geojson.org/</a> 。有了数据之后，我们可以通过如下操作来创建地理空间索引了：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.sang_collect.ensureIndex(&#123;location:&quot;2dsphere&quot;&#125;)</span><br></pre></td></tr></table></figure>
<p>比如我想查询和深圳这个区域有交集的文档，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var shenzhen = db.sang_collect.findOne(&#123;name:&quot;shenzhen&quot;&#125;)</span><br><span class="line">db.sang_collect.find(&#123;location:&#123;$geoIntersects:&#123;$geometry:shenzhen.location&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>这里的查询结果是和深圳这个区域有交集的都会查到(比如经过深圳的高速公路、铁路等)，我们也可以只查询深圳市内的区域(比如深圳市内所有的学校)，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var shenzhen = db.sang_collect.findOne(&#123;name:&quot;shenzhen&quot;&#125;)</span><br><span class="line">db.sang_collect.find(&#123;location:&#123;$within:&#123;$geometry:shenzhen.location&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>也可以查询腾讯附近的其他位置，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var QQ = db.sang_collect.findOne(&#123;name:&quot;QQ&quot;&#125;)</span><br><span class="line">db.sang_collect.find(&#123;location:&#123;$near:&#123;$geometry:QQ.location&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="复合地理空间索引"><a href="#复合地理空间索引" class="headerlink" title="复合地理空间索引"></a>复合地理空间索引</h3><p>位置往往只是我们查询的一个条件，比如我要查询深圳市内所有的学校，那我得再增加一个查询条件，如下：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var shenzhen = db.sang_collect.findOne(&#123;name:&quot;shenzhen&quot;&#125;)</span><br><span class="line">db.sang_collect.find(&#123;location:&#123;$within:&#123;$geometry:shenzhen.location&#125;&#125;,name:&quot;QQ&quot;&#125;)</span><br></pre></td></tr></table></figure>
<p>其他的查询条件跟在后面就行了。</p>
<p>好了，MongoDB 中的索引问题我们就说到这里，小伙伴们有问题欢迎留言讨论。</p>
<p>参考资料：</p>
<ol>
<li>《MongoDB权威指南第2版》</li>
</ol>

        </div>
        
        
        
    </div>
</div>









    
<div class="card card-transparent">
    <nav class="pagination is-centered" role="navigation" aria-label="pagination">
        <div class="pagination-previous is-invisible is-hidden-mobile">
            <a class="is-flex-grow has-text-black-ter" href="/tags/MongoDB/page/0/">上一页</a>
        </div>
        <div class="pagination-next">
            <a class="is-flex-grow has-text-black-ter" href="/tags/MongoDB/page/2/">下一页</a>
        </div>
        <ul class="pagination-list is-hidden-mobile">
            
            <li><a class="pagination-link is-current" href="/tags/MongoDB/">1</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/tags/MongoDB/page/2/">2</a></li>
            
        </ul>
    </nav>
</div>
</div>
                




<div class="column is-4-tablet is-3-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="https://www.javaboy.org/images/sb/javaboy.jpg" alt="江南一点雨">
                    
                    
                    <p class="is-size-4 is-block">
                        江南一点雨
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        江南一点雨
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>China· ShenZhen</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        134
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        24
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        50
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/lenve" target="_blank">
                扫码关注微信公众号</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Github" href="https://github.com/lenve">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="envelope" href="mailto:wangsong0210@gmail.com">
                
                <i class="fa fa-envelope"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="RSS" href="/atom.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Chrome/">
            <span class="level-start">
                <span class="level-item">Chrome</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Git/">
            <span class="level-start">
                <span class="level-item">Git</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">8</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/GitHub/">
            <span class="level-start">
                <span class="level-item">GitHub</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/IDEA/">
            <span class="level-start">
                <span class="level-item">IDEA</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Java/">
            <span class="level-start">
                <span class="level-item">Java</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JavaWeb/">
            <span class="level-start">
                <span class="level-item">JavaWeb</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/MongoDB/">
            <span class="level-start">
                <span class="level-item">MongoDB</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">19</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/MyBatis/">
            <span class="level-start">
                <span class="level-item">MyBatis</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/MySQL/">
            <span class="level-start">
                <span class="level-item">MySQL</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">9</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Nginx/">
            <span class="level-start">
                <span class="level-item">Nginx</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Redis/">
            <span class="level-start">
                <span class="level-item">Redis</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">14</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Spring/">
            <span class="level-start">
                <span class="level-item">Spring</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Spring-Boot/">
            <span class="level-start">
                <span class="level-item">Spring Boot</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">48</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/SpringMVC/">
            <span class="level-start">
                <span class="level-item">SpringMVC</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/docker/">
            <span class="level-start">
                <span class="level-item">docker</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">8</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/hexo/">
            <span class="level-start">
                <span class="level-item">hexo</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/life/">
            <span class="level-start">
                <span class="level-item">life</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/mail/">
            <span class="level-start">
                <span class="level-item">mail</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/前后端分离/">
            <span class="level-start">
                <span class="level-item">前后端分离</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/学习资源/">
            <span class="level-start">
                <span class="level-item">学习资源</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/微服务/">
            <span class="level-start">
                <span class="level-item">微服务</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/杂谈/">
            <span class="level-start">
                <span class="level-item">杂谈</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/生活/">
            <span class="level-start">
                <span class="level-item">生活</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/面试/">
            <span class="level-start">
                <span class="level-item">面试</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/CORS/" style="font-size: 10px;">CORS</a> <a href="/tags/Chrome/" style="font-size: 11.11px;">Chrome</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Ehcache/" style="font-size: 10px;">Ehcache</a> <a href="/tags/Freemarker/" style="font-size: 10px;">Freemarker</a> <a href="/tags/Git/" style="font-size: 15.56px;">Git</a> <a href="/tags/GitHub/" style="font-size: 10px;">GitHub</a> <a href="/tags/Https/" style="font-size: 10px;">Https</a> <a href="/tags/IDEA/" style="font-size: 10px;">IDEA</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/JavaWeb/" style="font-size: 10px;">JavaWeb</a> <a href="/tags/JdbcTemplate/" style="font-size: 11.11px;">JdbcTemplate</a> <a href="/tags/Jedis/" style="font-size: 10px;">Jedis</a> <a href="/tags/Jpa/" style="font-size: 12.22px;">Jpa</a> <a href="/tags/LiveReload/" style="font-size: 10px;">LiveReload</a> <a href="/tags/Mail/" style="font-size: 10px;">Mail</a> <a href="/tags/MongoDB/" style="font-size: 18.89px;">MongoDB</a> <a href="/tags/MyBatis/" style="font-size: 13.33px;">MyBatis</a> <a href="/tags/MyCat/" style="font-size: 13.33px;">MyCat</a> <a href="/tags/MySQL/" style="font-size: 16.67px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/Redis/" style="font-size: 17.78px;">Redis</a> <a href="/tags/Shiro/" style="font-size: 10px;">Shiro</a> <a href="/tags/Spring/" style="font-size: 12.22px;">Spring</a> <a href="/tags/Spring-Boot/" style="font-size: 20px;">Spring Boot</a> <a href="/tags/Spring-Data/" style="font-size: 11.11px;">Spring Data</a> <a href="/tags/Spring-Security/" style="font-size: 13.33px;">Spring Security</a> <a href="/tags/SpringBoot/" style="font-size: 10px;">SpringBoot</a> <a href="/tags/SpringMVC/" style="font-size: 12.22px;">SpringMVC</a> <a href="/tags/Swagger2/" style="font-size: 10px;">Swagger2</a> <a href="/tags/Thymeleaf/" style="font-size: 10px;">Thymeleaf</a> <a href="/tags/Video/" style="font-size: 10px;">Video</a> <a href="/tags/Vue/" style="font-size: 14.44px;">Vue</a> <a href="/tags/Web/" style="font-size: 10px;">Web</a> <a href="/tags/docker/" style="font-size: 15.56px;">docker</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/life/" style="font-size: 10px;">life</a> <a href="/tags/mail/" style="font-size: 10px;">mail</a> <a href="/tags/yaml/" style="font-size: 10px;">yaml</a> <a href="/tags/中间件/" style="font-size: 10px;">中间件</a> <a href="/tags/前后端分离/" style="font-size: 10px;">前后端分离</a> <a href="/tags/单体应用/" style="font-size: 10px;">单体应用</a> <a href="/tags/学习资源/" style="font-size: 10px;">学习资源</a> <a href="/tags/微服务/" style="font-size: 11.11px;">微服务</a> <a href="/tags/杂谈/" style="font-size: 13.33px;">杂谈</a> <a href="/tags/条件注解/" style="font-size: 10px;">条件注解</a> <a href="/tags/生活/" style="font-size: 10px;">生活</a> <a href="/tags/面试/" style="font-size: 10px;">面试</a>
    </div>
</div>

    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-21T06:47:18.000Z">2019-09-21</time></div>
                    <a href="/2019/0921/mysql.html" class="has-link-black-ter is-size-6">给数据库减负的八个思路</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MySQL/">MySQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-20T05:07:20.000Z">2019-09-20</time></div>
                    <a href="/2019/0920/springboot-vue-online.html" class="has-link-black-ter is-size-6">喜大普奔，两个开源的 Spring Boot + Vue 前后端分离项目可以在线体验了</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Spring-Boot/">Spring Boot</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-19T02:17:28.000Z">2019-09-19</time></div>
                    <a href="/2019/0919/mongodb-in-java.html" class="has-link-black-ter is-size-6">Java 操作 MongoDB</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MongoDB/">MongoDB</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-18T02:17:28.000Z">2019-09-18</time></div>
                    <a href="/2019/0918/mongodb-shard.html" class="has-link-black-ter is-size-6">初识 MongoDB 分片</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MongoDB/">MongoDB</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-17T05:06:41.000Z">2019-09-17</time></div>
                    <a href="/2019/0917/official-accounts-20000.html" class="has-link-black-ter is-size-6">一个小小的里程碑！啥也不说了，签名书奉上！</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/life/">life</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">九月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">22</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/08/">
                <span class="level-start">
                    <span class="level-item">八月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">15</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">12</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/06/">
                <span class="level-start">
                    <span class="level-item">六月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">43</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/05/">
                <span class="level-start">
                    <span class="level-item">五月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">16</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/04/">
                <span class="level-start">
                    <span class="level-item">四月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">26</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
            

<div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            友链
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="http://www.ityouknow.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">纯洁的微笑</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">www.ityouknow.com</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="http://www.justdojava.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Java 极客技术</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">www.justdojava.com</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="http://cxytiandi.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">猿天地</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">cxytiandi.com</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://vimjc.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Vim教程网</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">vimjc.com</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="http://muggle.javaboy.org/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">muggle</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">muggle.javaboy.org</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://crossoverjie.top/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">crossoverJie&#39;s Blog</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">crossoverjie.top</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="http://cmsblogs.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Java 技术驿站</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">cmsblogs.com</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://maizitoday.github.io/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">麦子的博客</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">maizitoday.github.io</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="http://www.haoservice.cn/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">码农code之路</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">www.haoservice.cn</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://www.jitwxs.cn" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Jitwxs</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">www.jitwxs.cn</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="http://www.gameboys.cn" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Java 烂笔头</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">www.gameboys.cn</span>
                    </span>-->
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>


        
        </div>
    
</div>

                
                 




<div class="column is-4-tablet is-3-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right ">
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-21T06:47:18.000Z">2019-09-21</time></div>
                    <a href="/2019/0921/mysql.html" class="has-link-black-ter is-size-6">给数据库减负的八个思路</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MySQL/">MySQL</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-20T05:07:20.000Z">2019-09-20</time></div>
                    <a href="/2019/0920/springboot-vue-online.html" class="has-link-black-ter is-size-6">喜大普奔，两个开源的 Spring Boot + Vue 前后端分离项目可以在线体验了</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Spring-Boot/">Spring Boot</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-19T02:17:28.000Z">2019-09-19</time></div>
                    <a href="/2019/0919/mongodb-in-java.html" class="has-link-black-ter is-size-6">Java 操作 MongoDB</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MongoDB/">MongoDB</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-18T02:17:28.000Z">2019-09-18</time></div>
                    <a href="/2019/0918/mongodb-shard.html" class="has-link-black-ter is-size-6">初识 MongoDB 分片</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/MongoDB/">MongoDB</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-09-17T05:06:41.000Z">2019-09-17</time></div>
                    <a href="/2019/0917/official-accounts-20000.html" class="has-link-black-ter is-size-6">一个小小的里程碑！啥也不说了，签名书奉上！</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/life/">life</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">九月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">22</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/08/">
                <span class="level-start">
                    <span class="level-item">八月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">15</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">12</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/06/">
                <span class="level-start">
                    <span class="level-item">六月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">43</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/05/">
                <span class="level-start">
                    <span class="level-item">五月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">16</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/04/">
                <span class="level-start">
                    <span class="level-item">四月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">26</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        

<div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            友链
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="http://www.ityouknow.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">纯洁的微笑</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">www.ityouknow.com</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="http://www.justdojava.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Java 极客技术</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">www.justdojava.com</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="http://cxytiandi.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">猿天地</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">cxytiandi.com</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://vimjc.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Vim教程网</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">vimjc.com</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="http://muggle.javaboy.org/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">muggle</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">muggle.javaboy.org</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://crossoverjie.top/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">crossoverJie&#39;s Blog</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">crossoverjie.top</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="http://cmsblogs.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Java 技术驿站</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">cmsblogs.com</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://maizitoday.github.io/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">麦子的博客</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">maizitoday.github.io</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="http://www.haoservice.cn/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">码农code之路</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">www.haoservice.cn</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://www.jitwxs.cn" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Jitwxs</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">www.jitwxs.cn</span>
                    </span>-->
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="http://www.gameboys.cn" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Java 烂笔头</span>
                    </span>
                    <!--<span class="level-right">
                        <span class="level-item tag">www.gameboys.cn</span>
                    </span>-->
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>


    
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="https://www.javaboy.org/images/sb/javaboy.jpg" alt="江南一点雨" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2019 江南一点雨&nbsp;
				<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><!--
PV <span id="busuanzi_value_site_pv"></span>&nbsp;|&nbsp;<i class="fa fa-user-md"></i>  UV <span id="busuanzi_value_site_uv"></span>&nbsp;-->
				<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1276890692'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s96.cnzz.com/z_stat.php%3Fid%3D1276890692%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
				
                <!--Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>-->
                
                </p>
            </div>
            <div class="level-end">
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>